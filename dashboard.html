<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SideQuest Mail Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
      border: 2px solid #FFD700;
    }
    
    .header h1 { 
      font-size: 2.8rem; 
      margin-bottom: 8px; 
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header p { 
      font-size: 1.2rem; 
      font-weight: 500;
      opacity: 0.8;
    }
    
    /* Logo placeholder */
    .logo {
      display: inline-block;
      width: 45px;
      height: 45px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-right: 15px;
      vertical-align: middle;
      position: relative;
      border: 2px solid #1a1a1a;
    }
    
    .logo::before {
      content: "SQ";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #FFD700;
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -1px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border-left: 4px solid;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    
    .stat-card.primary { border-left-color: #FFD700; }
    .stat-card.success { border-left-color: #00ff88; }
    .stat-card.warning { border-left-color: #ff6b35; }
    .stat-card.info { border-left-color: #8b5cf6; }
    
    .stat-value {
      font-size: 2.8rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
    }
    
    .stat-label {
      color: #cccccc;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    /* Main Content */
    .main-content {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid #444;
    }
    
    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid #444;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #444;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #FFD700;
      text-shadow: 0 1px 2px rgba(255, 215, 0, 0.3);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 6px;
      margin-bottom: 25px;
      border: 2px solid #444;
    }
    
    .tab {
      flex: 1;
      padding: 12px 18px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
      transform: translateY(-1px);
    }
    
    .tab:not(.active) {
      color: #cccccc;
    }
    
    .tab:not(.active):hover {
      color: #FFD700;
      background: #333;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
      padding: 25px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #FFD700;
      font-size: 1rem;
    }
    
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #444;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #1a1a1a;
      color: #ffffff;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
      background: #2a2a2a;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 215, 0, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    }
    
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }
    
    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 107, 53, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    }
    
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(107, 114, 128, 0.4);
    }
    
    .btn-sm {
      padding: 10px 20px;
      font-size: 12px;
    }

    .event-actions .btn {
      padding: 12px 20px;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
      text-align: center;
      white-space: nowrap;
    }

    .event-actions .btn:hover {
      transform: translateY(-1px);
    }

    .event-actions .btn-primary {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }

    .event-actions .btn-success {
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
    }

    .event-actions .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .event-actions .btn-warning {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      color: white !important;
    }
    
    /* Subscriber List */
    .subscriber-list {
      max-height: 450px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #FFD700 #2a2a2a;
    }
    
    .subscriber-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .subscriber-list::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 4px;
    }
    
    .subscriber-list::-webkit-scrollbar-thumb {
      background: #FFD700;
      border-radius: 4px;
    }
    
    .subscriber-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #444;
      transition: background 0.2s ease;
    }
    
    .subscriber-item:hover {
      background: rgba(255, 215, 0, 0.05);
      border-radius: 8px;
      padding-left: 10px;
      padding-right: 10px;
    }
    
    .subscriber-item:last-child {
      border-bottom: none;
    }
    
    .subscriber-info {
      flex: 1;
    }
    
    .subscriber-email {
      font-weight: 600;
      color: #ffffff;
      font-size: 1.05rem;
    }
    
    .subscriber-meta {
      font-size: 12px;
      color: #aaaaaa;
      margin-top: 5px;
    }
    
    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 25px;
    }
    
    .search-input {
      width: 100%;
      padding: 14px 18px 14px 50px;
      border: 2px solid #444;
      border-radius: 10px;
      font-size: 14px;
      background: #1a1a1a;
      color: #ffffff;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
    }
    
    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: #FFD700;
      font-size: 18px;
    }
    
    /* Activity Log */
    .activity-item {
      display: flex;
      align-items: flex-start;
      padding: 15px 0;
      border-bottom: 1px solid #444;
      transition: background 0.2s ease;
    }
    
    .activity-item:hover {
      background: rgba(255, 215, 0, 0.05);
      border-radius: 8px;
      padding-left: 10px;
      padding-right: 10px;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .activity-icon.success { 
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
    }
    .activity-icon.danger { 
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
    }
    .activity-icon.info { 
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-text {
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }
    
    .activity-time {
      color: #aaaaaa;
      font-size: 12px;
      margin-top: 3px;
    }
    
    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #444;
      border-top: 3px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Chart container */
    .chart-container {
      height: 280px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #444;
      margin-top: 15px;
    }
    
    /* Source stats */
    .source-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .source-stat {
      text-align: center;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 12px;
      border: 2px solid #444;
      transition: all 0.3s ease;
    }
    
    .source-stat:hover {
      border-color: #FFD700;
      transform: translateY(-2px);
    }
    
    .source-stat-value {
      font-size: 2rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 8px;
    }
    
    .source-stat-label {
      font-size: 0.8rem;
      color: #aaaaaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .event-card {
        padding: 20px;
      }
      
      .event-details {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .event-actions {
        grid-template-columns: 1fr;
      }
      
      .event-actions.four-buttons {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, 1fr);
      }
    }

    .events-container .empty-state h3 {
      color: #FFD700;
      margin-bottom: 15px;
    }

    /* Event filter dropdown improvements */
    #eventTypeFilter {
      min-width: 160px;
      padding: 10px 15px;
      border-radius: 10px;
      background: #2a2a2a;
      border: 2px solid #444;
      color: #ffffff;
      font-weight: 600;
    }

    #eventTypeFilter:focus {
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
    }
    

    /* Empty state styling */
    .events-container .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #aaaaaa;
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      border: 2px dashed #444;
    }


    /* Loading state improvements */
    .events-container .loading-placeholder {
      text-align: center;
      padding: 60px 20px;
      color: #aaaaaa;
    }

    .events-container .spinner {
      margin: 0 auto 20px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .container {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 2.2rem;
      }
      
      .source-stats {
        grid-template-columns: 1fr;
      }
    }
    
    /* Success notification styles */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Utilities */
    .text-center { text-align: center; }
    .mb-0 { margin-bottom: 0; }
    .mt-20 { margin-top: 20px; }
    .text-success { color: #00ff88; }
    .text-danger { color: #ff6b35; }
    .text-muted { color: #aaaaaa; }

    /* Event Management Styles */
    .event-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 10px;
    }

    .event-nav-btn {
      padding: 10px 20px;
      background: #2a2a2a;
      color: #cccccc;
      border: 2px solid #444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .event-nav-btn.active {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      border-color: #FFD700;
    }

    .event-nav-btn:hover:not(.active) {
      background: #3a3a3a;
      color: #FFD700;
    }

    .event-view {
      display: none;
    }

    .event-view.active {
      display: block;
    }
    
    .events-container {
      display: block;
      margin-top: 20px;
      width: 100%;
    }

  
   .event-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 25px;
      border: 2px solid #FFD700;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      display: block;
      width: 100%;
      transition: all 0.3s ease;
      position: static;
      clear: both;
      overflow: visible;
      z-index: 1;
    }

   
    .event-card * {
      position: static !important;
      z-index: auto !important;
    }
   
   .event-card:last-child {
      margin-bottom: 0;
    }
    
    .event-card:hover {
      transform: translateY(-3px); /* Only apply transform on hover */
      box-shadow: 0 12px 30px rgba(255, 215, 0, 0.15);
    }

    /* Event type specific colors */
    .event-card.tournament {
      border-left-color: #FF6B35;
    }

    .event-card.tournament::before {
      background: radial-gradient(circle, rgba(255, 107, 53, 0.05) 0%, transparent 70%);
    }

    .event-card.game_night {
      border-left-color: #4ECDC4;
    }

    .event-card.game_night::before {
      background: radial-gradient(circle, rgba(78, 205, 196, 0.05) 0%, transparent 70%);
    }

    .event-card.special {
      border-left-color: #8B5CF6;
    }

    .event-card.special::before {
      background: radial-gradient(circle, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
    }

    .event-card.birthday {
      border-left-color: #FF69B4;
    }

    .event-card.birthday::before {
      background: radial-gradient(circle, rgba(255, 105, 180, 0.05) 0%, transparent 70%);
    }

   .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    }

    .event-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #FFD700;
      margin: 0;
      line-height: 1.3;
    }

    .event-game-subtitle {
      font-size: 1rem;
      color: #aaaaaa;
      margin-top: 5px;
      font-weight: 500;
    }

    .event-badge {
      padding: 8px 16px; /* More generous padding */
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .badge-tournament { background: #FF6B35; color: white; }
    .badge-game_night { background: #4ECDC4; color: #1a1a1a; }
    .badge-special { background: #FFD700; color: #1a1a1a; }
    .badge-birthday { background: #FF69B4; color: white; }

    .event-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 20px; /* Increased gap */
      margin-bottom: 20px;
      padding: 15px 0;
    }

    .event-detail {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #cccccc;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .event-detail-icon {
      color: #FFD700;
      font-size: 1.2rem;
      width: 20px; /* Fixed width for alignment */
      text-align: center;
    }

    .event-actions {
      display: grid;
      grid-template-columns: 1fr 1fr; /* Two columns */
      gap: 12px;
      margin-top: 20px;
    }

    .event-actions.four-buttons {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    /* Capacity bar improvements */
  .capacity-bar {
        width: 100%;
        height: 28px;
        background: #1a1a1a;
        border-radius: 15px;
        overflow: hidden;
        margin: 15px 0 20px 0;
        position: relative; /* FIXED: Ensure proper positioning */
        border: 2px solid #333;
        z-index: 1; /* FIXED: Ensure it's above background but below other elements */
    }

    .capacity-fill {
        height: 100%;
        background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
        transition: width 0.3s ease;
        border-radius: 12px;
        position: relative; /* FIXED: Proper positioning for the fill */
        z-index: 2;
    }

    .capacity-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        z-index: 3; /* FIXED: Ensure text is above the fill */
        pointer-events: none; /* FIXED: Prevent text from interfering with clicks */
        white-space: nowrap; /* FIXED: Prevent text wrapping */
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      border: 2px solid #FFD700;
    }

    .modal-close {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #FFD700;
      cursor: pointer;
    }

    .modal-close:hover {
      color: #FFA500;
    }

    .attendee-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .attendee-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .attendee-email {
      color: #ffffff;
      font-weight: 500;
    }

    .attendee-status {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-attended { background: #00ff88; color: #1a1a1a; }
    .status-registered { background: #FFD700; color: #1a1a1a; }


    .fc {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      border: 1px solid #444;
      overflow: hidden;
    }

    .fc-header-toolbar {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      padding: 20px 25px !important;
      border-bottom: 3px solid #FFD700;
      margin-bottom: 0 !important;
    }

    .fc-toolbar-title {
      color: #1a1a1a !important;
      font-weight: 800 !important;
      font-size: 1.8rem !important;
    }

    .fc-button {
      background: #1a1a1a !important;
      border: 2px solid #FFD700 !important;
      color: #FFD700 !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      padding: 8px 16px !important;
      transition: all 0.3s ease !important;
    }

    .fc-button:hover {
      background: #FFD700 !important;
      color: #1a1a1a !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3) !important;
    }

    .fc-button-active {
      background: #FFD700 !important;
      color: #1a1a1a !important;
    }

    .fc-view-harness {
      background: #1a1a1a;
    }

    .fc-day {
      background: #2a2a2a !important;
      border-color: #444 !important;
      transition: all 0.3s ease;
    }

    .fc-day:hover {
      background: #3a3a3a !important;
    }

    .fc-day-today {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
      color: #1a1a1a !important;
      font-weight: 800 !important;
    }

    .fc-col-header {
      background: #2a2a2a !important;
      border-bottom: 2px solid #FFD700 !important;
    }

    .fc-col-header-cell-cushion {
      color: #FFD700 !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 1px !important;
      padding: 15px 0 !important;
    }

    .fc-daygrid-day-number {
      color: #ffffff !important;
      font-weight: 700 !important;
      padding: 8px !important;
    }

    .fc-event {
      border: none !important;
      border-radius: 6px !important;
      padding: 3px 6px !important;
      margin: 2px !important;
      font-weight: 600 !important;
      font-size: 0.75rem !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      border-left: 3px solid transparent !important;
    }

    .fc-event:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }

    .fc-event.tournament {
      background: linear-gradient(135deg, #FF6B35 0%, #FF4757 100%) !important;
      color: white !important;
      border-left-color: #FF6B35 !important;
    }

    .fc-event.game_night {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%) !important;
      color: #1a1a1a !important;
      border-left-color: #4ECDC4 !important;
    }

    .fc-event.special {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%) !important;
      color: white !important;
      border-left-color: #8B5CF6 !important;
    }

    .fc-event.birthday {
      background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%) !important;
      color: white !important;
      border-left-color: #FF69B4 !important;
    }

    .fc-more-link {
      color: #FFD700 !important;
      font-weight: 600 !important;
      background: #666 !important;
      border-radius: 4px !important;
      padding: 2px 6px !important;
      margin: 1px !important;
    }

    .fc-more-link:hover {
      background: #FFD700 !important;
      color: #1a1a1a !important;
    }

    /* Hide time display in calendar events */
    .fc-event-time {
      display: none !important;
    }

    /* Make sure only title shows */
    .fc-event-title {
      display: block !important;
      font-weight: 600 !important;
    }


    /* Make events expand on hover to show full content */
    .fc-event:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      z-index: 999 !important;
      overflow: visible !important;
      white-space: normal !important;
    }

        fc-list-view {
      background: #1a1a1a !important;
    }

    .fc-list-day-cushion {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%) !important;
      color: #FFD700 !important;
      font-weight: 700 !important;
      border-bottom: 2px solid #FFD700 !important;
    }

    .fc-list-event {
      background: #2a2a2a !important;
      border-left: 4px solid #FFD700 !important;
    }

    .fc-list-event:hover {
      background: #3a3a3a !important;
    }

    .fc-list-event-time {
      color: #FFD700 !important;
      font-weight: 600 !important;
    }

    .fc-list-event-title {
      color: #ffffff !important;
      font-weight: 600 !important;
    }

    /* List view event type colors */
    .fc-list-event.tournament {
      border-left-color: #FF6B35 !important;
    }

    .fc-list-event.game_night {
      border-left-color: #4ECDC4 !important;
    }

    .fc-list-event.special {
      border-left-color: #8B5CF6 !important;
    }

    .fc-list-event.birthday {
      border-left-color: #FF69B4 !important;
    }

    /* Analytics Dashboard Styles - ADD TO YOUR EXISTING CSS */

    .analytics-kpi-grid {
      margin-bottom: 30px;
    }

    .kpi-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 20px;
      border-left: 4px solid #FFD700;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .kpi-card.subscriber-kpis { border-left-color: #FFD700; }
    .kpi-card.event-kpis { border-left-color: #4ECDC4; }
    .kpi-card.revenue-kpis { border-left-color: #00ff88; }
    .kpi-card.engagement-kpis { border-left-color: #8B5CF6; }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .kpi-header h4 {
      color: #FFD700;
      font-size: 1rem;
      font-weight: 700;
      margin: 0;
    }

    .kpi-trend {
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .kpi-trend.negative {
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
    }

    .kpi-badge {
      background: #444;
      color: #FFD700;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .kpi-main {
      text-align: center;
      margin-bottom: 15px;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 5px;
      text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
    }

    .kpi-label {
      color: #cccccc;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kpi-details {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }

    .kpi-detail {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 8px;
    }

    .kpi-detail-value {
      display: block;
      font-size: 1.3rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 3px;
    }

    .kpi-detail-label {
      font-size: 0.75rem;
      color: #aaaaaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .analytics-chart-container {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid #444;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .chart-header {
      margin-bottom: 15px;
    }

    .chart-header h4 {
      color: #FFD700;
      font-size: 1.1rem;
      font-weight: 700;
      margin: 0 0 5px 0;
    }

    .chart-subtitle {
      color: #aaaaaa;
      font-size: 0.85rem;
    }

    .analytics-section {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid #444;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .section-header {
      margin-bottom: 20px;
    }

    .section-header h4 {
      color: #FFD700;
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0 0 5px 0;
    }

    .section-subtitle {
      color: #aaaaaa;
      font-size: 0.9rem;
    }

    .event-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .event-type-card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 18px;
      border-left: 4px solid;
      transition: all 0.3s ease;
    }

    .event-type-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .event-type-card.tournament { border-left-color: #FF6B35; }
    .event-type-card.game_night { border-left-color: #4ECDC4; }
    .event-type-card.special { border-left-color: #8B5CF6; }
    .event-type-card.birthday { border-left-color: #FF69B4; }

    .event-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .event-type-title {
      color: #ffffff;
      font-weight: 700;
      text-transform: capitalize;
    }

    .event-type-count {
      background: #FFD700;
      color: #1a1a1a;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .event-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .event-type-stat {
      text-align: center;
    }

    .event-type-stat-value {
      display: block;
      font-size: 1.4rem;
      font-weight: 700;
      color: #FFD700;
    }

    .event-type-stat-label {
      font-size: 0.75rem;
      color: #aaaaaa;
      text-transform: uppercase;
    }

    .loading-placeholder {
      text-align: center;
      padding: 40px;
      color: #aaaaaa;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .analytics-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .kpi-details {
        flex-direction: column;
        gap: 10px;
      }
      
      .event-types-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Enhanced Analytics Styles - ADD TO YOUR EXISTING CSS */

    .analytics-status-banner {
      animation: slideIn 0.5s ease;
    }

    .chart-toggle-btn {
      padding: 6px 12px;
      background: #444;
      color: #ccc;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chart-toggle-btn.active {
      background: #FFD700;
      color: #1a1a1a;
      font-weight: 700;
    }

    .chart-toggle-btn:hover:not(.active) {
      background: #555;
      color: #FFD700;
    }

    .kpi-insight {
      padding: 8px 12px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 8px;
      border-left: 3px solid #FFD700;
      margin-top: 12px !important;
      font-size: 0.8rem !important;
      color: #FFD700 !important;
    }

    .insights-grid {
      margin-top: 20px;
    }

    .insight-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .insight-card.growth { border-left-color: #00ff88; }
    .insight-card.warning { border-left-color: #ff6b35; }
    .insight-card.opportunity { border-left-color: #8B5CF6; }
    .insight-card.success { border-left-color: #FFD700; }

    .insight-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .insight-icon {
      font-size: 1.5rem;
    }

    .insight-title {
      color: #FFD700;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .insight-description {
      color: #cccccc;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .insight-action {
      color: #FFD700;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: underline;
      cursor: pointer;
    }

    .insight-action:hover {
      color: #FFA500;
    }

    .performance-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 3px solid #FFD700;
      transition: all 0.3s ease;
    }

    .performance-metric:hover {
      background: #2a2a2a;
      transform: translateX(5px);
    }

    .metric-label {
      color: #cccccc;
      font-weight: 600;
    }

    .metric-value {
      color: #FFD700;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .metric-trend {
      font-size: 0.8rem;
      margin-left: 8px;
    }

    .trend-up { color: #00ff88; }
    .trend-down { color: #ff6b35; }
    .trend-neutral { color: #aaaaaa; }

    /* Improved event type cards */
    .event-type-card {
      position: relative;
      overflow: hidden;
    }

    .event-type-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent 0%, var(--accent-color, #FFD700) 50%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .event-type-card:hover::before {
      opacity: 1;
    }

    .status-cancelled {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: #ffffff;
        text-decoration: line-through;
    }

    .event-type-card.tournament { --accent-color: #FF6B35; }
    .event-type-card.game_night { --accent-color: #4ECDC4; }
    .event-type-card.special { --accent-color: #8B5CF6; }
    .event-type-card.birthday { --accent-color: #FF69B4; }

    /* Responsive improvements */
    @media (max-width: 1024px) {
      .analytics-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .chart-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .analytics-status-banner {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .analytics-kpi-grid {
        grid-template-columns: 1fr;
      }
      
      .kpi-details {
        flex-direction: column;
        gap: 8px;
      }
      
      .insights-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Birthday Party Form Styles */
    .birthday-package-option {
      cursor: pointer;
      display: block;
      margin: 0;
    }

    .birthday-package-option input[type="radio"] {
      display: none;
    }

    .package-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border: 2px solid #444;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .birthday-package-option input[type="radio"]:checked + .package-card {
      border-color: #FF69B4;
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
    }

    .package-card:hover {
      border-color: #FF69B4;
      transform: translateY(-2px);
    }

    .package-card h4 {
      color: #FF69B4;
      margin: 0 0 10px 0;
      font-size: 1.1rem;
    }

    .package-card p {
      margin: 8px 0;
      color: #cccccc;
      font-size: 0.9rem;
    }

    .package-card ul {
      font-size: 0.85rem;
      line-height: 1.4;
    }

    #birthdayPartyForm .form-input:focus,
    #birthdayPartyForm .form-select:focus,
    #birthdayPartyForm .form-textarea:focus {
      border-color: #FF69B4;
      box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
    }

    #birthdayPricingSummary h4 {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #birthdayPricingSummary p {
      margin: 8px 0;
      color: #cccccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #birthdayPricingSummary p:last-child {
      border-top: 1px solid #444;
      padding-top: 10px;
      margin-top: 15px;
      font-weight: 700;
      color: #FF69B4;
      font-size: 1.1rem;
    }

 </style>
</head>
<body>
    <!-- Header -->
    <div class="header" style="position: relative;">
        <h1><span class="logo"></span>SideQuest Canterbury Hub</h1>
        <p>Subscriber Management & Gaming Venue Management Platform</p>
        
        <!-- Logout Button -->
        <div style="position: absolute; top: 20px; right: 20px;">
            <a href="/admin/logout" class="btn btn-secondary btn-sm">🔓 Logout</a>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-grid">
        <!-- Main Content -->
        <div class="main-content">
            <div class="card">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="subscribers">👥 Subscribers</div>
                    <div class="tab" data-tab="analytics">📊 Analytics</div>
                    <div class="tab" data-tab="tools">🛠️ Tools</div>
                    <div class="tab" data-tab="campaigns">📧 Campaigns</div>
                    <div class="tab" data-tab="events">🎮 Events</div>
                </div>

                <!-- Subscribers Tab -->
                <div class="tab-content active" id="subscribers">
                    <div class="card-header">
                        <h3 class="card-title">Subscriber Management</h3>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="refreshSubscribers()">🔄 Refresh</button>
                            <button class="btn btn-success btn-sm" onclick="exportCSV()">📤 Export</button>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search subscribers...">
                        <span class="search-icon">🔍</span>
                    </div>

                    <!-- Add Subscriber -->
                    <div class="form-group">
                        <label class="form-label">Add New Subscriber</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 12px; align-items: end;">
                            <input type="text" class="form-input" id="newSubscriberFirstName" placeholder="First name">
                            <input type="text" class="form-input" id="newSubscriberLastName" placeholder="Last name">
                            <input type="email" class="form-input" id="newSubscriberEmail" placeholder="Email address">
                            <button class="btn btn-primary" onclick="addSubscriber()">Add</button>
                        </div>
                        <div style="margin-top: 8px;">
                            <input type="text" class="form-input" id="newSubscriberHandle" placeholder="Gaming handle (optional)" style="max-width: 200px;">
                        </div>
                    </div>

                    <!-- Subscriber List -->
                    <div class="subscriber-list" id="subscriberList">
                        <div style="text-align: center; padding: 50px; color: #aaaaaa;">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px;">Loading subscribers...</p>
                        </div>
                    </div>
                </div>
         
                <!-- Analytics Tab -->
                <div class="tab-content" id="analytics">
                    <div class="card-header">
                        <h3 class="card-title">📊 Analytics Dashboard</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="analyticsTimeRange" class="form-select" style="width: 150px;">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="refreshAnalytics()">🔄 Refresh</button>
                            <button class="btn btn-secondary btn-sm" onclick="exportAnalyticsReport()">📊 Export Report</button>
                        </div>
                    </div>

                    <!-- Quick Status Banner -->
                    <div class="analytics-status-banner" style="background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%); border-radius: 12px; padding: 15px; margin-bottom: 25px; border-left: 4px solid #FFD700; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #FFD700; font-weight: 700;">🚀 Business Health: </span>
                            <span id="businessHealthScore" style="color: #00ff88; font-weight: 700;">Excellent</span>
                        </div>
                        <div style="display: flex; gap: 20px; font-size: 0.9rem;">
                            <span style="color: #cccccc;">📧 <strong id="quickSubscriberCount">-</strong> subscribers</span>
                            <span style="color: #cccccc;">🎮 <strong id="quickEventCount">-</strong> events</span>
                            <span style="color: #cccccc;">💰 <strong id="quickRevenue">£-</strong> revenue</span>
                            <span style="color: #cccccc;" id="brevoSyncQuickStatus">🔄 Brevo: <strong>Synced</strong></span>
                        </div>
                    </div>

                    <!-- KPI Cards Grid with Tooltips -->
                    <div class="analytics-kpi-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        
                        <!-- Subscriber KPIs -->
                        <div class="kpi-card subscriber-kpis" title="Track subscriber growth and acquisition trends">
                            <div class="kpi-header">
                                <h4>👥 Subscribers</h4>
                                <span class="kpi-trend" id="subscriberTrend">+0%</span>
                            </div>
                            <div class="kpi-main">
                                <div class="kpi-value" id="analyticsSubscribers">-</div>
                                <div class="kpi-label">Total Subscribers</div>
                            </div>
                            <div class="kpi-details">
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="newSubscribers">-</span>
                                    <span class="kpi-detail-label">New this period</span>
                                </div>
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="weeklyGrowth">-</span>
                                    <span class="kpi-detail-label">This week</span>
                                </div>
                            </div>
                            <div class="kpi-insight" id="subscriberInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                                📈 Growing steadily
                            </div>
                        </div>

                        <!-- Event Performance KPIs -->
                        <div class="kpi-card event-kpis" title="Monitor event creation and registration performance">
                            <div class="kpi-header">
                                <h4>🎮 Events</h4>
                                <span class="kpi-badge" id="upcomingEventsBadge">- upcoming</span>
                            </div>
                            <div class="kpi-main">
                                <div class="kpi-value" id="totalEvents">-</div>
                                <div class="kpi-label">Total Events</div>
                            </div>
                            <div class="kpi-details">
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="totalRegistrations">-</span>
                                    <span class="kpi-detail-label">Total Registrations</span>
                                </div>
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="capacityUtil">-%</span>
                                    <span class="kpi-detail-label">Avg Capacity</span>
                                </div>
                            </div>
                            <div class="kpi-insight" id="eventInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                                🎯 Strong demand
                            </div>
                        </div>

                        <!-- Revenue KPIs -->
                        <div class="kpi-card revenue-kpis" title="Track revenue from paid events and pricing performance">
                            <div class="kpi-header">
                                <h4>💰 Revenue</h4>
                                <span class="kpi-badge" id="paidEventsBadge">- paid events</span>
                            </div>
                            <div class="kpi-main">
                                <div class="kpi-value" id="totalRevenue">£-</div>
                                <div class="kpi-label">Total Revenue</div>
                            </div>
                            <div class="kpi-details">
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="avgRevenuePerEvent">£-</span>
                                    <span class="kpi-detail-label">Avg per event</span>
                                </div>
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="revenueGrowth">+-%</span>
                                    <span class="kpi-detail-label">Growth rate</span>
                                </div>
                            </div>
                            <div class="kpi-insight" id="revenueInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                                💡 Consider premium events
                            </div>
                        </div>

                        <!-- Engagement KPIs -->
                        <div class="kpi-card engagement-kpis" title="Monitor how actively subscribers engage with your events">
                            <div class="kpi-header">
                                <h4>📊 Engagement</h4>
                                <span class="kpi-trend" id="attendanceTrend">-%</span>
                            </div>
                            <div class="kpi-main">
                                <div class="kpi-value" id="engagementRate">-%</div>
                                <div class="kpi-label">Event Participation</div>
                            </div>
                            <div class="kpi-details">
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="engagedSubscribers">-</span>
                                    <span class="kpi-detail-label">Active subscribers</span>
                                </div>
                                <div class="kpi-detail">
                                    <span class="kpi-detail-value" id="avgRegistrationsPerEvent">-</span>
                                    <span class="kpi-detail-label">Avg regs/event</span>
                                </div>
                            </div>
                            <div class="kpi-insight" id="engagementInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                                🎯 High engagement
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section with Improved Layout -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px;">
                        
                        <!-- Main Growth Chart -->
                        <div class="analytics-chart-container">
                            <div class="chart-header">
                                <h4>📈 Growth Trends</h4>
                                <div style="display: flex; gap: 10px;">
                                    <button class="chart-toggle-btn active" data-chart="subscribers" onclick="toggleChartView('subscribers')">Subscribers</button>
                                    <button class="chart-toggle-btn" data-chart="registrations" onclick="toggleChartView('registrations')">Registrations</button>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 320px;">
                                <canvas id="mainGrowthChart"></canvas>
                            </div>
                        </div>

                        <!-- Performance Summary -->
                        <div class="analytics-chart-container">
                            <div class="chart-header">
                                <h4>⚡ Quick Stats</h4>
                                <span class="chart-subtitle">This period overview</span>
                            </div>
                            <div id="performanceSummary" style="padding: 20px 0;">
                                <!-- Performance metrics will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Event Types Performance with Detailed Insights -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h4>🎮 Event Type Performance</h4>
                            <div style="display: flex; gap: 10px;">
                                <span class="section-subtitle">Analyze which event types drive the most engagement</span>
                                <button class="btn btn-secondary btn-sm" onclick="optimizeEventMix()">💡 Get Recommendations</button>
                            </div>
                        </div>
                        <div id="eventTypesPerformance" class="event-types-grid">
                            <div class="loading-placeholder">
                                <div class="spinner"></div>
                                <p>Loading performance data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Key Insights Section -->
                    <div class="analytics-section" style="margin-top: 25px;">
                        <div class="section-header">
                            <h4>🧠 AI Insights & Recommendations</h4>
                            <span class="section-subtitle">Data-driven suggestions to improve your business</span>
                        </div>
                        <div id="aiInsights" class="insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <!-- AI insights will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Tools Tab -->
                <div class="tab-content" id="tools">
                    <div class="card-header">
                        <h3 class="card-title">Admin Tools</h3>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bulk Import Subscribers</label>
                        <textarea class="form-textarea" id="bulkEmails" placeholder="Enter emails, one per line:&#10;user1@example.com&#10;user2@example.com&#10;user3@example.com" rows="5"></textarea>
                        <button class="btn btn-primary mt-20" onclick="bulkImport()">📥 Import Subscribers</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Generate QR Code</label>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" class="form-input" id="qrUrl" placeholder="Enter signup URL" value="http://localhost:4000/signup">
                            <button class="btn btn-primary" onclick="generateQR()">Generate QR</button>
                        </div>
                        <div class="qr-display" id="qrDisplay" style="display: none;">
                            <canvas id="qrCanvas"></canvas>
                            <p style="margin-top: 15px; color: #aaaaaa;">Right-click to save QR code</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Data Management</label>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="backupData()">💾 Backup Data</button>
                            <button class="btn btn-primary" onclick="manualBrevoSync()">🔄 Sync Brevo</button>
                            <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
                        </div>
                    </div>
                </div>

                <!-- Campaigns Tab -->
                <div class="tab-content" id="campaigns">
                    <div class="card-header">
                        <h3 class="card-title">Send Campaign</h3>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Campaign Subject</label>
                        <input type="text" class="form-input" id="campaignSubject" placeholder="Enter email subject">
                    </div>

                    <div class="form-group">
                        <label class="form-label">From Name</label>
                        <input type="text" class="form-input" id="fromName" value="SideQuest Mail" placeholder="Sender name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email Content (HTML)</label>
                        <textarea class="form-textarea" id="campaignBody" placeholder="Enter your email content in HTML format..." rows="8"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recipients</label>
                        <p style="color: #aaaaaa; font-size: 14px; margin-bottom: 15px;">
                            Campaign will be sent to all <span id="campaignRecipientCount">0</span> active subscribers
                        </p>
                        <button class="btn btn-primary" onclick="sendCampaign()">📧 Send Campaign</button>
                    </div>
                </div>

                <!-- Events Tab -->
                <div class="tab-content" id="events"> 
                    <div class="event-nav">
                        <button class="event-nav-btn active" data-view="list">📋 Event List</button>
                        <button class="event-nav-btn" data-view="calendar">📅 Calendar View</button>
                        <button class="event-nav-btn" data-view="create">➕ Create Event</button>
                    </div>

                    <!-- Events List View -->
                    <div class="event-view active" id="event-list-view">
                        <div class="card-header">
                            <h3 class="card-title">Upcoming Events</h3>
                            <div>
                                <select id="eventTypeFilter" 
                                        class="form-select" 
                                        style="width: 150px; display: inline-block;" 
                                        onchange="loadEvents()">
                                    <option value="all">All Types</option>
                                    <option value="tournament">Tournaments</option>
                                    <option value="game_night">Game Nights</option>
                                    <option value="special">Special Events</option>
                                    <option value="birthday">Birthdays</option>
                                </select>
                            </div>
                        </div>

                        <div id="eventsList" class="events-container">
                            <div style="text-align: center; padding: 50px; color: #aaaaaa;">
                                <div class="spinner"></div>
                                <p style="margin-top: 15px;">Loading events...</p>
                            </div>
                        </div>
                    </div> 

                    <!-- Calendar View -->
                    <div class="event-view" id="event-calendar-view">
                        <div class="card-header">
                            <h3 class="card-title">Event Calendar</h3>
                            <button class="btn btn-primary btn-sm" onclick="refreshCalendar()">🔄 Refresh</button>
                        </div>
                        
                        <!-- FullCalendar Container -->
                        <div id="fullCalendar" style="padding: 20px;"></div>
                    </div>
                    
                    <!-- Create Event View -->
                    <div class="event-view" id="event-create-view">
                        <div class="card-header">
                            <h3 class="card-title">Create New Event</h3>
                        </div> 

                        <form id="createEventForm">
                            <!-- Event Type Selection (First) -->
                            <div class="form-group">
                                <label class="form-label">Event Type*</label>
                                <select class="form-select" id="eventType" required onchange="toggleEventTypeForm()">
                                    <option value="">Select Type*</option>
                                    <option value="tournament">Tournament</option>
                                    <option value="game_night">Game Night</option>
                                    <option value="special">Special Event</option>
                                    <option value="birthday">Birthday Party</option>
                                </select>
                            </div>

                            <!-- Birthday Party Specific Form -->
                            <div id="birthdayPartyForm" style="display: none;">
                                <div style="background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                                    <h3 style="margin: 0 0 10px 0; font-size: 1.3rem;">🎂 Birthday Party Booking</h3>
                                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Follow our streamlined birthday party workflow</p>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label class="form-label">Birthday Person's Name*</label>
                                        <input type="text" class="form-input" id="birthdayPersonName" placeholder="e.g., Emma">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Contact Phone*</label>
                                        <input type="tel" class="form-input" id="birthdayContactPhone" placeholder="07xxx xxx xxx">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Contact Email*</label>
                                    <input type="email" class="form-input" id="birthdayContactEmail" placeholder="parent@example.com">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label class="form-label">Date & Start Time*</label>
                                        <input type="datetime-local" class="form-input" id="birthdayStartTime" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Duration (hours)*</label>
                                        <select class="form-select" id="birthdayDuration" onchange="updateBirthdayPricing()">
                                            <option value="2">2 hours (Standard)</option>
                                            <option value="3">3 hours (+£56)</option>
                                            <option value="4">4 hours (+£112)</option>
                                            <option value="5">5 hours (+£168)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Package Type*</label>
                                    <div style="display: grid; gap: 15px;">
                                        <label class="birthday-package-option">
                                            <input type="radio" name="birthdayPackage" value="console" onclick="updateBirthdayPricing()" checked>
                                            <div class="package-card">
                                                <h4>🎮 Console Birthday Package</h4>
                                                <p><strong>£148 for first 2 hours</strong> then £56/hour</p>
                                                <p>Includes: 4 PS5s, 2 Racing Sims, 1 Switch, 1 VR, long table</p>
                                                <p><strong>Up to 12 people gaming simultaneously</strong></p>
                                                <ul style="margin: 10px 0 0 20px; color: #00ff88;">
                                                    <li>10% off drinks & food</li>
                                                    <li>50% off extra Knit Gift Bags</li>
                                                    <li>Free Birthday Knit Bag (KitKat + Lollipop)</li>
                                                    <li>Birthday decorations included</li>
                                                </ul>
                                            </div>
                                        </label>
                                        <label class="birthday-package-option">
                                            <input type="radio" name="birthdayPackage" value="standard" onclick="updateBirthdayPricing()">
                                            <div class="package-card">
                                                <h4>🎯 Standard Birthday (Pay-as-you-play)</h4>
                                                <p>Standard gaming rates depending on equipment used</p>
                                                <p>No package - charged per game/hour</p>
                                                <ul style="margin: 10px 0 0 20px; color: #FFD700;">
                                                    <li>Free Birthday Knit Bag (KitKat + Lollipop)</li>
                                                    <li>Birthday decorations included</li>
                                                    <li>Flexible gaming options</li>
                                                </ul>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div id="birthdayPricingSummary" style="background: #1a1a1a; border: 2px solid #FF69B4; border-radius: 12px; padding: 20px; margin: 20px 0;">
                                    <h4 style="color: #FF69B4; margin: 0 0 15px 0;">💰 Pricing Summary</h4>
                                    <div id="pricingDetails">
                                        <p><strong>Console Package (2 hours):</strong> £148</p>
                                        <p><strong>Deposit Required:</strong> £20 (deducted from final bill)</p>
                                        <p><strong>Total Due:</strong> £148</p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Special Requests/Notes</label>
                                    <textarea class="form-textarea" id="birthdayNotes" rows="3" placeholder="Any special requests, dietary requirements, or additional notes..."></textarea>
                                </div>

                                <div style="background: #2a2a2a; border-left: 4px solid #FFD700; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                    <h4 style="color: #FFD700; margin: 0 0 10px 0;">📋 Birthday Party Checklist</h4>
                                    <ul style="color: #ccc; margin: 0 0 0 20px; line-height: 1.6;">
                                        <li>Set up birthday decorations in designated area</li>
                                        <li>Prepare FREE Knit Bag: 1 KitKat + 1 Lollipop</li>
                                        <li>Write "Happy Birthday! This Gift Bag is for you~" on loyalty card</li>
                                        <li>Place bag and card in party area before arrival</li>
                                        <li>Send deposit payment link via SMS/Email (check spam!)</li>
                                        <li>Log all gaming fees on temporary accounts + iPad system</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Standard Event Form (Hidden when Birthday selected) -->
                            <div id="standardEventForm">
                                <div class="form-group">
                                    <label class="form-label">Event Title*</label>
                                    <input type="text" class="form-input" id="eventTitle" placeholder="e.g Valorant Friday Night Tournament">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Game Title</label>
                                    <input type="text" class="form-input" id="gameTitle" placeholder="e.g Valorant, Fortnite">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label class="form-label">Start Date & Time*</label>
                                        <input type="datetime-local" class="form-input" id="eventDateTime" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">End Date & Time*</label>
                                        <input type="datetime-local" class="form-input" id="eventEndTime">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label class="form-label">Capacity</label>
                                        <input type="number" class="form-input" id="eventCapacity" min="0" placeholder="0 (Unlimited)">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Entry Fee (£)</label>
                                        <input type="text" class="form-input" id="eventFee" min="0" step="0.01" placeholder="0.00 (Free)">
                                    </div>  

                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="eventStatus">
                                            <option value="draft">Upcoming</option>
                                            <option value="published">Completed</option>
                                        </select>
                                    </div>    
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-textarea" id="eventDescription" rows="4" placeholder="Event details, rules, what to bring..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Prize Pool (JSON format)</label>
                                    <input type="text" class="form-input" id="eventPrizes" placeholder='{"1st": "£100", "2nd": "£50", "3rd": "£25"}'>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Requirements</label>
                                    <input type="text" class="form-input" id="eventRequirements" placeholder="e.g., Bring your own controller">
                                </div>
                            </div>

                            <div style="display: flex; gap: 12px;">
                                <button type="submit" class="btn btn-primary">🎮 Create Event</button>
                                <button type="button" class="btn btn-secondary" onclick="resetEventForm()">Clear Form</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Event Statistics View -->
                    <div class="event-view" id="event-stats-view">
                        <div class="card-header">
                            <h3 class="card-title">Event Statistics</h3>
                        </div>
                        
                        <div class="stats-grid" style="margin-top: 30px;">
                            <div class="stat-card primary">
                                <div class="stat-value" id="totalEvents">-</div>
                                <div class="stat-label">Total Events</div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-value" id="upcomingEvents">-</div>
                                <div class="stat-label">Upcoming Events</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-value" id="totalEventRegistrations">-</div>
                                <div class="stat-label">Total Registrations</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-value" id="avgCapacityFilled">-%</div>
                                <div class="stat-label">Avg Capacity Filled</div> 
                            </div>
                        </div>
                        
                        <div class="chart-header">
                            <h3 class="card-title">Popular Events</h3>
                        </div>
                        <div id="popularEventsList">
                            <p class="text-muted text-center">Loading Statistics...</p>
                        </div>
                    </div>
                </div>

                <!-- Event Modal -->
                <div id="eventModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeEventModal()">&times;</span>
                        <h2 id="modalEventTitle"></h2>
                        <div id="modalEventContent"></div>
                    </div>
                </div>
            </div>
        </div>  

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <a href="https://app.brevo.com" target="_blank" class="btn btn-primary">
                        🚀 Open Brevo Dashboard
                    </a>
                    <button class="btn btn-success" onclick="window.open('/signup', '_blank')">
                        👁️ Preview Signup Page
                    </button>
                    <button class="btn btn-secondary" onclick="manualBrevoSync()">
                        🔄 Manual Brevo Sync
                    </button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Activity</h3>
                </div>
                <div id="activityLog">
                    <div style="text-align: center; padding: 30px; color: #aaaaaa;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Loading activity...</p>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">System Status</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #ffffff;">Backend Server</span>
                        <span class="text-success" id="serverStatus">⏳ Checking...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #ffffff;">Brevo API</span>
                        <span class="text-success" id="brevoStatus">⏳ Checking...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #ffffff;">Last Activity</span>
                        <span class="text-muted" id="lastActivity">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>


  <script>
    // Configuration
    const API_BASE = 'https://sidequest-newsletter-production.up.railway.app';
    
    class CSRFManager {
        constructor(apiBase = 'https://sidequest-newsletter-production.up.railway.app') {
            this.apiBase = apiBase;
            this.token = null;
            this.tokenExpiry = null;
            this.refreshPromise = null;
        }

        async getToken() {
            // Return existing valid token
            if (this.token && this.isTokenValid()) {
                return this.token;
            }

            // Prevent multiple simultaneous requests
            if (this.refreshPromise) {
                return await this.refreshPromise;
            }

            // Fetch new token
            this.refreshPromise = this.fetchNewToken();
            const token = await this.refreshPromise;
            this.refreshPromise = null;
            
            return token;
        }

        async fetchNewToken() {
            try {
                const response = await fetch(`${this.apiBase}/api/csrf-token`, {
                    method: 'GET',
                    credentials: 'include', // Important for session handling
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success && data.csrf_token) {
                    this.token = data.csrf_token;
                    this.tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000; // 1 min buffer
                    console.log('✅ CSRF token obtained successfully');
                    return this.token;
                } else {
                    throw new Error(data.error || 'Failed to get CSRF token');
                }
            } catch (error) {
                console.error('❌ CSRF token fetch failed:', error);
                throw error;
            }
        }

        isTokenValid() {
            return this.token && this.tokenExpiry && Date.now() < this.tokenExpiry;
        }

        async refreshToken() {
            try {
                const response = await fetch(`${this.apiBase}/api/csrf-refresh`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.token || '' // Include current token if available
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success && data.csrf_token) {
                    this.token = data.csrf_token;
                    this.tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000;
                    console.log('✅ CSRF token refreshed successfully');
                    return this.token;
                } else {
                    throw new Error(data.error || 'Failed to refresh CSRF token');
                }
            } catch (error) {
                console.error('❌ CSRF token refresh failed:', error);
                // Fallback to getting a new token
                return await this.fetchNewToken();
            }
        }

        clearToken() {
            this.token = null;
            this.tokenExpiry = null;
        }
    }

    // Create global instance
    const csrfManager = new CSRFManager();

    // Enhanced fetch wrapper with CSRF protection
    async function secureApiCall(url, options = {}) {
        try {
            // Get CSRF token
            const csrfToken = await csrfManager.getToken();
            
            // Prepare headers
            const headers = {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                ...options.headers
            };

            // Make the request
            const response = await fetch(url, {
                ...options,
                credentials: 'include', // Important for session cookies
                headers
            });

            // Handle CSRF errors
            if (response.status === 403) {
                const errorData = await response.json().catch(() => ({}));
                
                if (errorData.code === 'CSRF_TOKEN_INVALID' || errorData.code === 'CSRF_TOKEN_MISSING') {
                    console.log('🔄 CSRF token expired, refreshing...');
                    
                    // Clear old token and get new one
                    csrfManager.clearToken();
                    const newToken = await csrfManager.getToken();
                    
                    // Retry the request with new token
                    return await fetch(url, {
                        ...options,
                        credentials: 'include',
                        headers: {
                            ...headers,
                            'X-CSRFToken': newToken
                        }
                    });
                }
            }

            return response;
        } catch (error) {
            console.error('❌ Secure API call failed:', error);
            throw error;
        }
    }

    // Convenience functions for common HTTP methods
    async function securePost(url, data = {}) {
        return await secureApiCall(url, {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }

    async function securePut(url, data = {}) {
        return await secureApiCall(url, {
            method: 'PUT',
            body: JSON.stringify(data)
        });
    }

    async function secureDelete(url) {
        return await secureApiCall(url, {
            method: 'DELETE'
        });
    }

    // Export for use in your existing code
    window.csrfManager = csrfManager;
    window.secureApiCall = secureApiCall;
    window.securePost = securePost;
    window.securePut = securePut;
    window.secureDelete = secureDelete;

    let calendar;

    // Initialize FullCalendar
    // Initialize FullCalendar (drop-in)
    function initFullCalendar() {
      const calendarEl = document.getElementById('fullCalendar');
      if (!calendarEl) return;

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listWeek'
        },
        height: 'auto',

        // Your existing source (function or URL)
        events: loadCalendarEvents,

        // ✅ Fix entities + normalize fields on every load/refetch
        eventDataTransform: (raw) => {
          const title = decodeEntities(raw.title || raw.name || 'Untitled Event');
          const start = raw.start || raw.date_time || raw.start_time || raw.startDate || raw.startStr;
          const end   = raw.end   || raw.end_time  || raw.endDate  || raw.endStr   || null;

          // carry over id & type safely
          const id = raw.id || raw.event_id || raw.extendedProps?.id;
          const event_type = raw.event_type || raw.type || raw.extendedProps?.event_type || 'default';

          return {
            id,
            title,
            start,
            end,
            // keep everything else in extendedProps
            extendedProps: { ...(raw.extendedProps || {}), event_type, ...raw }
          };
        },

        // One unified eventDidMount: style + tooltip
        eventDidMount: function(info) {
          const eventType = info.event.extendedProps.event_type || 'default';
          info.el.classList.add(eventType);

          // Native title attribute (fallback)
          const timeText = info.event.start
            ? info.event.start.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })
            : '';
          info.el.setAttribute('title', `${info.event.title}${timeText ? '\n' + timeText : ''}`);

          // Custom tooltip
          info.el.addEventListener('mouseenter', function() {
            const tooltip = document.createElement('div');
            tooltip.id = 'event-tooltip';
            tooltip.style.cssText = `
              position: absolute;
              background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
              color: white;
              padding: 10px 15px;
              border-radius: 8px;
              border: 2px solid #FFD700;
              font-size: 12px;
              font-weight: 600;
              z-index: 9999;
              box-shadow: 0 8px 25px rgba(0,0,0,0.3);
              pointer-events: none;
              max-width: 240px;
              line-height: 1.3;
            `;
            tooltip.textContent = info.event.title + (timeText ? ` — ${timeText}` : '');
            document.body.appendChild(tooltip);

            // position after layout
            requestAnimationFrame(() => {
              const rect = info.el.getBoundingClientRect();
              const top = Math.max(window.scrollY + rect.top - tooltip.offsetHeight - 8, 0);
              const left = Math.max(window.scrollX + rect.left, 0);
              tooltip.style.top = `${top}px`;
              tooltip.style.left = `${left}px`;
            });
          });

          info.el.addEventListener('mouseleave', function() {
            const tooltip = document.getElementById('event-tooltip');
            if (tooltip) tooltip.remove();
          });
        },

        // Click to open your details
        eventClick: function(info) {
          // Ensure we pass the DB id (we mapped it in eventDataTransform)
          const eid = info.event.id || info.event.extendedProps.id;
          showEventDetails(eid);
        },

        dayMaxEvents: 3,
        moreLinkClick: 'popover',

        // Your existing dateClick logic preserved
        dateClick: function(info) {
          const selectedDate = info.dateStr + 'T18:00'; // e.g. 2025-08-22T18:00

          // Switch to events tab first
          document.querySelector('.tab[data-tab="events"]').click();

          // Small delay to ensure tab loads, then switch to create view and set date
          setTimeout(() => {
            switchEventView('create');

            setTimeout(() => {
              const dateInput = document.getElementById('eventDateTime');
              if (dateInput) {
                dateInput.value = selectedDate;
                console.log('Date set to:', selectedDate);
              } else {
                console.error('eventDateTime input not found');
              }
            }, 100);
          }, 100);
        }
      });

      calendar.render();
    }

    // Load events from your backend
    async function loadCalendarEvents(fetchInfo, successCallback, failureCallback) {
      try {
        // Add date range to ensure we get all events in the visible timeframe
        const start = fetchInfo.start.toISOString().split('T')[0];
        const end = fetchInfo.end.toISOString().split('T')[0];
        
        console.log('Loading events from', start, 'to', end); // Debug
        
        const response = await fetch(`${API_BASE}/api/events/calendar?start=${start}&end=${end}`);
        const data = await response.json();
        
        if (data.success) {
          console.log('Total events loaded:', data.events.length); // Debug
          
          const events = data.events.map(event => ({
            id: event.id,
            title: event.title,
            start: event.start || event.date_time,
            end: event.end || event.end_time,
            backgroundColor: event.color,
            borderColor: event.color,
            textColor: getTextColor(event.event_type),
            extendedProps: {
              event_type: event.event_type,
              game_title: event.game_title,
              description: event.description
            }
          }));
          
          successCallback(events);
        } else {
          failureCallback(data.error);
        }
      } catch (error) {
        console.error('Error loading calendar events:', error);
        failureCallback(error);
      }
    }

    // Get text color based on event type
    function getTextColor(eventType) {
      switch(eventType) {
        case 'tournament':
        case 'special':
        case 'birthday':
          return 'white';
        case 'game_night':
        default:
          return '#1a1a1a';
      }
    }

    // Event variables
    let currentEvents = [];
    let currentEditingEventId = null;
    window.isEditingEvent = false;

    // Initialize event management
    function initializeEventManagement() {
      // Setup event navigation
      document.querySelectorAll('.event-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const view = this.dataset.view;
          switchEventView(view);
        });
      });

      // Setup create event form
      const createEventForm = document.getElementById('createEventForm');
      if (createEventForm) {
        createEventForm.addEventListener('submit', handleCreateEvent);
      }

      // Set default datetime to tomorrow at 7pm
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(19, 0, 0, 0);
      const dateInput = document.getElementById('eventDateTime');
      if (dateInput) {
        dateInput.value = tomorrow.toISOString().slice(0, 16);
      }
    }

    function switchEventView(view) {
      // Update navigation buttons
      document.querySelectorAll('.event-nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.event-nav-btn[data-view="${view}"]`).classList.add('active');

      // Update views
      document.querySelectorAll('.event-view').forEach(v => {
        v.classList.remove('active');
      });
      document.getElementById(`event-${view}-view`).classList.add('active');

      // DON'T reset edit state automatically - only reset when explicitly needed
      // REMOVE ALL THE currentEditingEventId = null; lines from here!

      // Load appropriate data
      switch(view) {
        case 'list':
          loadEvents();
          break;
        case 'calendar':
          loadCalendarView();
          break;
        case 'stats':
          loadEventStats();
          break;
      }
    }

    // Load events list
    async function loadEvents() {
      const listContainer = document.getElementById('eventsList');
      
      try {
        const typeFilter = document.getElementById('eventTypeFilter')?.value || 'all';

        // Show spinner while loading
        listContainer.innerHTML = `
          <div style="text-align: center; padding: 50px; color: #aaaaaa;">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Loading events...</p>
          </div>
        `;

        // Fetch events
        const response = await fetch(`${API_BASE}/api/events?type=${typeFilter}&upcoming=true`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (data.success) {
          currentEvents = data.events;
          renderEventsList(data.events);  // your existing render function
        } else {
          console.error('API returned error:', data.error);
          listContainer.innerHTML = `<p class="text-danger">Failed to load events: ${data.error || 'Unknown error'}</p>`;
        }

      } catch (error) {
        console.error('Error loading events:', error);
        listContainer.innerHTML = `<p class="text-danger">Failed to load events: ${error.message}</p>`;
      }
    }

    // Create event card as DOM element (not HTML string)
    function createEventCardElement(event) {
      const card = document.createElement('div');
      card.className = `event-card ${event.event_type || event.type || ''}`;
      card.onclick = () => showEventDetails(event.id);
      
      // Handle multiple possible date field names and formats
      let eventDate;
      const possibleDateFields = [
        event.date_time, 
        event.start_time, 
        event.startDate, 
        event.start
      ];
      
      for (const dateField of possibleDateFields) {
        if (dateField) {
          eventDate = new Date(dateField);
          if (!isNaN(eventDate.getTime())) {
            break; // Valid date found
          }
        }
      }
      
      // Fallback if no valid date found
      if (!eventDate || isNaN(eventDate.getTime())) {
        eventDate = new Date();
        console.warn('Invalid or missing date for event:', event);
      }
      
      const dateStr = eventDate.toLocaleDateString('en-GB', { 
        weekday: 'short', 
        day: 'numeric', 
        month: 'short' 
      });
      const timeStr = eventDate.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      // FIXED: Handle capacity calculation properly with MORE field name variations
      const registrations = event.attendeeCount || 
                            event.registrations || 
                            event.current_attendees || 
                            event.registration_count || 
                            event.attendees_count || 0;
                            
      const capacity = event.maxAttendees || 
                      event.capacity || 
                      event.max_capacity || 
                      event.event_capacity || 0;
                      
      const capacityText = capacity > 0 ? `${registrations}/${capacity}` : `${registrations} registered`;
      const capacityPercent = capacity > 0 ? Math.min((registrations / capacity) * 100, 100) : 0;

      // Handle different event type field names
      const eventType = event.event_type || event.type || 'special';
      const rawTitle = event.title || event.name || 'Untitled Event';
      const safeTitle = escapeHtml(decodeEntities(rawTitle));

      const rawGame = event.game_title || event.game || event.gameTitle || '';
      const safeGame = escapeHtml(decodeEntities(rawGame));
      const entryFee = parseFloat(event.entry_fee || event.fee || event.price || 0);

      // Build birthday contact block (only for birthdays, only if data present)
      let birthdayContactHTML = '';
      if (eventType === 'birthday') {
        const email = (event.contact_email || '').trim();
        const phone = (event.contact_phone || '').trim();
        if (email || phone) {
          birthdayContactHTML = `
            <div class="event-details">
              ${email ? `
                <div class="event-detail">
                  <span class="event-detail-icon">📧</span>
                  <span>${escapeHtml(email)}</span>
                </div>
              ` : ''}
              ${phone ? `
                <div class="event-detail">
                  <span class="event-detail-icon">📞</span>
                  <span>${escapeHtml(phone)}</span>
                </div>
              ` : ''}
            </div>
          `;
        }
      }
      
      // Build the card content
      card.innerHTML = `
        <div class="event-header">
          <div>
            <h3 class="event-title">${safeTitle}</h3>
            ${rawGame ? `<div class="event-game-subtitle">${safeGame}</div>` : ''}
          </div>
          <span class="event-badge badge-${eventType}">${eventType.replace('_', ' ').toUpperCase()}</span>
        </div>
        
        <div class="event-details">
          <div class="event-detail">
            <span class="event-detail-icon">📅</span>
            ${dateStr}
          </div>
          <div class="event-detail">
            <span class="event-detail-icon">🕒</span>
            ${timeStr}
          </div>
          <div class="event-detail">
            <span class="event-detail-icon">👥</span>
            ${capacityText}
          </div>
          ${entryFee > 0 ? `
            <div class="event-detail">
              <span class="event-detail-icon">💰</span>
              £${entryFee.toFixed(2)}
            </div>
          ` : ''}
        </div>

        ${birthdayContactHTML}
        
        ${capacity > 0 ? `
          <div class="capacity-bar">
            <div class="capacity-fill" style="width: ${Math.min(capacityPercent, 100)}%"></div>
            <div class="capacity-text">${Math.round(capacityPercent)}% Full</div>
          </div>
        ` : ''}

        <div class="event-actions">
          <button class="btn btn-primary" onclick="quickRegister(${event.id}); event.stopPropagation();">
            QUICK REGISTER
          </button>
          <button class="btn btn-secondary" onclick="editEvent(${event.id}); event.stopPropagation();">
            EDIT EVENT
          </button>
          <button class="btn btn-success" onclick="viewAttendees(${event.id}); event.stopPropagation();">
            VIEW ATTENDEES
          </button>
          <button class="btn btn-warning" onclick="sendEventMarketing(${event.id}); event.stopPropagation();">
            📊 MARKETING
          </button>
        </div>
      `;
      
      return card;
    }

    function decodeEntities(str){
      if (typeof str !== 'string') return str;
      const el = document.createElement('textarea');
      el.innerHTML = str;
      return el.value;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Marketing function wrapper (called by event card buttons)
    async function sendEventMarketing(eventId) {
      return showMarketing(eventId);
    }

    async function testPublicSignup(eventId) {
      const signupUrl = `${window.location.origin}/signup/event/${eventId}`;
      
      try {
        const response = await fetch(`/api/events/${eventId}/public`);
        const data = await response.json();
        
        if (data.success) {
          console.log('✅ Public signup page should work:', signupUrl);
          window.open(signupUrl, '_blank');
          return true;
        } else {
          console.error('❌ Event not found for public signup');
          return false;
        }
      } catch (error) {
        console.error('❌ Error testing public signup:', error);
        return false;
      }
    }



    // Social proof badge display function
    function showBadge(message, type = 'urgency') {
      const badgeContainer = document.getElementById('social-proof-container') || createBadgeContainer();
      
      const badge = document.createElement('div');
      badge.className = `social-proof-badge ${type}`;
      badge.innerHTML = message;
      
      // Clear existing badges
      badgeContainer.innerHTML = '';
      badgeContainer.appendChild(badge);
      
      // Animate in
      setTimeout(() => badge.classList.add('visible'), 100);
    }

    function decodeEntities(str) {
      if (typeof str !== 'string') return str;
      const el = document.createElement('textarea');
      el.innerHTML = str;
      return el.value;
    }


    function createBadgeContainer() {
      const container = document.createElement('div');
      container.id = 'social-proof-container';
      container.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 280px;
      `;
      document.body.appendChild(container);
      return container;
    }

    async function testEventRegistration(eventId) {
      console.log(`🧪 Testing registration flow for event ${eventId}`);
      
      try {
        // 1. Test public event details
        const eventResponse = await fetch(`/api/events/${eventId}/public`);
        const eventData = await eventResponse.json();
        
        if (!eventData.success) {
          console.error('❌ Event not found');
          return false;
        }
        
        console.log('✅ Event details loaded:', eventData.event.title);
        
        // 2. Test QR code generation
        const qrUrl = await generateEventQR(eventId);
        console.log('✅ QR code generated:', qrUrl);
        
        // 3. Test signup URL
        const signupUrl = `${window.location.origin}/signup/event/${eventId}`;
        console.log('✅ Signup URL:', signupUrl);
        
        return {
          eventTitle: eventData.event.title,
          signupUrl: signupUrl,
          qrUrl: qrUrl,
          success: true
        };
        
      } catch (error) {
        console.error('❌ Registration test failed:', error);
        return { success: false, error: error.message };
      }
    }

    // Debug function to check all events
    async function debugAllEventSignups() {
      try {
        const response = await fetch('/api/events');
        const data = await response.json();
        
        if (data.success) {
          console.log(`Found ${data.events.length} events. Testing signup functionality...`);
          
          for (const event of data.events.slice(0, 3)) { // Test first 3 events
            console.log(`\n=== Testing Event: ${event.title} (ID: ${event.id}) ===`);
            const result = await testEventRegistration(event.id);
            
            if (result.success) {
              console.log('✅ All systems working for this event');
            } else {
              console.log('❌ Issues found:', result.error);
            }
          }
        }
      } catch (error) {
        console.error('Debug failed:', error);
      }
    }

   async function generateEventQR(eventId) {
      const signupUrl = `${window.location.origin}/signup/event/${eventId}`;
      
      try {
        // Try backend QR generation first
        const response = await fetch(`/api/events/${eventId}/qr-code`);
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            return data.qr_code;
          }
        }
        
        // Fallback to external QR service
        const qrServiceUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(signupUrl)}`;
        console.log('Using fallback QR service');
        return qrServiceUrl;
        
      } catch (error) {
        console.error('QR generation error:', error);
        // Final fallback
        return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(signupUrl)}`;
      }
    }

    async function showMarketing(eventId) {
      try {
        // Test the registration flow first
        const testResult = await testEventRegistration(eventId);
        
        if (!testResult.success) {
          alert('❌ Public signup not working for this event: ' + testResult.error);
          return;
        }
        
        // Get event details first
        const event = currentEvents.find(e => e.id === eventId);
        if (!event) {
          alert('Event data not found');
          return;
        }
        
        const signupUrl = testResult.signupUrl;
        const qrCodeUrl = testResult.qrUrl;
        
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = '📊 Marketing Assets - ' + event.title;
        
        modalContent.innerHTML = `
          <!-- Status Check -->
          <div style="background: #1a1a1a; border-radius: 12px; padding: 15px; border-left: 4px solid #00ff88; margin-bottom: 20px;">
            <h4 style="color: #00ff88; margin-bottom: 10px;">✅ Public Signup Status</h4>
            <p style="color: #ccc; font-size: 0.9rem;">Public registration is working for this event!</p>
          </div>
          
          <!-- Event Summary -->
          <div style="background: #1a1a1a; border-radius: 12px; padding: 20px; border-left: 4px solid #FFD700;">
            <h4 style="color: #FFD700; margin-bottom: 15px;">📋 Event Summary</h4>
            <div style="display: grid; gap: 10px; color: #ccc; font-size: 0.9rem;">
              <div><strong>Game:</strong> ${event.game_title || 'Not specified'}</div>
              <div><strong>Date:</strong> ${new Date(event.date_time).toLocaleDateString('en-GB', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
              })}</div>
              <div><strong>Time:</strong> ${new Date(event.date_time).toLocaleTimeString('en-GB', { 
                hour: '2-digit', minute: '2-digit' 
              })}</div>
              <div><strong>Capacity:</strong> ${event.capacity > 0 ? event.capacity + ' players' : 'Unlimited'}</div>
              <div><strong>Fee:</strong> ${event.entry_fee > 0 ? '£' + event.entry_fee : 'FREE'}</div>
            </div>
          </div>
          
          <!-- Signup URL -->
          <div style="background: #1a1a1a; border-radius: 12px; padding: 20px; margin-top: 20px;">
            <h4 style="color: #FFD700; margin-bottom: 15px;">🌐 Public Signup URL</h4>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="text" value="${signupUrl}" readonly 
                    style="flex: 1; padding: 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 0.85rem;">
              <button class="btn btn-primary btn-sm" onclick="copyToClipboard('${signupUrl}')">📋 Copy</button>
              <button class="btn btn-success btn-sm" onclick="window.open('${signupUrl}', '_blank')">👁️ Test</button>
            </div>
          </div>
          
          <!-- QR Code -->
          <div style="background: #1a1a1a; border-radius: 12px; padding: 20px; text-align: center; margin-top: 20px;">
            <h4 style="color: #FFD700; margin-bottom: 15px;">📱 QR Code</h4>
            <img src="${qrCodeUrl}" style="max-width: 200px; border-radius: 8px; background: white; padding: 10px;" 
                alt="QR Code for ${event.title}" onload="console.log('✅ QR Code loaded successfully')" 
                onerror="console.error('❌ QR Code failed to load')">
            <div style="margin-top: 15px;">
              <button class="btn btn-primary btn-sm" onclick="downloadQR('${qrCodeUrl}', '${event.title}')">💾 Download</button>
              <button class="btn btn-secondary btn-sm" onclick="testPublicSignup(${eventId})">🧪 Test Signup</button>
            </div>
            <p style="font-size: 0.8rem; color: #aaa; margin-top: 10px;">Scan to register for this event</p>
          </div>
          
          <div style="margin-top: 25px; text-align: center;">
            <button class="btn btn-primary" onclick="debugAllEventSignups()">🔍 Debug All Events</button>
            <button class="btn btn-secondary" onclick="closeEventModal()">Close</button>
          </div>
        `;
        
        modal.style.display = 'flex';
        
        // Test the QR code after showing modal
        console.log('🧪 Testing marketing assets for event:', event.title);
        
      } catch (error) {
        console.error('Error showing marketing assets:', error);
        alert('Failed to load marketing assets: ' + error.message);
      }
    }
        
    // Render events list
    function renderEventsList(events) {
      const listContainer = document.getElementById('eventsList');
      
      if (!events || events.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <h3>No events found</h3>
            <p>No upcoming events match your current filter criteria.</p>
          </div>
        `;
        return;
      }

      // Clear container completely first
      listContainer.innerHTML = '';
      
      // Create each event as a separate DOM element (not HTML string)
      events.forEach(event => {
        const eventCard = createEventCardElement(event);
        listContainer.appendChild(eventCard);
      });
    }
    function copySocialText(title, dateTime, gameTitle, entryFee, signupUrl) {
      const eventDate = new Date(dateTime);
      const socialText = `🎮 ${title} at SideQuest Canterbury!

    📅 ${eventDate.toLocaleDateString('en-GB', { 
      weekday: 'long', day: 'numeric', month: 'long' 
    })}
    ⏰ ${eventDate.toLocaleTimeString('en-GB', { 
      hour: '2-digit', minute: '2-digit' 
    })}
    ${gameTitle ? '🎯 Game: ' + gameTitle + '\n' : ''}${entryFee > 0 ? '💰 Entry: £' + entryFee + '\n' : '🆓 FREE Entry!\n'}
    Register: ${signupUrl}

    #Gaming #${gameTitle ? gameTitle.replace(/\s+/g, '') : 'Gaming'} #Canterbury #SideQuest`;
      
      copyToClipboard(socialText);
    }

    function createEventAnnouncement(eventId) {
      const event = currentEvents.find(e => e.id === eventId);
      if (!event) {
        alert('Event data not found');
        return;
      }
      
      closeEventModal();
      document.querySelector('.tab[data-tab="campaigns"]').click();
      
      setTimeout(() => {
        const subjectField = document.getElementById('campaignSubject');
        if (subjectField) {
          subjectField.value = `🎮 New Event: ${event.title}`;
        }
        
        const bodyField = document.getElementById('campaignBody');
        if (bodyField) {
          bodyField.value = `Professional HTML email template here...`;
        }
        
        showSuccess('📧 Email template created!');
      }, 500);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccess('📋 Copied to clipboard!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('📋 Copied to clipboard!');
      });
    }

    function downloadQR(dataUrl, eventTitle) {
      try {
        const link = document.createElement('a');
        link.download = `${eventTitle ? eventTitle.replace(/[^a-zA-Z0-9]/g, '_') : 'event'}_qr_code.png`;
        link.href = dataUrl;
        link.click();
        showSuccess('💾 QR code downloaded!');
      } catch (error) {
        window.open(dataUrl, '_blank');
        showSuccess('💾 QR code opened in new window!');
      }
    }




    // Add these helper functions too
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccess('📋 Copied to clipboard!');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('📋 Copied to clipboard!');
      });
    }

    function downloadQR(dataUrl, eventTitle) {
      try {
        const link = document.createElement('a');
        link.download = `${eventTitle ? eventTitle.replace(/[^a-zA-Z0-9]/g, '_') : 'event'}_qr_code.png`;
        link.href = dataUrl;
        link.click();
        showSuccess('💾 QR code downloaded!');
      } catch (error) {
        console.error('Error downloading QR code:', error);
        // Fallback - open in new window
        window.open(dataUrl, '_blank');
        showSuccess('💾 QR code opened in new window!');
      }
    }
   

       // Modified handleCreateEvent to handle birthday parties
    async function handleCreateEvent(e) {
      e.preventDefault();
      
      if (e.target.dataset.submitting === 'true') return;
      e.target.dataset.submitting = 'true';

      const isEditing = currentEditingEventId !== null;
      const eventType = document.getElementById('eventType').value;
      
      try {
        let eventData;
        
        if (eventType === 'birthday') {
          // Handle birthday party specific data
          const birthdayPersonName = document.getElementById('birthdayPersonName').value.trim();
          const contactPhone = document.getElementById('birthdayContactPhone').value.trim();
          const contactEmail = document.getElementById('birthdayContactEmail').value.trim();
          const startTime = document.getElementById('birthdayStartTime').value;
          const duration = parseInt(document.getElementById('birthdayDuration').value);
          const packageType = document.querySelector('input[name="birthdayPackage"]:checked')?.value;
          const notes = document.getElementById('birthdayNotes').value.trim();
          
          // Validation for birthday parties
          if (!birthdayPersonName || !contactPhone || !contactEmail || !startTime) {
            alert('Please fill in all required birthday party fields');
            return;
          }
          
          // Calculate end time
          const startDate = new Date(startTime);
          const endDate = new Date(startDate.getTime() + (duration * 60 * 60 * 1000));
          
          // Generate birthday party title and description
          const title = `${birthdayPersonName}'s Birthday Party`;
          const description = generateBirthdayDescription(packageType, duration, notes);
          
          eventData = {
            title: title,
            event_type: 'birthday',
            game_title: packageType === 'console' ? 'Console Package' : 'Standard Package',
            date_time: startTime,
            end_time: endDate.toISOString().slice(0, 16),
            capacity: packageType === 'console' ? 1 : 0,
            entry_fee: calculateBirthdayPrice(packageType, duration),
            status: 'draft',
            description: description,
            requirements: 'Birthday decorations, gift bag preparation',
            // Birthday-specific fields
            birthday_person_name: birthdayPersonName,
            contact_phone: contactPhone,
            contact_email: contactEmail,
            package_type: packageType,
            duration_hours: duration,
            deposit_required: true,
            deposit_amount: 20,
            special_notes: notes
          };
        } else {
          // Standard event data
          eventData = {
            title: document.getElementById('eventTitle').value,
            event_type: eventType,
            game_title: document.getElementById('gameTitle').value,
            date_time: document.getElementById('eventDateTime').value,
            end_time: document.getElementById('eventEndTime').value,
            capacity: parseInt(document.getElementById('eventCapacity').value) || 0,
            entry_fee: parseFloat(document.getElementById('eventFee').value) || 0,
            status: document.getElementById('eventStatus').value,
            description: document.getElementById('eventDescription').value,
            prize_pool: document.getElementById('eventPrizes').value,
            requirements: document.getElementById('eventRequirements').value
          };
        }

        let response;
        
        if (isEditing) {
          response = await securePut(`${API_BASE}/api/events/${currentEditingEventId}`, eventData);
        } else {
          response = await securePost(`${API_BASE}/api/events`, eventData);
        }

        const data = await response.json();

        if (data.success) {
          const action = isEditing ? 'updated' : 'created';
          
          if (eventType === 'birthday') {
            // Show birthday-specific success message
            const personName = eventData.birthday_person_name;
            const packageType = eventData.package_type;
            const duration = eventData.duration_hours;
            const totalCost = eventData.entry_fee;
            
            const message = `🎂 Birthday Party ${action} successfully!\n\n• Party for: ${personName}\n• Package: ${packageType === 'console' ? 'Console Package' : 'Standard Package'}\n• Duration: ${duration} hours\n• Total Cost: £${totalCost}\n• Event ID: ${data.event_id || 'N/A'}\n\nDon't forget to:\n✓ Set up birthday decorations\n✓ Prepare FREE Knit Bag with KitKat + Lollipop\n✓ Send deposit payment link to contact`;
            
            alert(message);
          } else {
            showSuccess(`Event ${action} successfully!`);
          }
          
          // Reset form and state
          currentEditingEventId = null;
          resetCreateFormUI();
          resetEventForm();
          switchEventView('list');
          
        } else {
          alert('Error: ' + (data.error || `Failed to ${isEditing ? 'update' : 'create'} event`));
        }
      } catch (error) {
        const isEditing = currentEditingEventId !== null;
        console.error(`Error ${isEditing ? 'updating' : 'creating'} event:`, error);
        alert(`Failed to ${isEditing ? 'update' : 'create'} event`);
      } finally {
        e.target.dataset.submitting = 'false';
      }
    }

    function generateBirthdayDescription(packageType, duration, notes) {
      if (packageType === 'console') {
        let description = `Console Birthday Package - ${duration} hours for up to 12 players`;
        if (notes) {
          description += `\n\nSpecial requests: ${notes}`;
        }
        return description;
      } else {
        let description = `Standard Birthday Package - ${duration} hours, pay-as-you-play`;
        if (notes) {
          description += `\n\nSpecial requests: ${notes}`;
        }
        return description;
      }
    }

    function calculateBirthdayPrice(packageType, duration) {
      if (packageType === 'standard') {
        return 0; // Pay as you play
      }
      
      // Console package pricing
      const basePrice = 148; // First 2 hours
      const additionalHours = Math.max(0, duration - 2);
      const additionalCost = additionalHours * 56;
      return basePrice + additionalCost;
    }

    // Quick register subscriber to event
    // Also enhance the quickRegister function to refresh attendees after registration:
    async function quickRegister(eventId) {
      const email = prompt('Enter subscriber email to register:');
      if (!email) return;

      try {
        const response = await securePost(`${API_BASE}/api/events/${eventId}/register`, {
            email: email.trim().toLowerCase()
        });

        const data = await response.json();
        
       if (data.success) {
          // For manual admin registration, always show simple success message
          // Admin can inform about Discord in person
          showSuccess(`✅ Registered ${email} - Confirmation: ${data.confirmation_code}`);
          
          // Show success message with Discord link for tournaments
          if (isTournament) {
            showSuccessWithDiscord(email, data.confirmation_code, event.title);
          } else {
            showSuccess(`✅ Registered ${email} - Confirmation: ${data.confirmation_code}`);
          }
          
          // Update the event card and refresh data
          await updateEventCard(eventId, data.updated_event);
          loadEvents();
          
          // Refresh attendees modal if it's open
          const modal = document.getElementById('eventModal');
          if (modal && modal.style.display === 'flex') {
            setTimeout(() => viewAttendees(eventId), 500);
          }
        } else {
          alert('❌ Error: ' + (data.error || 'Failed to register'));
        }
      } catch (error) {
        console.error('Error registering for event:', error);
        alert('❌ Network error: ' + error.message);
      }
    }

    function showSuccessWithDiscord(email, confirmationCode, eventTitle) {
        // Create enhanced success notification with Discord link
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.5);
            z-index: 1000;
            max-width: 400px;
            font-weight: 600;
            border: 3px solid #FFD700;
            animation: slideIn 0.4s ease;
        `;
        
        notification.innerHTML = `
            <div style="margin-bottom: 15px;">
                <strong>✅ Tournament Registration Successful!</strong>
            </div>
            <div style="margin-bottom: 10px; color: #1a1a1a;">
                <strong>Player:</strong> ${email}<br>
                <strong>Event:</strong> ${eventTitle}<br>
                <strong>Confirmation:</strong> ${confirmationCode}
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(26, 26, 26, 0.1); border-radius: 10px; border: 2px solid #1a1a1a;">
                <div style="font-weight: 700; margin-bottom: 8px; color: #1a1a1a;">
                    🎮 Join Our Discord Community:
                </div>
                <a href="https://discord.gg/ZJp3hhe6Cr" 
                  target="_blank" 
                  style="color: #5865F2; text-decoration: underline; font-weight: 700;">
                    https://discord.gg/ZJp3hhe6Cr
                </a>
                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                    Connect with other tournament players!
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 8 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.4s ease';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 400);
        }, 8000);
    }





    async function updateEventCard(eventId, updatedEventData = null) {
      try {
        // Find the existing event card
        const existingCard = document.querySelector(`.event-card[onclick*="${eventId}"]`);
        if (!existingCard) {
          console.log('Event card not found, will refresh full list');
          return;
        }

        let eventData = updatedEventData;
        
        // If we don't have updated data, fetch it
        if (!eventData) {
          const response = await fetch(`${API_BASE}/api/events/${eventId}`);
          const data = await response.json();
          if (!data.success) {
            console.error('Failed to fetch updated event data');
            return;
          }
          eventData = data.event;
        }

        // Update the current events array
        const eventIndex = currentEvents.findIndex(e => e.id === eventId);
        if (eventIndex !== -1) {
          currentEvents[eventIndex] = eventData;
        }

        // Create new card element
        const newCard = createEventCardElement(eventData);
        
        // Replace the old card with the new one
        existingCard.parentNode.replaceChild(newCard, existingCard);
        
        console.log(`✅ Updated event card for event ${eventId}`);
        
      } catch (error) {
        console.error('Error updating event card:', error);
        // Fallback to full refresh if individual update fails
        loadEvents();
      }
    }

    // View event attendees
    async function viewAttendees(eventId) {
      console.log(`Attempting to view attendees for event ${eventId}`);
      
      try {
        // Show loading in modal immediately
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = 'Loading Attendees...';
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 50px;">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #aaa;">Loading attendee list...</p>
          </div>
        `;
        modal.style.display = 'flex';
        
        // First, let's debug what's happening
        console.log(`Making request to: ${API_BASE}/api/events/${eventId}/attendees`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/attendees`);
        
        console.log(`Response status: ${response.status}`);
        console.log(`Response ok: ${response.ok}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Attendees response data:', data);
        
        if (data.success) {
          const event = currentEvents.find(e => e.id === eventId);
          const eventTitle = event ? event.title : data.event_title || `Event ${eventId}`;
          
          showAttendeesModal({ 
            id: eventId, 
            title: eventTitle 
          }, data.attendees);
          
          console.log(`Successfully loaded ${data.attendees.length} attendees`);
        } else {
          throw new Error(data.error || 'Failed to load attendees');
        }
        
      } catch (error) {
        console.error('Error loading attendees:', error);
        
        // Show error in modal
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = 'Error Loading Attendees';
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ff6b35;">
            <p>❌ Failed to load attendees</p>
            <p style="font-size: 0.9rem; color: #aaa; margin-top: 10px;">
              Error: ${error.message}
            </p>
            <button class="btn btn-primary mt-20" onclick="debugEventRegistrations(${eventId})">
              🔍 Debug Event Data
            </button>
            <button class="btn btn-secondary mt-20" onclick="closeEventModal()">
              Close
            </button>
          </div>
        `;
        modal.style.display = 'flex';
      }
    }
    


    // Load event statistics
    async function loadEventStats() {
      try {
        const response = await fetch(`${API_BASE}/api/events/stats`);
        const data = await response.json();
        
        if (data.success) {
          // Update stat cards
          document.getElementById('totalEvents').textContent = data.stats.total_events;
          document.getElementById('upcomingEvents').textContent = data.stats.upcoming_events;
          document.getElementById('totalEventRegistrations').textContent = data.stats.total_registrations;
          document.getElementById('avgCapacityFilled').textContent = data.stats.avg_capacity_filled + '%';
          
          // Render popular events
          const popularList = document.getElementById('popularEventsList');
          if (data.popular_events && data.popular_events.length > 0) {
            popularList.innerHTML = data.popular_events.map((event, index) => `
              <div style="display: flex; justify-content: space-between; padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 10px;">
                <div>
                  <span style="color: #FFD700; font-weight: 700;">#${index + 1}</span>
                  <span style="margin-left: 10px; color: #fff;">${event.title}</span>
                </div>
                <div>
                  <span class="event-badge badge-${event.event_type}" style="margin-right: 10px;">${event.event_type.replace('_', ' ')}</span>
                  <span style="color: #FFD700; font-weight: 600;">${event.registration_count} registrations</span>
                </div>
              </div>
            `).join('');
          } else {
            popularList.innerHTML = '<p class="text-muted text-center">No events data yet</p>';
          }
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Add debug function to test what's in the database:
    async function debugEventRegistrations(eventId) {
      try {
        console.log(`Debugging event ${eventId}...`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/debug`);
        const data = await response.json();
        
        console.log('Debug data:', data);
        
        alert(`Debug Results for Event ${eventId}:
        
    Event Exists: ${data.event_exists}
    Registration Count: ${data.registration_count}
    All Event Registrations: ${JSON.stringify(data.all_event_registrations, null, 2)}

    Check console for full details.`);
        
      } catch (error) {
        console.error('Debug error:', error);
        alert('Debug failed: ' + error.message);
      }
    }

    // Add refresh function:
    async function refreshAttendees(eventId) {
      await viewAttendees(eventId);
    }

    // Add refresh function:
    async function refreshAttendees(eventId) {
      await viewAttendees(eventId);
    }

    // Search and filter functions for attendees
    function filterAttendees() {
      const searchTerm = document.getElementById('attendeeSearch').value.toLowerCase();
      const attendeeItems = document.querySelectorAll('.attendee-item');
      const noResults = document.getElementById('noResults');
      let visibleCount = 0;
      
      attendeeItems.forEach(item => {
        const email = item.dataset.email || '';
        const name = item.dataset.name || '';
        const code = item.dataset.code || '';
        
        const matches = email.includes(searchTerm) || 
                       name.includes(searchTerm) || 
                       code.includes(searchTerm);
        
        if (matches) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Show/hide "no results" message
      if (visibleCount === 0 && searchTerm.length > 0) {
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
      }
    }
    
    function filterByStatus(status) {
      const attendeeItems = document.querySelectorAll('.attendee-item');
      const searchInput = document.getElementById('attendeeSearch');
      const noResults = document.getElementById('noResults');
      let visibleCount = 0;
      
      // Clear search when using status filter
      searchInput.value = '';
      
      attendeeItems.forEach(item => {
        const itemStatus = item.dataset.status;
        
        if (status === 'all' || itemStatus === status) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Update filter button states
      setActiveFilter(status);
      
      // Show/hide "no results" message
      if (visibleCount === 0) {
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
      }
    }
    
    function setActiveFilter(activeStatus) {
      // Remove active class from all filter buttons
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      });
      
      // Add active class to selected filter
      const activeBtn = document.getElementById(`filter-${activeStatus}`);
      if (activeBtn) {
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
      }
    }
    
    function clearSearch() {
      document.getElementById('attendeeSearch').value = '';
      filterByStatus('all');
    }

    // Check in attendee function
    async function checkinAttendee(eventId, email) {
      try {
        console.log(`🔍 Attempting check-in for Event ${eventId}, Email: ${email}`);
        
        const response = await securePost(`${API_BASE}/api/events/${eventId}/checkin`, {
            email: email
        });

        console.log(`📡 Response status: ${response.status}`);
        
        const data = await response.json();
        console.log('📡 Response data:', data);
        
        if (data.success) {
          showSuccess(`✅ Checked in ${email} - Code: ${data.confirmation_code}`);
          // Refresh the attendees modal
          setTimeout(() => viewAttendees(eventId), 500);
        } else {
          console.error('❌ Check-in failed:', data.error);
          alert('❌ Check-in failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('❌ Network error during check-in:', error);
        alert('❌ Network error: ' + error.message);
      }
    }

    // Show attendees modal
    function showAttendeesModal(event, attendees) {
      console.log('Showing attendees modal for:', event.title, 'with', attendees.length, 'attendees');
      
      const modal = document.getElementById('eventModal');
      const modalTitle = document.getElementById('modalEventTitle');
      const modalContent = document.getElementById('modalEventContent');
      
      modalTitle.textContent = `👥 Attendees: ${event.title}`;
      
      let content = `
        <div style="margin-bottom: 20px;">
          <p><strong>Total Registered:</strong> ${attendees.length}</p>
          <p><strong>Attended:</strong> ${attendees.filter(a => a.attended).length}</p>
        </div>
      `;
      
      if (attendees.length === 0) {
        content += `
          <div style="text-align: center; padding: 40px; color: #aaa;">
            <p>📭 No registrations yet</p>
            <button class="btn btn-primary mt-20" onclick="quickRegister(${event.id})">
              Add First Registration
            </button>
          </div>
        `;
      } else {
        // Add search/filter box
        content += `
          <div style="margin-bottom: 20px;">
            <div style="position: relative;">
              <input type="text" id="attendeeSearch" class="form-input" 
                     placeholder="Search by email, name, or confirmation code..." 
                     style="padding-left: 50px; margin-bottom: 15px;"
                     oninput="filterAttendees()">
              <span style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #FFD700; font-size: 18px;">🔍</span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('all')" id="filter-all">All</button>
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('registered')" id="filter-registered">Not Checked In</button>
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('attended')" id="filter-attended">Checked In</button>
            </div>
          </div>
        `;
        
        content += '<div class="attendee-list" id="attendeeListContainer">';
        
        // In your showAttendeesModal function, update the attendee rendering:
        attendees.forEach((attendee, index) => {
            const statusClass = attendee.status === 'cancelled' ? 'status-cancelled' : 
                              attendee.status === 'attended' ? 'status-attended' : 'status-registered';
            const statusText = attendee.status === 'cancelled' ? 'Cancelled' : 
                              attendee.status === 'attended' ? 'Attended' : 'Registered';
            const registeredDate = attendee.registered_at ? 
                new Date(attendee.registered_at).toLocaleDateString() : 'Unknown';
            
            content += `
                <div class="attendee-item" data-status="${attendee.status}">
                    <div>
                        <div class="attendee-email">${attendee.subscriber_email}</div>
                        <div style="color: #aaa; font-size: 0.8rem; margin-top: 5px;">
                            Player: ${attendee.player_name || 'Not specified'} | 
                            <strong style="color: #FFD700;">Code: ${attendee.confirmation_code}</strong> | 
                            ${attendee.status === 'cancelled' ? 
                                `Cancelled: ${new Date(attendee.cancelled_at).toLocaleDateString()}` :
                                `Registered: ${registeredDate}`
                            }
                            ${attendee.cancellation_reason ? 
                                `<br><em>Reason: ${attendee.cancellation_reason}</em>` : ''
                            }
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="attendee-status ${statusClass}">${statusText}</span>
                        ${attendee.status === 'registered' ? `
                            <button class="btn btn-success btn-sm" onclick="checkinAttendee(${event.id}, '${attendee.subscriber_email}')">
                                ✓ Check In
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        content += '</div>';
        
        // Add "No results" message (hidden by default)
        content += `
          <div id="noResults" style="display: none; text-align: center; padding: 40px; color: #aaa;">
            <p>🔍 No attendees match your search</p>
            <button class="btn btn-secondary btn-sm" onclick="clearSearch()">Clear Search</button>
          </div>
        `;
      }
      
      // Add action buttons
      content += `
        <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #444;">
          <button class="btn btn-primary" onclick="quickRegister(${event.id})">
            ➕ Add Registration
          </button>
          <button class="btn btn-secondary" onclick="refreshAttendees(${event.id})">
            🔄 Refresh
          </button>
          <button class="btn btn-secondary" onclick="closeEventModal()">
            Close
          </button>
        </div>
      `;
      
      modalContent.innerHTML = content;
      modal.style.display = 'flex';
      
      // Set initial filter state
      setActiveFilter('all');
    }


    // Load calendar view
    function loadCalendarView() {
      setTimeout(() => {
        if (!calendar) {
          initFullCalendar();
        } else {
          calendar.refetchEvents();
        }
      }, 100);
    }

    // Form submission
    document.addEventListener('DOMContentLoaded', function() {
      const fcForm = document.getElementById('fcEventForm');
      if (fcForm) {
        fcForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const eventData = {
            title: document.getElementById('fcEventTitle').value,
            event_type: document.getElementById('fcEventType').value,
            game_title: document.getElementById('fcEventGame').value,
            date_time: document.getElementById('fcEventDate').value + 'T' + document.getElementById('fcEventTime').value,
            end_time: document.getElementById('fcEventDate').value + 'T' + document.getElementById('fcEventEndTime').value,
            description: document.getElementById('fcEventDescription').value,
            capacity: 0,
            entry_fee: 0,
            status: 'draft'
          };

          try {
            response = await securePost(`${API_BASE}/api/events`, eventData);

            const data = await response.json();
            
            if (data.success) {
              closeFCModal();
              if (calendar) calendar.refetchEvents();
              showSuccess('Event created successfully!');
            } else {
              alert('Error: ' + (data.error || 'Failed to create event'));
            }
          } catch (error) {
            console.error('Error creating event:', error);
            alert('Failed to create event');
          }
        });
      }

      // Close modal when clicking outside
      const modal = document.getElementById('fcEventModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeFCModal();
          }
        });
      }
    });



    // Modal functions
    function closeFCModal() {
      document.getElementById('fcEventModal').style.display = 'none';
      document.getElementById('fcEventForm').reset();
    }

    function refreshCalendar() {
      if (calendar) {
        calendar.refetchEvents();
        showSuccess('Calendar refreshed!');
      }
    }

    // Simple calendar renderer
    function renderCalendar(events) {
      const calendarEl = document.getElementById('eventCalendar');
      
      // Group events by date
      const eventsByDate = {};
      events.forEach(event => {
        const date = new Date(event.start).toDateString();
        if (!eventsByDate[date]) {
          eventsByDate[date] = [];
        }
        eventsByDate[date].push(event);
      });
      
      // Render simple calendar view
      let html = '<div style="display: grid; gap: 20px;">';
      
      Object.keys(eventsByDate).sort().forEach(date => {
        const dateEvents = eventsByDate[date];
        const dateObj = new Date(date);
        
        html += `
          <div style="background: #2a2a2a; border-radius: 12px; padding: 20px; border-left: 4px solid #FFD700;">
            <h3 style="color: #FFD700; margin-bottom: 15px;">
              ${dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
            </h3>
            <div style="display: grid; gap: 10px;">
        `;
        
        dateEvents.forEach(event => {
          const startTime = new Date(event.start).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const endTime = event.end ? new Date(event.end).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
          
          html += `
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 3px solid ${event.color}; cursor: pointer;"
                onclick="showEventDetails(${event.id})">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <div style="color: #fff; font-weight: 600;">${event.title}</div>
                  <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                    🕐 ${startTime}${endTime ? ' - ' + endTime : ''}
                  </div>
                  ${event.description ? `<div style="color: #ccc; font-size: 0.85rem; margin-top: 5px;">👥 ${event.description}</div>` : ''}
                </div>
                <div style="width: 10px; height: 10px; background: ${event.color}; border-radius: 50%;"></div>
              </div>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      
      if (events.length === 0) {
        html = '<p class="text-muted text-center">No events scheduled</p>';
      }
      
      calendarEl.innerHTML = html;
    }

    // Show event details modal
    async function showEventDetails(eventId) {
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        const data = await response.json();
        
        if (data.success) {
          const event = data.event;
          const modal = document.getElementById('eventModal');
          
          document.getElementById('modalEventTitle').textContent = event.title;
          
          const eventDate = new Date(event.date_time);
          const endDate = event.end_time ? new Date(event.end_time) : null;
          
          let content = `
            <div style="display: grid; gap: 15px;">
              ${event.game_title ? `<p><strong>Game:</strong> ${event.game_title}</p>` : ''}
              <p><strong>Type:</strong> <span class="event-badge badge-${event.event_type}">${event.event_type.replace('_', ' ')}</span></p>
              <p><strong>Date:</strong> ${eventDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p><strong>Time:</strong> ${eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}${endDate ? ' - ' + endDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : ''}</p>
              ${event.entry_fee > 0 ? `<p><strong>Entry Fee:</strong> £${event.entry_fee}</p>` : ''}
              ${event.capacity > 0 ? `<p><strong>Capacity:</strong> ${event.registration_count}/${event.capacity} registered</p>` : `<p><strong>Registrations:</strong> ${event.registration_count}</p>`}
              ${event.description ? `<p><strong>Description:</strong><br>${event.description}</p>` : ''}
              ${event.prize_pool ? `<p><strong>Prizes:</strong><br>${event.prize_pool}</p>` : ''}
              ${event.requirements ? `<p><strong>Requirements:</strong><br>${event.requirements}</p>` : ''}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" onclick="viewAttendees(${event.id})">View Attendees</button>
              <button class="btn btn-secondary" onclick="editEvent(${event.id})">Edit Event</button>
              <button class="btn btn-danger" onclick="deleteEvent(${event.id})">Delete Event</button>
            </div>
          `;
          
          document.getElementById('modalEventContent').innerHTML = content;
          modal.style.display = 'flex';
        }
      } catch (error) {
        console.error('Error loading event details:', error);
        alert('Failed to load event details');
      }
    }

    // Modified editEvent function
    async function editEvent(eventId) {
      window.isEditingEvent = true;
      console.log('EDIT DEBUG: Setting currentEditingEventId to:', eventId);

      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        const data = await response.json();

        if (!data.success) {
          alert('Failed to load event data');
          return;
        }

        const event = data.event;
        currentEditingEventId = eventId;
        console.log('EDIT DEBUG: currentEditingEventId is now:', currentEditingEventId);

        // 1) Show create view (your switchEventView does not reset form state)
        switchEventView('create');

        // 2) Set event type select FIRST so the correct form section is visible
        const typeSel = document.getElementById('eventType');
        if (typeSel) typeSel.value = event.event_type || event.type || 'special';

        // 3) Show the correct section, defaults suppressed by isEditingEvent
        toggleEventTypeForm();

        // 4) Now populate values
        fillFormWithEventData(event);

        // 5) Mark UI as editing
        updateCreateFormForEdit(event.title);

        // Only close a modal if that’s what you want (some setups keep it open)
        closeEventModal();

      } catch (error) {
        console.error('Error loading event for edit:', error);
        alert('Failed to load event data');
        currentEditingEventId = null;
        window.isEditingEvent = false;
      }
    }

    // Utils (scope-aware)
    function setScoped(formEl, selector, value) {
      if (!formEl || value === undefined || value === null) return;
      // Try by id, then by name
      let el = formEl.querySelector(selector.startsWith('#') ? selector : `#${selector}`);
      if (!el) el = formEl.querySelector(`[name="${selector}"]`);
      if (el) el.value = value;
    }
    function toLocalInputValue(dtLike) {
      const d = new Date(dtLike);
      if (isNaN(d.getTime())) return '';
      const pad = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function updateCreateFormForEdit(eventTitle) {
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = `Edit Event: ${eventTitle}`;
        formTitle.style.color = '#FFD700';
      } else {
        console.warn('Form title element not found');
      }

        // Update submit button with error handling
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Update Event';
        submitButton.classList.add('btn-warning'); // Different style for update
        submitButton.classList.remove('btn-primary');
      } else {
        console.warn('Submit button not found');
      }
      
      // Add cancel button if it doesn't exist
      let cancelButton = document.getElementById('cancelEditButton');
      if (!cancelButton && submitButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'cancelEditButton';
        cancelButton.type = 'button';
        cancelButton.className = 'btn btn-secondary ms-2';
        cancelButton.innerHTML = '❌ Cancel Edit';
        cancelButton.onclick = cancelEdit;
        
        // Insert after submit button
        submitButton.parentNode.insertBefore(cancelButton, submitButton.nextSibling);
      }
    }
      
    // Replace your deleteEvent function with this debug version
    async function deleteEvent(eventId) {
        console.log('deleteEvent called with eventId:', eventId);
        
        // Clean the eventId to ensure it's just a number
        const cleanEventId = parseInt(eventId.toString().split(':')[0]);
        console.log('Cleaned eventId:', cleanEventId);
        
        if (isNaN(cleanEventId)) {
            console.error('Invalid event ID:', eventId);
            alert('Invalid event ID. Please try again.');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this event?')) return;
        
        try {
            const deleteUrl = `${API_BASE}/api/events/${cleanEventId}`;
            console.log('Delete URL:', deleteUrl);
            
            // Show loading state
            const deleteButtons = document.querySelectorAll(`[onclick*="deleteEvent(${eventId})"]`);
            deleteButtons.forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '🗑️ Deleting...';
            });
            
            // First attempt - normal delete
            const response = await secureDelete(deleteUrl);
            const data = await response.json();
            
            console.log('Delete response status:', response.status);
            console.log('Delete response data:', data);
            
            // Check if deletion was successful
            if (response.ok && data.success) {
                showSuccess('Event deleted successfully');
                closeEventModal();
                loadEvents();
                return;
            }
            
            // Handle the case where event has registrations (HTTP 400 with has_registrations: true)
            if (response.status === 400 && data.has_registrations) {
                console.log('Event has registrations, asking for confirmation');
                
                if (confirm('This event has registrations. Delete anyway? This will also delete all registrations.')) {
                    console.log('User confirmed force delete');
                    
                    // Force delete with registrations
                    const forceUrl = `${API_BASE}/api/events/${cleanEventId}?force=true`;
                    console.log('Force delete URL:', forceUrl);
                    
                    const forceResponse = await secureDelete(forceUrl);
                    const forceData = await forceResponse.json();
                    
                    console.log('Force delete response status:', forceResponse.status);
                    console.log('Force delete response data:', forceData);
                    
                    if (forceResponse.ok && forceData.success) {
                        showSuccess('Event and all registrations deleted successfully');
                        closeEventModal();
                        loadEvents();
                    } else {
                        throw new Error(forceData.error || `Force delete failed: HTTP ${forceResponse.status}`);
                    }
                } else {
                    console.log('User cancelled force delete');
                    restoreDeleteButtons(eventId);
                    return;
                }
            } else {
                // Some other error occurred
                throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
            }
            
        } catch (error) {
            console.error('Error deleting event:', error);
            
            if (error.message.includes('403')) {
                alert('Session expired. Please refresh the page and try again.');
            } else if (error.message.includes('404')) {
                alert('Event not found. It may have already been deleted.');
                closeEventModal();
                loadEvents();
            } else {
                alert('Failed to delete event: ' + error.message);
            }
        } finally {
            restoreDeleteButtons(eventId);
        }
    }

    function restoreDeleteButtons(eventId) {
        const deleteButtons = document.querySelectorAll(`[onclick*="deleteEvent(${eventId})"]`);
        deleteButtons.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = 'Delete Event';
        });
    }

    // Send event announcement email
    async function sendEventAnnouncement(eventId) {
      try {
        const eventResponse = await fetch(`${API_BASE}/api/events/${eventId}`);
        const eventData = await eventResponse.json();
        
        if (!eventData.success) return;
        
        const event = eventData.event;
        const eventDate = new Date(event.date_time);
        
        const subject = `New Event: ${event.title}`;
        const body = `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #FFD700;">🎮 New Event at SideQuest!</h1>
            <h2>${event.title}</h2>
            <p><strong>Date:</strong> ${eventDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
            <p><strong>Time:</strong> ${eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</p>
            ${event.game_title ? `<p><strong>Game:</strong> ${event.game_title}</p>` : ''}
            ${event.entry_fee > 0 ? `<p><strong>Entry Fee:</strong> £${event.entry_fee}</p>` : '<p><strong>Entry:</strong> FREE!</p>'}
            ${event.description ? `<p>${event.description}</p>` : ''}
            ${event.prize_pool ? `<p><strong>Prizes:</strong> ${event.prize_pool}</p>` : ''}
            <p style="margin-top: 30px;">
              <a href="${window.location.origin}/signup" style="background: #FFD700; color: #1a1a1a; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold;">
                Register Now
              </a>
            </p>
            <p style="color: #888; font-size: 12px; margin-top: 30px;">
              You're receiving this because you're subscribed to SideQuest Gaming Cafe updates.
            </p>
          </div>
        `;
        
        const response = await fetch(`${API_BASE}/send-campaign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            body,
            fromName: 'SideQuest Events',
            recipients: subscribers // Assuming subscribers array is available
          })
        });
        
        const data = await response.json();
        if (data.success) {
          showSuccess(`Event announcement sent to ${data.sent} subscribers!`);
        }
      } catch (error) {
        console.error('Error sending announcement:', error);
        alert('Failed to send announcement');
      }
    }

    // Close event modal
    function closeEventModal() {
      document.getElementById('eventModal').style.display = 'none';
    }

    // Reset event form
   function resetEventForm() {
      const form = document.getElementById('createEventForm');
      if (form) {
        form.reset();
      }
      
      // FIXED: Always reset edit state when clearing form
      currentEditingEventId = null;
      resetCreateFormUI(); // Reset UI elements too
      
      // Set default datetime to tomorrow at 7pm
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(19, 0, 0, 0);
      const dateInput = document.getElementById('eventDateTime');
      if (dateInput) {
        dateInput.value = tomorrow.toISOString().slice(0, 16);
      }
      
      console.log('🔧 Form data reset complete');
    }

    // Call initialization when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Wait a bit to ensure main dashboard is initialized first
      setTimeout(() => {
        initializeEventManagement();
      }, 500);
    });

    const __decoderEl = document.createElement('textarea');
    function decodeEntities(str) {
      if (typeof str !== 'string') return str;
      __decoderEl.innerHTML = str;
      return __decoderEl.value;
    }


    function fillFormWithEventData(event) {
      const type = (event.event_type || event.type || 'special').toLowerCase();
      const birthdayForm = document.getElementById('birthdayPartyForm');
      const standardForm = document.getElementById('standardEventForm');
      const form = type === 'birthday' ? birthdayForm : standardForm;

      const dt = event.date_time || event.start_time || event.startDate || event.start;

      // ---------- Common (decode text fields) ----------
      setScoped(form, 'eventTitle', decodeEntities(event.title || event.name || ''));
      setScoped(form, 'gameTitle',  decodeEntities(event.game_title || event.game || '')); // if this input exists
      setScoped(form, 'entryFee', (event.entry_fee ?? event.fee ?? event.price ?? '').toString());
      setScoped(form, 'eventStatus', event.status || event.state || 'upcoming');
      setScoped(form, 'description', decodeEntities(event.description || event.special_notes || ''));

      if (type === 'birthday') {
        // ---------- Birthday-specific (decode text where relevant) ----------
        setScoped(form, 'birthdayPersonName',  decodeEntities(event.birthday_person_name || event.child_name || ''));
        setScoped(form, 'birthdayContactPhone', event.contact_phone || event.parent_phone || ''); // phone: raw is fine
        setScoped(form, 'birthdayContactEmail', decodeEntities(event.contact_email || event.parent_email || ''));
        if (dt) setScoped(form, 'birthdayStartTime', toLocalInputValue(dt));

        setScoped(form, 'birthdayPackageType', event.package_type || 'console');
        if (event.duration_hours != null) setScoped(form, 'birthdayDurationHours', String(event.duration_hours));

        // Deposit fields (if you have these inputs)
        if (event.deposit_amount != null) setScoped(form, 'birthdayDeposit', String(event.deposit_amount));

        // Reflect the rule: capacity = 1 for birthdays (if you show a capacity input)
        setScoped(form, 'capacity', '1');

        // Recalculate pricing after values are set (your guard prevents defaulting while editing)
        if (typeof updateBirthdayPricing === 'function') updateBirthdayPricing();
      } else {
        if (dt) setScoped(form, 'eventDateTime', toLocalInputValue(dt));
      }
    }

    function updateCreateFormForEdit(eventTitle) {
      // Update form title
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = `Edit Event: ${eventTitle}`;
        formTitle.style.color = '#ff6b35'; // Orange color to indicate edit mode
      }
      
      // Update submit button
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Update Event';
        submitButton.classList.add('btn-warning'); // Different style for update
        submitButton.classList.remove('btn-primary');
      }
      
      // Add cancel button if it doesn't exist
      addCancelButton(submitButton);
    }

    function addCancelButton(submitButton) {
      let cancelButton = document.getElementById('cancelEditButton');
      if (!cancelButton && submitButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'cancelEditButton';
        cancelButton.type = 'button';
        cancelButton.className = 'btn btn-secondary ms-2';
        cancelButton.innerHTML = '❌ Cancel Edit';
        cancelButton.onclick = cancelEdit;
        submitButton.parentNode.insertBefore(cancelButton, submitButton.nextSibling);
      }
    }

    // 2. Replace the resetCreateFormUI function
    function resetCreateFormUI() {
      // Reset form title
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = 'Create New Event';
        formTitle.style.color = '#FFD700'; // Reset to default gold color
      }
      
      // Reset submit button
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Create Event';
        submitButton.classList.remove('btn-warning');
        submitButton.classList.add('btn-primary');
      }
      
      // Remove cancel button
      const cancelButton = document.getElementById('cancelEditButton');
      if (cancelButton) {
        cancelButton.remove();
      }
      
      console.log('🔧 UI reset complete');
    }
      

    function cancelEdit() {
      currentEditingEventId = null;
      resetCreateFormUI();
      resetEventForm();
      switchEventView('list');
    }

    // Enhance existing tab functionality to load events
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          if (this.dataset.tab === 'events') {
            // Small delay to ensure tab is active
            setTimeout(() => {
              loadEvents();
            }, 100);
          }
        });
      });
    });

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🔒 Initializing CSRF protection...');
        
        try {
            // Pre-fetch CSRF token
            await csrfManager.getToken();
            console.log('✅ CSRF protection ready');
            
            // Set up token refresh every 30 minutes
            setInterval(async () => {
                try {
                    await csrfManager.refreshToken();
                    console.log('🔄 CSRF token refreshed automatically');
                } catch (error) {
                    console.error('❌ Failed to refresh CSRF token:', error);
                }
            }, 30 * 60 * 1000); // 30 minutes
            
            // Your existing dashboard initialization code
            initializeTabs();
            loadInitialData();
            setupSearch();
            startAutoRefresh();
            
        } catch (error) {
            console.error('❌ Failed to initialize CSRF protection:', error);
            alert('Security initialization failed. Please refresh the page.');
        }
    });

    
    // Global variables
    let subscribers = [];
    let subscriberDetails = [];
    let activityLog = [];
    let currentStats = {};
    let growthChart = null;
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initializing...');
      try {
        initializeTabs();
        loadInitialData();
        setupSearch();
        startAutoRefresh();
      } catch (error) {
        console.error('Dashboard initialization error:', error);
      }
    });

    // Load all initial data
    async function loadInitialData() {
      try {
        await Promise.all([
          loadSubscribers(),
          loadStats(),
          loadActivity(),
          checkHealth()
        ]);
      } catch (error) {
        console.error('Error loading initial data:', error);
      }
    }

    // Load subscribers from backend
   async function loadSubscribers() {
        try {
            showLoading('subscriberList');
            
            // Make sure your backend returns the new fields
            const response = await fetch(`${API_BASE}/subscribers`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                subscribers = data.subscribers || [];
                subscriberDetails = data.subscriber_details || []; // This should now include name fields
                currentStats = data.stats || {};
                
                renderSubscribers();
                updateStats();
                updateCampaignRecipientCount();
            }
        } catch (error) {
            console.error('Error loading subscribers:', error);
            showError('subscriberList', `Connection error: ${error.message}`);
        }
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/stats`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          currentStats = data.stats;
          updateStats();
          document.getElementById('brevoSyncStatus').textContent = data.brevo_sync_status || '❌';
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load activity log
    async function loadActivity() {
      try {
        const response = await fetch(`${API_BASE}/activity`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          activityLog = data.activity || [];
          renderActivityLog();
        }
      } catch (error) {
        console.error('Error loading activity:', error);
        showError('activityLog', 'Failed to load activity');
      }
    }

    // Check backend health
    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE}/admin/health`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        updateServerStatus(true);
        const brevoStatusElement = document.getElementById('brevoStatus');
        if (brevoStatusElement) {
          brevoStatusElement.innerHTML = 
            data.brevo_status === 'connected' ? '🟢 Connected' : `🔴 ${data.brevo_status}`;
          
          // Show more detailed Brevo status if available
          if (data.brevo_email) {
            brevoStatusElement.title = `Connected as: ${data.brevo_email}`;
          }
        }
      } catch (error) {
        console.error('Health check failed:', error);
        updateServerStatus(false);
        const brevoStatusElement = document.getElementById('brevoStatus');
        if (brevoStatusElement) {
          brevoStatusElement.innerHTML = '🔴 Offline';
        }
      }
    }

    // Update server status display
    function updateServerStatus(isOnline) {
      const serverStatusElement = document.getElementById('serverStatus');
      if (serverStatusElement) {
        serverStatusElement.innerHTML = isOnline ? '🟢 Online' : '🔴 Offline';
      }
    }

    // Initialize growth chart
    function initializeGrowthChart() {
      try {
        // Destroy existing chart if it exists
        if (growthChart) {
          growthChart.destroy();
        }
        
        const ctx = document.getElementById('growthChart');
        if (!ctx) {
          console.error('Growth chart canvas not found');
          return;
        }
        
        const chartContext = ctx.getContext('2d');
        
        // Generate sample data for the last 30 days
        const last30Days = [];
        const subscriberCounts = [];
        const today = new Date();
        
        for (let i = 29; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          
          // Calculate cumulative subscriber count for this date
          const dateStr = date.toISOString().split('T')[0];
          const subscribersUpToDate = subscriberDetails.filter(sub => {
            const subDate = new Date(sub.date_added).toISOString().split('T')[0];
            return subDate <= dateStr;
          }).length;
          
          subscriberCounts.push(subscribersUpToDate);
        }
        
        // Create new chart and store reference
        growthChart = new Chart(chartContext, {
          type: 'line',
          data: {
            labels: last30Days,
            datasets: [{
              label: 'Total Subscribers',
              data: subscriberCounts,
              borderColor: '#FFD700',
              backgroundColor: 'rgba(255, 215, 0, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#FFD700',
              pointBorderColor: '#1a1a1a',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#FFD700',
                  font: {
                    weight: 'bold'
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: '#444'
                },
                ticks: {
                  color: '#cccccc'
                }
              },
              x: {
                grid: {
                  color: '#444'
                },
                ticks: {
                  color: '#cccccc',
                  maxRotation: 45
                }
              }
            },
            elements: {
              point: {
                hoverBackgroundColor: '#FFD700'
              }
            }
          }
        });
      } catch (error) {
        console.error('Error initializing growth chart:', error);
      }
    }

    // Render subscribers in the list
    function renderSubscribers(subscribersToRender = subscribers) {
      try {
        const subscriberList = document.getElementById('subscriberList');
        if (!subscriberList) {
          console.error('Subscriber list element not found');
          return;
        }
        
        if (subscribersToRender.length === 0) {
          subscriberList.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #aaaaaa;">
              📭 No subscribers found
            </div>
          `;
          return;
        }

        subscriberList.innerHTML = subscribersToRender.map(email => {
            const details = subscriberDetails.find(d => d.email === email);
            const dateAdded = details ? new Date(details.date_added).toLocaleDateString() : 'Unknown';
            const source = details ? details.source : 'unknown';
            const fullName = details?.full_name || details?.first_name || 'No name';
            const gamingHandle = details?.gaming_handle;
            
            return `
                <div class="subscriber-item">
                    <div class="subscriber-info">
                        <div class="subscriber-email">
                            <strong>${fullName}</strong> - ${email}
                            ${gamingHandle ? `<span style="color: #FFD700; font-size: 0.8rem; margin-left: 8px;">🎮 ${gamingHandle}</span>` : ''}
                        </div>
                        <div class="subscriber-meta">Added: ${dateAdded} • Source: ${source}</div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeSubscriber('${email}')">
                        🗑️ Remove
                    </button>
                </div>
            `;
        }).join('');
      } catch (error) {
        console.error('Error rendering subscribers:', error);
      }
    }

    // Add new subscriber
    async function addSubscriber() {
        try {
            const emailInput = document.getElementById('newSubscriberEmail');
            const firstNameInput = document.getElementById('newSubscriberFirstName');
            const lastNameInput = document.getElementById('newSubscriberLastName');
            const handleInput = document.getElementById('newSubscriberHandle');
            
            if (!emailInput || !firstNameInput || !lastNameInput) {
                console.error('Required input fields not found');
                return;
            }
            
            const email = emailInput.value.trim();
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const gamingHandle = handleInput.value.trim();

            if (!email || !firstName || !lastName) {
                alert('Please enter email, first name, and last name');
                return;
            }

            if (!isValidEmail(email)) {
                alert('Please enter a valid email address');
                return;
            }

            // USE SECURE API CALL with CSRF
            const response = await securePost(`${API_BASE}/subscribe`, {
                email, 
                firstName,
                lastName,
                gamingHandle: gamingHandle || null,
                source: 'admin_manual' 
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                emailInput.value = '';
                firstNameInput.value = '';
                lastNameInput.value = '';
                handleInput.value = '';
                await loadSubscribers();
                await loadActivity();
                showSuccess(`Added ${firstName} ${lastName} (${email}) successfully!`);
            } else {
                alert(data.error || 'Failed to add subscriber');
            }
        } catch (error) {
            console.error('Error adding subscriber:', error);
            
            // Handle CSRF errors gracefully
            if (error.message.includes('403') || error.message.includes('CSRF')) {
                alert('Session expired. Please refresh the page and try again.');
            } else {
                alert('Network error. Please try again.');
            }
        }
    }


    // Remove subscriber
   async function removeSubscriber(email) {
        try {
            if (!confirm(`Remove ${email} from subscribers?`)) return;

            // USE SECURE API CALL
            const response = await securePost(`${API_BASE}/unsubscribe`, {
                email
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                await loadSubscribers();
                await loadActivity();
                showSuccess('Subscriber removed successfully!');
            } else {
                alert(data.error || 'Failed to remove subscriber');
            }
        } catch (error) {
            console.error('Error removing subscriber:', error);
            handleApiError(error);
        }
    }

      // Bulk import subscribers
      async function bulkImport() {
        try {
            const textarea = document.getElementById('bulkEmails');
            if (!textarea) {
                console.error('Bulk emails textarea not found');
                return;
            }
            
            const emailText = textarea.value.trim();
            
            if (!emailText) {
                alert('Please enter some email addresses');
                return;
            }
            
            const emails = emailText.split('\n')
                .map(email => email.trim())
                .filter(email => email && isValidEmail(email));
            
            if (emails.length === 0) {
                alert('No valid email addresses found');
                return;
            }
            
            if (!confirm(`Import ${emails.length} email addresses?`)) return;
            
            // USE SECURE API CALL
            const response = await securePost(`${API_BASE}/bulk-import`, {
                emails, 
                source: 'import'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                textarea.value = '';
                await loadSubscribers();
                await loadActivity();
                
                let message = `Successfully imported ${data.added} subscribers.`;
                if (data.errors && data.errors.length > 0) {
                    message += `\n\n${data.errors.length} errors occurred:\n${data.errors.slice(0, 5).join('\n')}`;
                    if (data.errors.length > 5) {
                        message += `\n... and ${data.errors.length - 5} more errors.`;
                    }
                }
                alert(message);
            } else {
                alert(data.error || 'Failed to import subscribers');
            }
        } catch (error) {
            console.error('Error importing subscribers:', error);
            handleApiError(error);
        }
    }


    // Manual Brevo sync
    async function manualBrevoSync() {
        try {
            if (!confirm('Manually sync all subscribers to Brevo?')) return;
            
            const button = event.target;
            if (button) {
                button.disabled = true;
                button.innerHTML = '🔄 Syncing...';
            }
            
            // USE SECURE API CALL
            const response = await securePost(`${API_BASE}/sync-brevo`);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                await loadActivity();
                let message = `Sync completed: ${data.synced} successful`;
                if (data.errors > 0) {
                    message += `, ${data.errors} errors`;
                }
                alert(message);
            } else {
                alert(data.error || 'Sync failed');
            }
        } catch (error) {
            console.error('Error syncing with Brevo:', error);
            handleApiError(error);
        } finally {
            const button = event.target;
            if (button) {
                button.disabled = false;
                button.innerHTML = '🔄 Manual Brevo Sync';
            }
        }
    }

    async function syncToBrevoWithNames(subscriber) {
        if (!BREVO_API_KEY) return;

        try {
            const response = await fetch('https://api.brevo.com/v3/contacts', {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json',
                    'api-key': BREVO_API_KEY
                },
                body: JSON.stringify({
                    email: subscriber.email,
                    attributes: {
                        FIRSTNAME: subscriber.firstName,
                        LASTNAME: subscriber.lastName,
                        GAMING_HANDLE: subscriber.gamingHandle || '',
                        SOURCE: 'SideQuest Canterbury'
                    },
                    listIds: [BREVO_LIST_ID]
                })
            });

            if (response.ok) {
                console.log(`✅ Synced ${subscriber.firstName} ${subscriber.lastName} to Brevo`);
                return true;
            } else {
                const errorData = await response.json();
                console.error('Brevo sync error:', errorData);
                return false;
            }
        } catch (error) {
            console.error('Brevo API error:', error);
            return false;
        }
    }

    // Send campaign
    async function sendCampaign() {
        try {
            const subject = document.getElementById('campaignSubject')?.value?.trim() || '';
            const body = document.getElementById('campaignBody')?.value?.trim() || '';
            const fromName = document.getElementById('fromName')?.value?.trim() || '';
            
            if (!subject || !body) {
                alert('Please fill in both subject and email content');
                return;
            }
            
            if (subscribers.length === 0) {
                alert('No subscribers to send campaign to');
                return;
            }
            
            if (!confirm(`Send campaign to ${subscribers.length} subscribers?`)) return;
            
            const button = event.target;
            if (button) {
                button.disabled = true;
                button.innerHTML = '📧 Sending...';
            }
            
            // USE SECURE API CALL
            const response = await securePost(`${API_BASE}/send-campaign`, {
                subject,
                body,
                fromName: fromName || 'SideQuest Mail',
                recipients: subscribers
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                await loadActivity();
                alert(`Campaign sent successfully to ${data.sent} subscribers!`);
                // Clear form
                const subjectEl = document.getElementById('campaignSubject');
                const bodyEl = document.getElementById('campaignBody');
                if (subjectEl) subjectEl.value = '';
                if (bodyEl) bodyEl.value = '';
            } else {
                alert(data.error || 'Failed to send campaign');
            }
        } catch (error) {
            console.error('Error sending campaign:', error);
            handleApiError(error);
        } finally {
            const button = event.target;
            if (button) {
                button.disabled = false;
                button.innerHTML = '📧 Send Campaign';
            }
        }
    }

    // Refresh subscribers
    async function refreshSubscribers() {
      try {
        await loadInitialData();
        
        // Refresh chart if on analytics tab
        const analyticsTab = document.querySelector('.tab[data-tab="analytics"]');
        if (analyticsTab && analyticsTab.classList.contains('active')) {
          setTimeout(() => {
            if (document.getElementById('growthChart') && subscriberDetails.length > 0) {
              initializeGrowthChart();
            }
          }, 200);
        }
        
        showSuccess('Data refreshed!');
      } catch (error) {
        console.error('Error refreshing data:', error);
      }
    }

    // Update dashboard stats
    function updateStats() {
        try {
            const elements = {
                totalSubscribers: document.getElementById('totalSubscribers'),
                todaySignups: document.getElementById('todaySignups'),
                thisWeekSignups: document.getElementById('thisWeekSignups'),
                webSignups: document.getElementById('webSignups'),
                manualSignups: document.getElementById('manualSignups'),
                importSignups: document.getElementById('importSignups')
            };

            // Add null checks
            if (elements.totalSubscribers) elements.totalSubscribers.textContent = currentStats.total || 0;
            if (elements.todaySignups) elements.todaySignups.textContent = currentStats.today || 0;
            if (elements.thisWeekSignups) elements.thisWeekSignups.textContent = currentStats.week || 0;
            
            // Update source breakdown
            const sources = currentStats.sources || {};
            if (elements.webSignups) elements.webSignups.textContent = sources.web || 0;
            if (elements.manualSignups) elements.manualSignups.textContent = sources.manual || 0;
            if (elements.importSignups) elements.importSignups.textContent = sources.import || 0;
        } catch (error) {
            console.error('Error updating stats:', error);
        }
    }


    // Update campaign recipient count
    function updateCampaignRecipientCount() {
      try {
        const element = document.getElementById('campaignRecipientCount');
        if (element) {
          element.textContent = subscribers.length;
        }
      } catch (error) {
        console.error('Error updating campaign recipient count:', error);
      }
    }

    // Search functionality
    function setupSearch() {
        try {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredSubscribers = subscribers.filter(email => {
                        const details = subscriberDetails.find(d => d.email === email);
                        const fullName = details?.full_name?.toLowerCase() || '';
                        const firstName = details?.first_name?.toLowerCase() || '';
                        const lastName = details?.last_name?.toLowerCase() || '';
                        const gamingHandle = details?.gaming_handle?.toLowerCase() || '';
                        
                        return email.toLowerCase().includes(searchTerm) ||
                              fullName.includes(searchTerm) ||
                              firstName.includes(searchTerm) ||
                              lastName.includes(searchTerm) ||
                              gamingHandle.includes(searchTerm);
                    });
                    renderSubscribers(filteredSubscribers);
                });
            }
        } catch (error) {
            console.error('Error setting up search:', error);
        }
    }

    // Export CSV
    function exportCSV() {
      try {
        if (subscribers.length === 0) {
          alert('No subscribers to export');
          return;
        }

        const csvContent = 'Email,Date Added,Source\n' + 
          subscriberDetails.map(details => 
            `${details.email},${details.date_added},${details.source}`
          ).join('\n');
          
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_subscribers_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess(`Exported ${subscribers.length} subscribers to CSV`);
      } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('Error exporting CSV. Please try again.');
      }
    }

    // Generate QR Code (placeholder - would need QR library)
    function generateQR() {
      try {
        const urlInput = document.getElementById('qrUrl');
        if (!urlInput) return;
        
        const url = urlInput.value;
        if (!url) {
          alert('Please enter a URL');
          return;
        }

        const qrDisplay = document.getElementById('qrDisplay');
        if (qrDisplay) {
          qrDisplay.style.display = 'block';
          qrDisplay.innerHTML = `
            <div style="width: 200px; height: 200px; background: #1a1a1a; border: 2px dashed #FFD700; display: flex; align-items: center; justify-content: center; margin: 0 auto; border-radius: 12px; color: #FFD700;">
              📱 QR Code<br>
              <small>Would generate for:<br>${url}</small>
            </div>
            <p style="margin-top: 15px; font-size: 12px; color: #aaaaaa;">
              QR code library integration needed
            </p>
          `;
        }
      } catch (error) {
        console.error('Error generating QR code:', error);
      }
    }

    // Data management
    function backupData() {
      try {
        const backup = {
          subscribers: subscriberDetails,
          timestamp: new Date().toISOString(),
          count: subscribers.length,
          stats: currentStats
        };
        
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('Data backup created');
      } catch (error) {
        console.error('Error backing up data:', error);
        alert('Error creating backup. Please try again.');
      }
    }

    async function clearAllData() {
        try {
            if (!confirm('⚠️ This will delete ALL subscribers permanently. Are you sure?')) return;
            
            const confirmation = prompt('Type "DELETE" to confirm this action:');
            if (confirmation !== 'DELETE') return;
            
            // USE SECURE API CALL
            const response = await securePost(`${API_BASE}/clear-data`, {
                confirmation: 'DELETE'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                await loadInitialData();
                alert(data.message);
            } else {
                alert(data.error || 'Failed to clear data');
            }
        } catch (error) {
            console.error('Error clearing data:', error);
            handleApiError(error);
        }
    }

    function renderActivityLog() {
      try {
        const activityLogElement = document.getElementById('activityLog');
        if (!activityLogElement) return;
        
        if (activityLog.length === 0) {
          activityLogElement.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
          return;
        }

        const recentActivities = activityLog.slice(0, 10);
        activityLogElement.innerHTML = recentActivities.map(activity => {
          const time = new Date(activity.timestamp).toLocaleTimeString();
          const iconClass = activity.type === 'success' ? 'success' : 
                           activity.type === 'danger' ? 'danger' : 'info';
          const icon = activity.type === 'success' ? '✅' : 
                      activity.type === 'danger' ? '❌' : 'ℹ️';
          
          return `
            <div class="activity-item">
              <div class="activity-icon ${iconClass}">${icon}</div>
              <div class="activity-content">
                <div class="activity-text">${activity.message}</div>
                <div class="activity-time">${time}</div>
              </div>
            </div>
          `;
        }).join('');

        // Update last activity in system status
        if (recentActivities.length > 0) {
          const lastTime = new Date(recentActivities[0].timestamp).toLocaleTimeString();
          const lastActivityElement = document.getElementById('lastActivity');
          if (lastActivityElement) {
            lastActivityElement.textContent = lastTime;
          }
        }
      } catch (error) {
        console.error('Error rendering activity log:', error);
      }
    }

    // Auto refresh functionality
    function startAutoRefresh() {
      try {
        // Refresh data every 30 seconds
        setInterval(async () => {
          try {
            // Remove the old loadStats() call and replace with:
            await loadActivity();
            
            // Only refresh analytics if we're currently on the analytics tab
            const analyticsTab = document.querySelector('.tab[data-tab="analytics"]');
            if (analyticsTab && analyticsTab.classList.contains('active')) {
              await loadAnalyticsData();
            }
          } catch (error) {
            console.error('Auto refresh error:', error);
          }
        }, 30000);
      } catch (error) {
        console.error('Error starting auto refresh:', error);
      }
    }

    function handleApiError(error) {
        console.error('API Error:', error);
        
        if (error.message.includes('403')) {
            alert('Session expired or security token invalid. Please refresh the page and try again.');
            // Optionally auto-refresh the page
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else if (error.message.includes('401')) {
            alert('Authentication failed. Please log in again.');
            window.location.href = '/admin/login';
        } else {
            alert('Network error. Please check your connection and try again.');
        }
    }

    // Utility functions
    function isValidEmail(email) {
      const pattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return pattern.test(email);
    }

    function showLoading(elementId) {
      try {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #aaaaaa;">
              <div class="spinner"></div>
              <p style="margin-top: 15px;">Loading...</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error showing loading:', error);
      }
    }

    // Add this function to your JavaScript (around line 2500)
    function toggleChartView(viewType) {
      if (currentChartView === viewType) return;
      
      currentChartView = viewType;
      
      // Update button states
      document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const targetButton = document.querySelector(`[data-chart="${viewType}"]`);
      if (targetButton) {
        targetButton.classList.add('active');
      }
      
      // Reload the chart with new data
      loadAnalyticsData();
    }

    let subscriberGrowthChart = null;
    let registrationTrendChart = null;

    let currentChartView = 'subscribers';
    // Analytics Functions - ADD TO YOUR EXISTING JAVASCRIPT

    // Load analytics data
    async function loadAnalyticsData() {
      try {
        const timeRange = document.getElementById('analyticsTimeRange')?.value || 30;
        
        showAnalyticsLoading();
        
        const response = await fetch(`${API_BASE}/api/analytics/kpis?days=${timeRange}`);
        const data = await response.json();
        
        if (data.success) {
          updateAnalyticsKPIs(data.kpis);
          updateAnalyticsCharts(data.trends);
          updateEventTypesPerformance(data.trends.event_types);
          
         console.log('Analytics data loaded successfully');
        } else {
          showAnalyticsError('Failed to load analytics data: ' + (data.error || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Error loading analytics:', error);
        showAnalyticsError('Network error loading analytics data');
      }
    }

    // Update KPI cards
    function updateAnalyticsKPIs(kpis) {
      try {
        // Subscriber KPIs
        const subscriberKPIs = kpis.subscribers || {};
        document.getElementById('analyticsSubscribers').textContent = subscriberKPIs.total || 0;
        document.getElementById('newSubscribers').textContent = subscriberKPIs.new_this_period || 0;
        document.getElementById('weeklyGrowth').textContent = subscriberKPIs.weekly_growth || 0;
        
        // Update status banner
        document.getElementById('quickSubscriberCount').textContent = subscriberKPIs.total || 0;
        
        // Update growth trend
        const growthRate = subscriberKPIs.growth_rate || 0;
        const trendElement = document.getElementById('subscriberTrend');
        if (trendElement) {
          trendElement.textContent = (growthRate >= 0 ? '+' : '') + growthRate + '%';
          trendElement.className = growthRate >= 0 ? 'kpi-trend' : 'kpi-trend negative';
        }
        
        // Event KPIs
        const eventKPIs = kpis.events || {};
        document.getElementById('totalEvents').textContent = eventKPIs.total || 0;
        document.getElementById('totalRegistrations').textContent = eventKPIs.total_registrations || 0;
        document.getElementById('capacityUtil').textContent = (eventKPIs.avg_capacity_utilization || 0) + '%';
        
        // Update status banner
        document.getElementById('quickEventCount').textContent = eventKPIs.total || 0;
        
        const upcomingBadge = document.getElementById('upcomingEventsBadge');
        if (upcomingBadge) {
          upcomingBadge.textContent = (eventKPIs.upcoming || 0) + ' upcoming';
        }
        
        // Revenue KPIs
        const revenueKPIs = kpis.revenue || {};
        document.getElementById('totalRevenue').textContent = '£' + (revenueKPIs.total || 0).toFixed(2);
        document.getElementById('avgRevenuePerEvent').textContent = '£' + (revenueKPIs.avg_per_event || 0).toFixed(2);
        
        // Update status banner
        document.getElementById('quickRevenue').textContent = '£' + (revenueKPIs.total || 0).toFixed(0);
        
        const paidEventsBadge = document.getElementById('paidEventsBadge');
        if (paidEventsBadge) {
          paidEventsBadge.textContent = (revenueKPIs.paid_events || 0) + ' paid events';
        }
        
        // Engagement KPIs
        const engagementKPIs = kpis.engagement || {};
        document.getElementById('engagementRate').textContent = (engagementKPIs.engagement_rate || 0) + '%';
        document.getElementById('engagedSubscribers').textContent = engagementKPIs.engaged_subscribers || 0;
        
        // Calculate average registrations per event
        const avgRegsPerEvent = eventKPIs.total > 0 ? Math.round((eventKPIs.total_registrations || 0) / eventKPIs.total) : 0;
        document.getElementById('avgRegistrationsPerEvent').textContent = avgRegsPerEvent;
        
        const attendanceTrend = document.getElementById('attendanceTrend');
        if (attendanceTrend) {
          attendanceTrend.textContent = (engagementKPIs.attendance_rate || 0) + '%';
        }
        
        // Update business health score
        updateBusinessHealthScore(kpis);
        
        // Update insights
        updateInsights(kpis);
        
        // Update performance summary
        updatePerformanceSummary(kpis);
        
      } catch (error) {
        console.error('Error updating KPIs:', error);
      }
    }

    // Business health score calculation
    function updateBusinessHealthScore(kpis) {
      try {
        const subscriber = kpis.subscribers || {};
        const events = kpis.events || {};
        const engagement = kpis.engagement || {};
        
        let score = 0;
        let status = 'Good';
        let color = '#FFD700';
        
        // Score factors
        if (subscriber.growth_rate > 20) score += 25;
        else if (subscriber.growth_rate > 0) score += 15;
        else score += 5;
        
        if (engagement.engagement_rate > 50) score += 25;      // Excellent
        else if (engagement.engagement_rate > 30) score += 20; // Good  
        else if (engagement.engagement_rate > 15) score += 10; // Fair
        else score += 5; 
        
        if (events.avg_capacity_utilization > 70) score += 25;
        else if (events.avg_capacity_utilization > 40) score += 15;
        else score += 5;
        
        if (events.upcoming > 0) score += 25;
        else score += 10;
        
        // Determine status
        if (score >= 80) {
          status = 'Excellent';
          color = '#00ff88';
        } else if (score >= 60) {
          status = 'Good';
          color = '#FFD700';
        } else if (score >= 40) {
          status = 'Fair';
          color = '#FFA500';
        } else {
          status = 'Needs Attention';
          color = '#ff6b35';
        }
        
        const healthElement = document.getElementById('businessHealthScore');
        if (healthElement) {
          healthElement.textContent = status;
          healthElement.style.color = color;
        }
        
      } catch (error) {
        console.error('Error updating business health score:', error);
      }
    }

    

    function updateAnalyticsCharts(trends) {
      try {
        updateMainGrowthChart(trends); // ← New function name
        // Remove the old function calls:
        // updateSubscriberGrowthChart(trends.subscriber_growth || []);
        // updateRegistrationTrendChart(trends.registration_trend || []);
      } catch (error) {
        console.error('Error updating charts:', error);
      }
    }

    // Export analytics report
    async function exportAnalyticsReport() {
      try {
        const timeRange = document.getElementById('analyticsTimeRange')?.value || 30;
        showSuccess('📊 Generating analytics report...');
        
        // Get current analytics data
        const response = await fetch(`${API_BASE}/api/analytics/kpis?days=${timeRange}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to fetch analytics data');
        }
        
        // Create CSV content
        const timestamp = new Date().toISOString().split('T')[0];
        let csvContent = `SideQuest Analytics Report - ${timestamp}\n\n`;
        
        csvContent += `SUBSCRIBER METRICS (Last ${timeRange} days)\n`;
        csvContent += `Total Subscribers,${data.kpis.subscribers.total}\n`;
        csvContent += `New Subscribers,${data.kpis.subscribers.new_this_period}\n`;
        csvContent += `Weekly Growth,${data.kpis.subscribers.weekly_growth}\n`;
        csvContent += `Growth Rate,${data.kpis.subscribers.growth_rate}%\n\n`;
        
        csvContent += `EVENT METRICS\n`;
        csvContent += `Total Events,${data.kpis.events.total}\n`;
        csvContent += `Upcoming Events,${data.kpis.events.upcoming}\n`;
        csvContent += `Total Registrations,${data.kpis.events.total_registrations}\n`;
        csvContent += `Avg Capacity Utilization,${data.kpis.events.avg_capacity_utilization}%\n\n`;
        
        csvContent += `REVENUE METRICS\n`;
        csvContent += `Total Revenue,£${data.kpis.revenue.total}\n`;
        csvContent += `Paid Events,${data.kpis.revenue.paid_events}\n`;
        csvContent += `Avg Revenue per Event,£${data.kpis.revenue.avg_per_event}\n\n`;
        
        csvContent += `ENGAGEMENT METRICS\n`;
        csvContent += `Engagement Rate,${data.kpis.engagement.engagement_rate}%\n`;
        csvContent += `Active Subscribers,${data.kpis.engagement.engaged_subscribers}\n`;
        csvContent += `Attendance Rate,${data.kpis.engagement.attendance_rate}%\n`;
        
        // Download the report
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_analytics_${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('📊 Analytics report downloaded!');
        
      } catch (error) {
        console.error('Error exporting analytics report:', error);
        alert('Failed to export analytics report: ' + error.message);
      }
    }

    // Event mix optimization suggestions
    function optimizeEventMix() {
      const suggestions = [
        "🎯 Your tournaments have high engagement - consider adding more competitive events",
        "🎮 Game nights are popular - try themed nights (retro, indie, etc.)",
        "💡 Consider adding beginner-friendly events to attract new participants", 
        "🏆 Premium tournaments could increase revenue while maintaining engagement",
        "📅 Weekly recurring events could boost regular attendance"
      ];
      
      const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
      alert("💡 Recommendation:\n\n" + randomSuggestion);
    }

    // Insight action execution
    function executeInsightAction(action) {
      const actions = {
        'Plan more events': () => {
          document.querySelector('.tab[data-tab="events"]').click();
          setTimeout(() => switchEventView('create'), 500);
        },
        'Launch growth campaign': () => {
          document.querySelector('.tab[data-tab="campaigns"]').click();
        },
        'Boost engagement': () => {
          alert('💡 Try these engagement boosters:\n\n• Send personalized event invitations\n• Create member-exclusive events\n• Add loyalty rewards\n• Host community challenges');
        },
        'Create paid events': () => {
          document.querySelector('.tab[data-tab="events"]').click();
          setTimeout(() => {
            switchEventView('create');
            setTimeout(() => {
              const feeInput = document.getElementById('eventFee');
              if (feeInput) {
                feeInput.focus();
                feeInput.value = '10.00';
              }
            }, 1000);
          }, 500);
        },
        'Scale successful events': () => {
          alert('💰 Revenue optimization ideas:\n\n• Increase capacity for popular events\n• Create tiered pricing (VIP, Standard)\n• Add merchandise sales\n• Offer event packages');
        },
        'Expand capacity': () => {
          alert('📈 Capacity expansion options:\n\n• Book larger venues\n• Add multiple sessions\n• Create waiting lists\n• Live stream popular events');
        },
        'Maintain momentum': () => {
          alert('🚀 Keep the momentum:\n\n• Regular communication with community\n• Consistent event schedule\n• Member feedback surveys\n• Referral incentives');
        }
      };
      
      if (actions[action]) {
        actions[action]();
      } else {
        alert('💡 Action: ' + action);
      }
    }


    // Generate AI insights
    function updateInsights(kpis) {
      try {
        const insights = [];
        const subscriber = kpis.subscribers || {};
        const events = kpis.events || {};
        const engagement = kpis.engagement || {};
        const revenue = kpis.revenue || {};
        
        // Growth insights
        if (subscriber.growth_rate > 50) {
          insights.push({
            type: 'success',
            icon: '🚀',
            title: 'Explosive Growth!',
            description: `Your subscriber base is growing ${subscriber.growth_rate}% faster than the previous period. Consider scaling your event capacity.`,
            action: 'Plan more events'
          });
        } else if (subscriber.growth_rate < 0) {
          insights.push({
            type: 'warning',
            icon: '⚠️',
            title: 'Growth Slowdown',
            description: 'Subscriber growth has declined. Consider running a promotional campaign or special event.',
            action: 'Launch growth campaign'
          });
        }
        
        // Engagement insights
        if (engagement.engagement_rate > 60) {  // 60%+ is truly high
          insights.push({
            type: 'success',
            icon: '🎯',
            title: 'Excellent Engagement',
            description: `${engagement.engagement_rate}% of subscribers actively participate in events. Outstanding community engagement!`,
            action: 'Maintain momentum'
          });
        } else if (engagement.engagement_rate > 35) {  // 35-60% is good
          insights.push({
            type: 'success',
            icon: '👍',
            title: 'Good Engagement',
            description: `${engagement.engagement_rate}% participation rate shows solid community engagement.`,
            action: 'Scale successful events'
          });
        } else if (engagement.engagement_rate > 20) {  // 20-35% is average
          insights.push({
            type: 'opportunity',
            icon: '📈',
            title: 'Room for Growth',
            description: `${engagement.engagement_rate}% participation rate has potential for improvement. Consider more diverse events.`,
            action: 'Boost engagement'
          });
        } else {  // Under 20% needs attention
          insights.push({
            type: 'warning',
            icon: '⚠️',
            title: 'Low Engagement',
            description: `Only ${engagement.engagement_rate}% of subscribers are participating in events. Consider survey feedback or promotional campaigns.`,
            action: 'Launch engagement campaign'
          });
        }
        
        // Revenue insights
        if (revenue.paid_events === 0) {
          insights.push({
            type: 'opportunity',
            icon: '💰',
            title: 'Revenue Opportunity',
            description: 'All events are currently free. Consider introducing premium events or workshops to generate revenue.',
            action: 'Create paid events'
          });
        } else if (revenue.avg_per_event > 15) {
          insights.push({
            type: 'success',
            icon: '💎',
            title: 'Strong Revenue per Event',
            description: `Averaging £${revenue.avg_per_event.toFixed(2)} per event shows healthy monetization.`,
            action: 'Scale successful events'
          });
        }
        
        // Capacity insights
        if (events.avg_capacity_utilization > 90) {
          insights.push({
            type: 'warning',
            icon: '📈',
            title: 'High Demand',
            description: 'Events are consistently at capacity. Consider increasing venue size or adding more sessions.',
            action: 'Expand capacity'
          });
        }
        
        renderInsights(insights);
        
      } catch (error) {
        console.error('Error updating insights:', error);
      }
    }

    // Render insights
    function renderInsights(insights) {
      const container = document.getElementById('aiInsights');
      if (!container) return;
      
      if (insights.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No insights available yet. Check back as your data grows!</p>';
        return;
      }
      
      container.innerHTML = insights.map(insight => `
        <div class="insight-card ${insight.type}" onclick="executeInsightAction('${insight.action}')">
          <div class="insight-header">
            <span class="insight-icon">${insight.icon}</span>
            <span class="insight-title">${insight.title}</span>
          </div>
          <div class="insight-description">${insight.description}</div>
          <div class="insight-action">${insight.action} →</div>
        </div>
      `).join('');
    }

    // Performance summary
    function updatePerformanceSummary(kpis) {
      try {
        const container = document.getElementById('performanceSummary');
        if (!container) return;
        
        const subscriber = kpis.subscribers || {};
        const events = kpis.events || {};
        const engagement = kpis.engagement || {};
        const revenue = kpis.revenue || {};
        
        const metrics = [
          {
            label: 'Growth Rate',
            value: `${subscriber.growth_rate || 0}%`,
            trend: subscriber.growth_rate > 0 ? 'up' : subscriber.growth_rate < 0 ? 'down' : 'neutral',
            icon: subscriber.growth_rate > 0 ? '↗️' : subscriber.growth_rate < 0 ? '↘️' : '➡️'
          },
          {
            label: 'Event Participation',
            value: `${engagement.engagement_rate || 0}%`,
            trend: engagement.engagement_rate > 25 ? 'up' : engagement.engagement_rate < 15 ? 'down' : 'neutral',
            icon: engagement.engagement_rate > 25 ? '🎯' : '👥'
          },
          {
            label: 'Avg Capacity',
            value: `${events.avg_capacity_utilization || 0}%`,
            trend: events.avg_capacity_utilization > 70 ? 'up' : events.avg_capacity_utilization < 40 ? 'down' : 'neutral',
            icon: events.avg_capacity_utilization > 70 ? '🔥' : '📊'
          },
          {
            label: 'Revenue/Event',
            value: `£${(revenue.avg_per_event || 0).toFixed(2)}`,
            trend: revenue.avg_per_event > 10 ? 'up' : revenue.avg_per_event < 5 ? 'down' : 'neutral',
            icon: '💰'
          }
        ];
        
        container.innerHTML = metrics.map(metric => `
          <div class="performance-metric">
            <span class="metric-label">${metric.icon} ${metric.label}</span>
            <div>
              <span class="metric-value">${metric.value}</span>
              <span class="metric-trend trend-${metric.trend}"></span>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error updating performance summary:', error);
      }
    }
    // Replace the chart data generation in updateMainGrowthChart function
    function updateMainGrowthChart(trends) {
      try {
        const ctx = document.getElementById('mainGrowthChart');
        if (!ctx) return;
        
        if (subscriberGrowthChart) {
          subscriberGrowthChart.destroy();
        }
        
        let chartConfig;
        
        if (currentChartView === 'subscribers') {
          const subscriberData = trends.subscriber_growth || [];
          
          if (subscriberData.length === 0) {
            // Show empty state
            const chartCtx = ctx.getContext('2d');
            chartCtx.clearRect(0, 0, ctx.width, ctx.height);
            chartCtx.fillStyle = '#666';
            chartCtx.font = '16px Arial';
            chartCtx.textAlign = 'center';
            chartCtx.fillText('No subscriber data available', ctx.width/2, ctx.height/2);
            return;
          }
          
          const labels = subscriberData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
          });
          
          const newSubscribers = subscriberData.map(item => item.new_subscribers || 0);
          
          // Calculate cumulative properly - start from current total and work backwards
          const totalSubs = subscribers.length || 0;
          let runningTotal = totalSubs;
          const cumulativeSubscribers = [];
          
          // Work backwards from the end to calculate proper cumulative values
          for (let i = subscriberData.length - 1; i >= 0; i--) {
            cumulativeSubscribers.unshift(runningTotal);
            runningTotal -= (subscriberData[i].new_subscribers || 0);
          }
          
          // Ensure we don't have negative values
          const minValue = Math.max(0, Math.min(...cumulativeSubscribers));
          const adjustedCumulative = cumulativeSubscribers.map(val => Math.max(minValue, val));
          
          chartConfig = {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'New Subscribers',
                  data: newSubscribers,
                  borderColor: '#FFD700',
                  backgroundColor: 'rgba(255, 215, 0, 0.1)',
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: '#FFD700',
                  pointBorderColor: '#1a1a1a',
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  yAxisID: 'y'
                },
                {
                  label: 'Total Subscribers',
                  data: adjustedCumulative,
                  borderColor: '#4ECDC4',
                  backgroundColor: 'rgba(78, 205, 196, 0.1)',
                  borderWidth: 3,
                  fill: false,
                  tension: 0.3,
                  pointBackgroundColor: '#4ECDC4',
                  pointBorderColor: '#1a1a1a',
                  pointBorderWidth: 2,
                  pointRadius: 5,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    color: '#FFD700',
                    font: { weight: 'bold' },
                    usePointStyle: true
                  }
                },
                tooltip: {
                  backgroundColor: '#2a2a2a',
                  titleColor: '#FFD700',
                  bodyColor: '#ffffff',
                  borderColor: '#FFD700',
                  borderWidth: 1
                }
              },
              scales: {
                x: {
                  grid: { color: '#444' },
                  ticks: { color: '#cccccc', maxRotation: 45 }
                },
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  beginAtZero: true,
                  grid: { color: '#444' },
                  ticks: { color: '#cccccc' },
                  title: {
                    display: true,
                    text: 'New Subscribers',
                    color: '#FFD700'
                  }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  beginAtZero: false,
                  grid: { drawOnChartArea: false },
                  ticks: { color: '#4ECDC4' },
                  title: {
                    display: true,
                    text: 'Total Subscribers',
                    color: '#4ECDC4'
                  }
                }
              }
            }
          };
          
        } else {
          // Registrations view - FIX THE BROKEN CHART
          const registrationData = trends.registration_trend || [];
          
          if (registrationData.length === 0) {
            // Create empty chart with message
            chartConfig = {
              type: 'bar',
              data: {
                labels: ['No Data'],
                datasets: [{
                  label: 'Event Registrations',
                  data: [0],
                  backgroundColor: 'rgba(139, 92, 246, 0.3)',
                  borderColor: '#8B5CF6',
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    labels: { color: '#8B5CF6', font: { weight: 'bold' } }
                  }
                },
                scales: {
                  x: { grid: { color: '#444' }, ticks: { color: '#cccccc' } },
                  y: { 
                    beginAtZero: true, 
                    grid: { color: '#444' }, 
                    ticks: { color: '#cccccc' },
                    title: { display: true, text: 'Registrations', color: '#8B5CF6' }
                  }
                }
              }
            };
          } else {
            const labels = registrationData.map(item => {
              const date = new Date(item.date);
              return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
            });
            
            const registrations = registrationData.map(item => item.registrations || 0);
            
            chartConfig = {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Event Registrations',
                  data: registrations,
                  backgroundColor: 'rgba(139, 92, 246, 0.8)',
                  borderColor: '#8B5CF6',
                  borderWidth: 2,
                  borderRadius: 8,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top',
                    labels: {
                      color: '#8B5CF6',
                      font: { weight: 'bold' },
                      usePointStyle: true
                    }
                  }
                },
                scales: {
                  x: { grid: { color: '#444' }, ticks: { color: '#cccccc', maxRotation: 45 } },
                  y: {
                    beginAtZero: true,
                    grid: { color: '#444' },
                    ticks: { color: '#cccccc' },
                    title: { display: true, text: 'Registrations', color: '#8B5CF6' }
                  }
                }
              }
            };
          }
        }
        
        subscriberGrowthChart = new Chart(ctx, chartConfig);
        
      } catch (error) {
        console.error('Error updating main growth chart:', error);
        // Show error in chart area
        const chartCtx = ctx.getContext('2d');
        chartCtx.clearRect(0, 0, ctx.width, ctx.height);
        chartCtx.fillStyle = '#ff6b35';
        chartCtx.font = '16px Arial';
        chartCtx.textAlign = 'center';
        chartCtx.fillText('Chart error - check console', ctx.width/2, ctx.height/2);
      }
    }

   // Birthday Party Form Functions
    function toggleEventTypeForm() {
      const eventType = document.getElementById('eventType').value;
      const birthdayForm = document.getElementById('birthdayPartyForm');
      const standardForm = document.getElementById('standardEventForm');
      
      if (eventType === 'birthday') {
        birthdayForm.style.display = 'block';
        standardForm.style.display = 'none';
        
        // Enable birthday form required fields
        const birthdayRequiredFields = birthdayForm.querySelectorAll('[required]');
        birthdayRequiredFields.forEach(field => field.required = true);
        
        // Disable standard form required fields
        const standardRequiredFields = standardForm.querySelectorAll('[required]');
        standardRequiredFields.forEach(field => field.required = false);
        
        // ✅ Only set defaults if NOT editing
        if (!window.isEditingEvent) {
          // Set default time for birthday parties (usually afternoons)
          const nextWeek = new Date();
          nextWeek.setDate(nextWeek.getDate() + 7); // Default to next week
          nextWeek.setHours(14, 0, 0, 0); // 2 PM default
          const birthdayStartTime = document.getElementById('birthdayStartTime');
          if (birthdayStartTime) {
            birthdayStartTime.value = nextWeek.toISOString().slice(0, 16);
          }
          
          updateBirthdayPricing();
        }

      } else {
        birthdayForm.style.display = 'none';
        standardForm.style.display = 'block';
        
        // Disable birthday form required fields
        const birthdayRequiredFields = birthdayForm.querySelectorAll('[required]');
        birthdayRequiredFields.forEach(field => field.required = false);
        
        // Enable standard form required fields
        const standardRequiredFields = standardForm.querySelectorAll('[required]');
        standardRequiredFields.forEach(field => field.required = true);
        
        // ✅ Only set defaults if NOT editing
        if (!window.isEditingEvent) {
          // Set default time for other events (evenings)
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          tomorrow.setHours(19, 0, 0, 0); // 7 PM default
          const dateInput = document.getElementById('eventDateTime');
          if (dateInput) {
            dateInput.value = tomorrow.toISOString().slice(0, 16);
          }
        }
      }
    }


    function updateBirthdayPricing() {
      const duration = parseInt(document.getElementById('birthdayDuration')?.value || '2');
      const packageType = document.querySelector('input[name="birthdayPackage"]:checked')?.value || 'console';
      const pricingDetails = document.getElementById('pricingDetails');
      
      if (!pricingDetails) return;
      
      let html = '';
      
      if (packageType === 'console') {
        const basePrice = 148; // First 2 hours
        const additionalHours = Math.max(0, duration - 2);
        const additionalCost = additionalHours * 56;
        const totalCost = basePrice + additionalCost;
        const deposit = 20;
        
        html = `
          <p><strong>Console Package (${duration} hours):</strong> <span>£${totalCost}</span></p>
          <p style="color: #aaa; font-size: 0.85rem; margin-left: 20px;">
            • Base (2 hours): £148<br>
            ${additionalHours > 0 ? `• Additional ${additionalHours} hour${additionalHours > 1 ? 's' : ''}: £${additionalCost}<br>` : ''}
            • 10% off food & drinks<br>
            • 50% off extra Knit Bags<br>
            • Free birthday decorations & gift bag
          </p>
          <p><strong>Deposit Required:</strong> <span>£${deposit}</span></p>
          <p style="border-top: 1px solid #444; padding-top: 10px; margin-top: 15px; font-weight: 700; color: #FF69B4; font-size: 1.1rem;">
            <strong>Total Due:</strong> <span>£${totalCost}</span>
          </p>
          <p style="font-size: 0.8rem; color: #aaa; font-style: italic;">
            *Deposit will be deducted from final bill
          </p>
        `;
      } else {
        html = `
          <p><strong>Standard Birthday Rate:</strong> <span>Pay as you play</span></p>
          <p style="color: #aaa; font-size: 0.85rem; margin-left: 20px;">
            • Charged per game/equipment used<br>
            • Free birthday decorations & gift bag<br>
            • Flexible gaming options
          </p>
          <p><strong>Deposit Required:</strong> <span>£20</span></p>
          <p style="font-size: 0.8rem; color: #aaa; font-style: italic;">
            *Final cost depends on games played. Deposit deducted from bill.
          </p>
        `;
      }
      
      pricingDetails.innerHTML = html;
    }

    // Update event types performance
    function updateEventTypesPerformance(eventTypes) {
      try {
        const container = document.getElementById('eventTypesPerformance');
        if (!container) return;
        
        if (!eventTypes || eventTypes.length === 0) {
          container.innerHTML = '<p class="text-muted text-center">No event data available</p>';
          return;
        }
        
        container.innerHTML = eventTypes.map(eventType => {
          const typeClass = eventType.event_type.toLowerCase().replace(/\s+/g, '_');
          const capacityUtil = Math.round(eventType.avg_capacity_util || 0);
          
          return `
            <div class="event-type-card ${typeClass}">
              <div class="event-type-header">
                <span class="event-type-title">${eventType.event_type.replace('_', ' ')}</span>
                <span class="event-type-count">${eventType.event_count}</span>
              </div>
              <div class="event-type-stats">
                <div class="event-type-stat">
                  <span class="event-type-stat-value">${eventType.total_registrations || 0}</span>
                  <span class="event-type-stat-label">Registrations</span>
                </div>
                <div class="event-type-stat">
                  <span class="event-type-stat-value">${capacityUtil}%</span>
                  <span class="event-type-stat-label">Avg Capacity</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error updating event types performance:', error);
      }
    }

    // Show loading state
    function showAnalyticsLoading() {
      // Update KPI cards to show loading
      const kpiValues = document.querySelectorAll('.kpi-value, .kpi-detail-value');
      kpiValues.forEach(element => {
        element.textContent = '-';
      });
      
      // Show loading for charts
      const chartContainers = document.querySelectorAll('.chart-container canvas');
      chartContainers.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
      
      // Show loading for event types
      const eventTypesContainer = document.getElementById('eventTypesPerformance');
      if (eventTypesContainer) {
        eventTypesContainer.innerHTML = `
          <div class="loading-placeholder">
            <div class="spinner"></div>
            <p>Loading performance data...</p>
          </div>
        `;
      }
    }

    // Show error state
    function showAnalyticsError(message) {
      console.error('Analytics error:', message);
      
      const eventTypesContainer = document.getElementById('eventTypesPerformance');
      if (eventTypesContainer) {
        eventTypesContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ff6b35;">
            <p>❌ ${message}</p>
            <button class="btn btn-primary btn-sm" onclick="loadAnalyticsData()">
              🔄 Retry
            </button>
          </div>
        `;
      }
    }

    // Refresh analytics
    async function refreshAnalytics() {
      await loadAnalyticsData();
      showSuccess('Analytics data refreshed!');
    }

    // Initialize analytics when tab is clicked
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener for analytics time range change
      const timeRangeSelect = document.getElementById('analyticsTimeRange');
      if (timeRangeSelect) {
        timeRangeSelect.addEventListener('change', loadAnalyticsData);
      }
      
      // Load analytics when analytics tab is clicked
      const analyticsTab = document.querySelector('.tab[data-tab="analytics"]');
      if (analyticsTab) {
        analyticsTab.addEventListener('click', function() {
          // Small delay to ensure tab content is visible
          setTimeout(loadAnalyticsData, 200);
        });
      }
    });

    // Initialize tabs
    function initializeTabs() {
      try {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
              targetContent.classList.add('active');
            }
            
            // FIXED: Reset edit state when switching away from events tab
            if (targetTab !== 'events' && currentEditingEventId !== null) {
              console.log('🔧 Resetting edit state due to tab switch');
              currentEditingEventId = null;
              resetCreateFormUI();
              resetEventForm();
            }
            
            // Load appropriate data based on tab
            if (targetTab === 'campaigns') {
              updateCampaignRecipientCount();
            } else if (targetTab === 'analytics') {
              setTimeout(loadAnalyticsData, 200);
            } else if (targetTab === 'events') {
              // FIXED: Reset to list view and clear edit state when returning to events
              setTimeout(() => {
                loadEvents();
                if (currentEditingEventId !== null) {
                  console.log('🔧 Clearing edit state on events tab return');
                  currentEditingEventId = null;
                  resetCreateFormUI();
                  resetEventForm();
                  switchEventView('list'); // Always go back to list view
                }
              }, 100);
            }
            
            if (targetTab === 'analytics' && document.getElementById('growthChart')) {
              setTimeout(() => {
                if (subscriberDetails.length > 0) {
                  initializeGrowthChart();
                }
              }, 100);
            }
          });
        });
      } catch (error) {
        console.error('Error initializing tabs:', error);
      }
    }

    function showSuccess(message) {
      try {
        // Success notification with SideQuest styling
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
          color: #1a1a1a;
          padding: 18px 25px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
          z-index: 1000;
          animation: slideIn 0.3s ease;
          font-weight: 600;
          border: 2px solid #FFD700;
        `;
        notification.textContent = `✅ ${message}`;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 3000);
      } catch (error) {
        console.error('Error showing success notification:', error);
      }
    }

    // Handle Enter key in email input
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const emailInput = document.getElementById('newSubscriberEmail');
        if (emailInput) {
          emailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              addSubscriber();
            }
          });
        }
      } catch (error) {
        console.error('Error setting up enter key handler:', error);
      }
    });
    

    
  </script>
</body>

</html>
