<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SideQuest Mail Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
      border: 2px solid #FFD700;
    }
    
    .header h1 { 
      font-size: 2.8rem; 
      margin-bottom: 8px; 
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header p { 
      font-size: 1.2rem; 
      font-weight: 500;
      opacity: 0.8;
    }
    
    /* Logo placeholder */
    .logo {
      display: inline-block;
      width: 45px;
      height: 45px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-right: 15px;
      vertical-align: middle;
      position: relative;
      border: 2px solid #1a1a1a;
    }
    
    .logo::before {
      content: "SQ";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #FFD700;
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -1px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border-left: 4px solid;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    
    .stat-card.primary { border-left-color: #FFD700; }
    .stat-card.success { border-left-color: #00ff88; }
    .stat-card.warning { border-left-color: #ff6b35; }
    .stat-card.info { border-left-color: #8b5cf6; }
    
    .stat-value {
      font-size: 2.8rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
    }
    
    .stat-label {
      color: #cccccc;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    /* Main Content */
    .main-content {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid #444;
    }
    
    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid #444;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #444;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #FFD700;
      text-shadow: 0 1px 2px rgba(255, 215, 0, 0.3);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 6px;
      margin-bottom: 25px;
      border: 2px solid #444;
    }
    
    .tab {
      flex: 1;
      padding: 12px 18px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
      transform: translateY(-1px);
    }
    
    .tab:not(.active) {
      color: #cccccc;
    }
    
    .tab:not(.active):hover {
      color: #FFD700;
      background: #333;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
      padding: 25px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #FFD700;
      font-size: 1rem;
    }
    
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #444;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #1a1a1a;
      color: #ffffff;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
      background: #2a2a2a;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 215, 0, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    }
    
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }
    
    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 107, 53, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    }
    
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(107, 114, 128, 0.4);
    }
    
    .btn-sm {
      padding: 10px 20px;
      font-size: 12px;
    }
    
    /* Subscriber List */
    .subscriber-list {
      max-height: 450px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #FFD700 #2a2a2a;
    }
    
    .subscriber-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .subscriber-list::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 4px;
    }
    
    .subscriber-list::-webkit-scrollbar-thumb {
      background: #FFD700;
      border-radius: 4px;
    }
    
    .subscriber-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #444;
      transition: background 0.2s ease;
    }
    
    .subscriber-item:hover {
      background: rgba(255, 215, 0, 0.05);
      border-radius: 8px;
      padding-left: 10px;
      padding-right: 10px;
    }
    
    .subscriber-item:last-child {
      border-bottom: none;
    }
    
    .subscriber-info {
      flex: 1;
    }
    
    .subscriber-email {
      font-weight: 600;
      color: #ffffff;
      font-size: 1.05rem;
    }
    
    .subscriber-meta {
      font-size: 12px;
      color: #aaaaaa;
      margin-top: 5px;
    }
    
    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 25px;
    }
    
    .search-input {
      width: 100%;
      padding: 14px 18px 14px 50px;
      border: 2px solid #444;
      border-radius: 10px;
      font-size: 14px;
      background: #1a1a1a;
      color: #ffffff;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
    }
    
    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: #FFD700;
      font-size: 18px;
    }
    
    /* Activity Log */
    .activity-item {
      display: flex;
      align-items: flex-start;
      padding: 15px 0;
      border-bottom: 1px solid #444;
      transition: background 0.2s ease;
    }
    
    .activity-item:hover {
      background: rgba(255, 215, 0, 0.05);
      border-radius: 8px;
      padding-left: 10px;
      padding-right: 10px;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .activity-icon.success { 
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
    }
    .activity-icon.danger { 
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
    }
    .activity-icon.info { 
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-text {
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }
    
    .activity-time {
      color: #aaaaaa;
      font-size: 12px;
      margin-top: 3px;
    }
    
    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #444;
      border-top: 3px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Chart container */
    .chart-container {
      height: 280px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #444;
      margin-top: 15px;
    }
    
    /* Source stats */
    .source-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .source-stat {
      text-align: center;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 12px;
      border: 2px solid #444;
      transition: all 0.3s ease;
    }
    
    .source-stat:hover {
      border-color: #FFD700;
      transform: translateY(-2px);
    }
    
    .source-stat-value {
      font-size: 2rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 8px;
    }
    
    .source-stat-label {
      font-size: 0.8rem;
      color: #aaaaaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .container {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 2.2rem;
      }
      
      .source-stats {
        grid-template-columns: 1fr;
      }
    }
    
    /* Success notification styles */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Utilities */
    .text-center { text-align: center; }
    .mb-0 { margin-bottom: 0; }
    .mt-20 { margin-top: 20px; }
    .text-success { color: #00ff88; }
    .text-danger { color: #ff6b35; }
    .text-muted { color: #aaaaaa; }

    /* Event Management Styles */
    .event-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 10px;
    }

    .event-nav-btn {
      padding: 10px 20px;
      background: #2a2a2a;
      color: #cccccc;
      border: 2px solid #444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .event-nav-btn.active {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      border-color: #FFD700;
    }

    .event-nav-btn:hover:not(.active) {
      background: #3a3a3a;
      color: #FFD700;
    }

    .event-view {
      display: none;
    }

    .event-view.active {
      display: block;
    }
    
    .events-container {
      display: grid;
      gap: 20px;
    }

    event-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid #FFD700;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    
    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
    }

    .event-card.tournament { border-left-color: #FF6B35; }
    .event-card.game_night { border-left-color: #4ECDC4; }
    .event-card.special { border-left-color: #FFD700; }
    .event-card.birthday { border-left-color: #FF69B4; }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .event-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #FFD700;
    }

    .event-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-tournament { background: #FF6B35; color: white; }
    .badge-game_night { background: #4ECDC4; color: #1a1a1a; }
    .badge-special { background: #FFD700; color: #1a1a1a; }
    .badge-birthday { background: #FF69B4; color: white; }

    .event-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .event-detail {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #cccccc;
      font-size: 0.9rem;
    }

    .event-detail-icon {
      color: #FFD700;
      font-size: 1.1rem;
    }

    .event-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .capacity-bar {
      width: 100%;
      height: 25px;
      background: #1a1a1a;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
      position: relative;
    }

    .capacity-fill {
      height: 100%;
      background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
      transition: width 0.3s ease;
    }

    .capacity-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      border: 2px solid #FFD700;
    }

    .modal-close {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #FFD700;
      cursor: pointer;
    }

    .modal-close:hover {
      color: #FFA500;
    }

    .attendee-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .attendee-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .attendee-email {
      color: #ffffff;
      font-weight: 500;
    }

    .attendee-status {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-attended { background: #00ff88; color: #1a1a1a; }
    .status-registered { background: #FFD700; color: #1a1a1a; }


    .fc {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      border: 1px solid #444;
      overflow: hidden;
    }

    .fc-header-toolbar {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      padding: 20px 25px !important;
      border-bottom: 3px solid #FFD700;
      margin-bottom: 0 !important;
    }

    .fc-toolbar-title {
      color: #1a1a1a !important;
      font-weight: 800 !important;
      font-size: 1.8rem !important;
    }

    .fc-button {
      background: #1a1a1a !important;
      border: 2px solid #FFD700 !important;
      color: #FFD700 !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      padding: 8px 16px !important;
      transition: all 0.3s ease !important;
    }

    .fc-button:hover {
      background: #FFD700 !important;
      color: #1a1a1a !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3) !important;
    }

    .fc-button-active {
      background: #FFD700 !important;
      color: #1a1a1a !important;
    }

    .fc-view-harness {
      background: #1a1a1a;
    }

    .fc-day {
      background: #2a2a2a !important;
      border-color: #444 !important;
      transition: all 0.3s ease;
    }

    .fc-day:hover {
      background: #3a3a3a !important;
    }

    .fc-day-today {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
      color: #1a1a1a !important;
      font-weight: 800 !important;
    }

    .fc-col-header {
      background: #2a2a2a !important;
      border-bottom: 2px solid #FFD700 !important;
    }

    .fc-col-header-cell-cushion {
      color: #FFD700 !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 1px !important;
      padding: 15px 0 !important;
    }

    .fc-daygrid-day-number {
      color: #ffffff !important;
      font-weight: 700 !important;
      padding: 8px !important;
    }

    .fc-event {
      border: none !important;
      border-radius: 6px !important;
      padding: 3px 6px !important;
      margin: 2px !important;
      font-weight: 600 !important;
      font-size: 0.75rem !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      border-left: 3px solid transparent !important;
    }

    .fc-event:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }

    .fc-event.tournament {
      background: linear-gradient(135deg, #FF6B35 0%, #FF4757 100%) !important;
      color: white !important;
      border-left-color: #FF6B35 !important;
    }

    .fc-event.game_night {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%) !important;
      color: #1a1a1a !important;
      border-left-color: #4ECDC4 !important;
    }

    .fc-event.special {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%) !important;
      color: white !important;
      border-left-color: #8B5CF6 !important;
    }

    .fc-event.birthday {
      background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%) !important;
      color: white !important;
      border-left-color: #FF69B4 !important;
    }

    .fc-more-link {
      color: #FFD700 !important;
      font-weight: 600 !important;
      background: #666 !important;
      border-radius: 4px !important;
      padding: 2px 6px !important;
      margin: 1px !important;
    }

    .fc-more-link:hover {
      background: #FFD700 !important;
      color: #1a1a1a !important;
    }

    /* Hide time display in calendar events */
    .fc-event-time {
      display: none !important;
    }

    /* Make sure only title shows */
    .fc-event-title {
      display: block !important;
      font-weight: 600 !important;
    }


    /* Make events expand on hover to show full content */
    .fc-event:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      z-index: 999 !important;
      overflow: visible !important;
      white-space: normal !important;
    }

        fc-list-view {
      background: #1a1a1a !important;
    }

    .fc-list-day-cushion {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%) !important;
      color: #FFD700 !important;
      font-weight: 700 !important;
      border-bottom: 2px solid #FFD700 !important;
    }

    .fc-list-event {
      background: #2a2a2a !important;
      border-left: 4px solid #FFD700 !important;
    }

    .fc-list-event:hover {
      background: #3a3a3a !important;
    }

    .fc-list-event-time {
      color: #FFD700 !important;
      font-weight: 600 !important;
    }

    .fc-list-event-title {
      color: #ffffff !important;
      font-weight: 600 !important;
    }

    /* List view event type colors */
    .fc-list-event.tournament {
      border-left-color: #FF6B35 !important;
    }

    .fc-list-event.game_night {
      border-left-color: #4ECDC4 !important;
    }

    .fc-list-event.special {
      border-left-color: #8B5CF6 !important;
    }

    .fc-list-event.birthday {
      border-left-color: #FF69B4 !important;
    }
    
 </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1><span class="logo"></span>SideQuest Mail Dashboard</h1>
      <p>Subscriber Management & Analytics Hub</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-value" id="totalSubscribers">-</div>
        <div class="stat-label">Total Subscribers</div>
      </div>
      <div class="stat-card success">
        <div class="stat-value" id="todaySignups">-</div>
        <div class="stat-label">Today's Signups</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-value" id="thisWeekSignups">-</div>
        <div class="stat-label">This Week</div>
      </div>
      <div class="stat-card info">
        <div class="stat-value" id="brevoSyncStatus">⏳</div>
        <div class="stat-label">Brevo Sync</div>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-grid">
      <!-- Main Content -->
      <div class="main-content">
        <div class="card">
          <!-- Tabs -->
          <div class="tabs">
            <div class="tab active" data-tab="subscribers">👥 Subscribers</div>
            <div class="tab" data-tab="analytics">📊 Analytics</div>
            <div class="tab" data-tab="tools">🛠️ Tools</div>
            <div class="tab" data-tab="campaigns">📧 Campaigns</div>
            <div class="tab" data-tab="events">🎮 Events</div>
          </div>

          <!-- Subscribers Tab -->
          <div class="tab-content active" id="subscribers">
            <div class="card-header">
              <h3 class="card-title">Subscriber Management</h3>
              <div>
                <button class="btn btn-primary btn-sm" onclick="refreshSubscribers()">🔄 Refresh</button>
                <button class="btn btn-success btn-sm" onclick="exportCSV()">📤 Export</button>
              </div>
            </div>

            <!-- Search -->
            <div class="search-box">
              <input type="text" class="search-input" id="searchInput" placeholder="Search subscribers...">
              <span class="search-icon">🔍</span>
            </div>

            <!-- Add Subscriber -->
            <div class="form-group">
              <label class="form-label">Add New Subscriber</label>
              <div style="display: flex; gap: 12px;">
                <input type="email" class="form-input" id="newSubscriberEmail" placeholder="Enter email address">
                <button class="btn btn-primary" onclick="addSubscriber()">Add</button>
              </div>
            </div>

            <!-- Subscriber List -->
            <div class="subscriber-list" id="subscriberList">
              <div style="text-align: center; padding: 50px; color: #aaaaaa;">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Loading subscribers...</p>
              </div>
            </div>
          </div>

          <!-- Analytics Tab -->
          <div class="tab-content" id="analytics">
            <div class="card-header">
              <h3 class="card-title">Subscriber Analytics</h3>
            </div>
            
            <div class="form-group">
              <label class="form-label">Growth Chart (Last 30 Days)</label>
              <div class="chart-container">
                <canvas id="growthChart"></canvas>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Signup Sources</label>
              <div class="source-stats">
                <div class="source-stat">
                  <div class="source-stat-value" id="webSignups">-</div>
                  <div class="source-stat-label">Web Signups</div>
                </div>
                <div class="source-stat">
                  <div class="source-stat-value" id="manualSignups">-</div>
                  <div class="source-stat-label">Manual Adds</div>
                </div>
                <div class="source-stat">
                  <div class="source-stat-value" id="importSignups">-</div>
                  <div class="source-stat-label">Imports</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tools Tab -->
          <div class="tab-content" id="tools">
            <div class="card-header">
              <h3 class="card-title">Admin Tools</h3>
            </div>

            <div class="form-group">
              <label class="form-label">Bulk Import Subscribers</label>
              <textarea class="form-textarea" id="bulkEmails" placeholder="Enter emails, one per line:&#10;user1@example.com&#10;user2@example.com&#10;user3@example.com" rows="5"></textarea>
              <button class="btn btn-primary mt-20" onclick="bulkImport()">📥 Import Subscribers</button>
            </div>

            <div class="form-group">
              <label class="form-label">Generate QR Code</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="qrUrl" placeholder="Enter signup URL" value="http://localhost:4000/signup">
                <button class="btn btn-primary" onclick="generateQR()">Generate QR</button>
              </div>
              <div class="qr-display" id="qrDisplay" style="display: none;">
                <canvas id="qrCanvas"></canvas>
                <p style="margin-top: 15px; color: #aaaaaa;">Right-click to save QR code</p>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Data Management</label>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="backupData()">💾 Backup Data</button>
                <button class="btn btn-primary" onclick="manualBrevoSync()">🔄 Sync Brevo</button>
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
              </div>
            </div>
          </div>

          <!-- Campaigns Tab -->
          <div class="tab-content" id="campaigns">
            <div class="card-header">
              <h3 class="card-title">Send Campaign</h3>
            </div>

            <div class="form-group">
              <label class="form-label">Campaign Subject</label>
              <input type="text" class="form-input" id="campaignSubject" placeholder="Enter email subject">
            </div>

            <div class="form-group">
              <label class="form-label">From Name</label>
              <input type="text" class="form-input" id="fromName" value="SideQuest Mail" placeholder="Sender name">
            </div>

            <div class="form-group">
              <label class="form-label">Email Content (HTML)</label>
              <textarea class="form-textarea" id="campaignBody" placeholder="Enter your email content in HTML format..." rows="8"></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Recipients</label>
              <p style="color: #aaaaaa; font-size: 14px; margin-bottom: 15px;">
                Campaign will be sent to all <span id="campaignRecipientCount">0</span> active subscribers
              </p>
              <button class="btn btn-primary" onclick="sendCampaign()">📧 Send Campaign</button>
            </div>
          </div>

          <!-- Events Tab -->
          <div class="tab-content" id="events"> 
            <div class="event-nav">
              <button class="event-nav-btn active" data-view="list">📋 Event List</button>
              <button class="event-nav-btn" data-view="calendar">📅 Calendar View</button>
              <button class="event-nav-btn" data-view="create">➕ Create Event</button>
              <button class="event-nav-btn" data-view="stats">📊 Statistics</button>
            </div>

            <!--Events List View-->
            <div class="event-view active" id="event-list-view">
              <div class="card-header">
                <h3 class="card-title">Upcoming Events</h3>
                <div>
                  <select id="eventTypeFilter" class="form-select" style="width: 150px; display: inline-block;">
                    <option value="all">All Types</option>
                    <option value="tournament">Tournaments</option>
                    <option value="game_night">Game Nights</option>
                    <option value="special">Special Events</option>
                    <option value="birthday">Birthdays</option>
                  </select>
                  <button class="btn btn-primary btn-sm" onclick="loadEvents()">🔄 Refresh</button>
                </div>
              </div>

              <div id="eventsList" class="events-container">
                <div style="text-align: center; padding: 50px; color: #aaaaaa;">
                  <div class="spinner"></div>
                  <p style="margin-top: 15px;">Loading events...</p>
                </div>
              </div>
            </div> 

            <!-- Replace the calendar view section -->
            <div class="event-view" id="event-calendar-view">
              <div class="card-header">
                <h3 class="card-title">Event Calendar</h3>
                <button class="btn btn-primary btn-sm" onclick="refreshCalendar()">🔄 Refresh</button>
              </div>
              
              <!-- FullCalendar Container -->
              <div id="fullCalendar" style="padding: 20px;"></div>
            </div>
            
            <!-- Create Event View -->
            <div class="event-view" id="event-create-view">
              <div class="card-header">
                <h3 class="card-title">Create New Event</h3>
              </div> 

              <form id="createEventForm">
                <div class="form-group">
                  <label class="form-label">Event Title*</label>
                  <input type="text" class="form-input" id="eventTitle" placeholder="e.g Valorant Friday Night Tournament">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div class="form-group">
                    <label class="form-label">Event Type*</label>
                    <select class=""form-select" id="eventType" required>
                      <option value="">Select Type*</option>
                      <option value="tournament">Tournament</option>
                      <option value="game_night">Game Night</option>
                      <option value="special">Special Event</option>
                      <option value="birthday">Birthday</option>
                    </select>
                  </div> 
                  
                  <div class="form-group">
                    <label class="form-label">Game Title</label>
                    <input type="text" class="form-input" id="gameTitle" placeholder="e.g Valorant, Fortnite">
                  </div>  
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div class="form-group">
                    <label class="form-label">Start Date & Time*</label>
                    <input type="datetime-local" class="form-input" id="eventDateTime" required>
                  </div>
                  
                  <div class="form-group>
                    <label class="form-label">End Date & Time*</label>
                    <input type="datetime-local" class="form-input" id="eventEndTime">
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div class="form-group">
                    <label class="form-label">Capacity</label>
                    <input type="number" class="form-input" id="eventCapacity" min="0" placeholder="0 (Unlimited)">
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Entry Fee (£)</label>
                    <input type="text" class="form-input" id="eventFee" min="0" step="0.01" placeholder="0.00 (Free)">
                  </div>  

                  <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="eventStatus">
                      <option value="draft">Upcoming</option>
                      <option value="published">Completed</option>
                    </select>
                  </div>    
                </div>

                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea class="form-textarea" id="eventDescription" rows="4" placeholder="Event details, rules, what to bring..."></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">Prize Pool (JSON format)</label>
                  <input type="text" class="form-input" id="eventPrizes" placeholder='{"1st": "£100", "2nd": "£50", "3rd": "£25"}'>
                </div>

                <div class="form-group">
                  <label class="form-label">Requirements</label>
                  <input type="text" class="form-input" id="eventRequirements" placeholder="e.g., Bring your own controller">
                </div>

                <div style="display: flex; gap: 12px;">
                  <button type="submit" class="btn btn-primary">🎮 Create Event</button>
                  <button type="button" class="btn btn-secondary" onclick="resetEventForm()">Clear Form</button>
                </div>
              </form>
            </div>
            
            <!-- Event Statistics View -->
            <div class="event-view" id="event-stats-view">
              <div class="card-header">
                <h3 class="card-title">Event Statistics</h3>
              </div>
              
              <div class="stats-grid" style ="margin-top: 30px;">
                <div class="stat-card primary">
                  <div class="stat-value" id="totalEvents">-</div>
                  <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card success">
                  <div class="stat-value" id="upcomingEvents">-</div>
                  <div class="stat-label">Upcoming Events</div>
                </div>
                <div class="stat-card warning">
                  <div class="stat-value" id="totalEventRegistrations">-</div>
                  <div class="stat-label>Total Registrations</div>
                </div>
                <div class="stat-card info">
                  <div class="stat-value" id="avgCapacityFilled">-%</div>
                  <div class="stat-label">Avg Capacity Fillled</div> 
                </div>
              </div>
              
              <div class="chart-header">
                <h3 class="card-title">Popular Events</h3>
              </div>
              <div id="popularEventsList">
                <p class="text-muted text-center">Loading Statistics...</p>
              </div>
            </div>
          </div> 
          <div id="eventModal" class="modal" style="display: none;">
             <div class="modal-content">
                <span class="modal-close" onclick="closeEventModal()">&times;</span>
                <h2 id="modalEventTitle"></h2>
                <div id="modalEventContent"></div>
              </div>
            </div>
          </div>    
        </div>
      </div>  

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <a href="https://app.brevo.com" target="_blank" class="btn btn-primary">
              🚀 Open Brevo Dashboard
            </a>
            <button class="btn btn-success" onclick="window.open('/signup', '_blank')">
              👁️ Preview Signup Page
            </button>
            <button class="btn btn-secondary" onclick="manualBrevoSync()">
              🔄 Manual Brevo Sync
            </button>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Activity</h3>
          </div>
          <div id="activityLog">
            <div style="text-align: center; padding: 30px; color: #aaaaaa;">
              <div class="spinner"></div>
              <p style="margin-top: 15px;">Loading activity...</p>
            </div>
          </div>
        </div>

        <!-- System Status -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">System Status</h3>
          </div>
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #ffffff;">Backend Server</span>
              <span class="text-success" id="serverStatus">⏳ Checking...</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #ffffff;">Brevo API</span>
              <span class="text-success" id="brevoStatus">⏳ Checking...</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #ffffff;">Last Activity</span>
              <span class="text-muted" id="lastActivity">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <script>
    // Configuration
    const API_BASE = 'https://sidequest-newsletter-production.up.railway.app';
    

    let calendar;

    // Initialize FullCalendar
    function initFullCalendar() {
      const calendarEl = document.getElementById('fullCalendar');
      
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listWeek'
        },
        height: 'auto',
        events: loadCalendarEvents,
        
        // Event styling based on type
        eventDidMount: function(info) {
          const eventType = info.event.extendedProps.event_type || 'default';
          info.el.classList.add(eventType);
        },
        
        dateClick: function(info) {
        // Pre-fill the date in create form
        const selectedDate = info.dateStr + 'T18:00'; // Format: 2025-08-22T18:00
        
        // Switch to events tab first
        document.querySelector('.tab[data-tab="events"]').click();
        
        // Small delay to ensure tab loads, then switch to create view and set date
        setTimeout(() => {
          switchEventView('create');

              // Set the date after view loads
              setTimeout(() => {
                const dateInput = document.getElementById('eventDateTime');
                if (dateInput) {
                  dateInput.value = selectedDate;
                  console.log('Date set to:', selectedDate); // For debugging
                } else {
                  console.error('eventDateTime input not found');
                }
              }, 100);
            }, 100);
        },

        // Add hover tooltips to your FullCalendar config
        eventDidMount: function(info) {
          const eventType = info.event.extendedProps.event_type || 'default';
          info.el.classList.add(eventType);
          
          // Add tooltip on hover
          info.el.setAttribute('title', `${info.event.title}\n${info.event.start.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`);
          
          // Better hover popup
          info.el.addEventListener('mouseenter', function() {
            // Create custom tooltip
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
              position: absolute;
              background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
              color: white;
              padding: 10px 15px;
              border-radius: 8px;
              border: 2px solid #FFD700;
              font-size: 12px;
              font-weight: 600;
              z-index: 9999;
              box-shadow: 0 8px 25px rgba(0,0,0,0.3);
              pointer-events: none;
              max-width: 200px;
            `;
            tooltip.textContent = info.event.title;
            tooltip.id = 'event-tooltip';
            document.body.appendChild(tooltip);
            
            // Position tooltip
            const rect = info.el.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
          });
          
          info.el.addEventListener('mouseleave', function() {
            const tooltip = document.getElementById('event-tooltip');
            if (tooltip) tooltip.remove();
          });
        },
        
        // Click event to view details
        eventClick: function(info) {
          showEventDetails(info.event.id);
        },
        
        dayMaxEvents: 3,
        moreLinkClick: 'popover'
      });
      
      calendar.render();
    }

    // Load events from your backend
    async function loadCalendarEvents(fetchInfo, successCallback, failureCallback) {
      try {
        // Add date range to ensure we get all events in the visible timeframe
        const start = fetchInfo.start.toISOString().split('T')[0];
        const end = fetchInfo.end.toISOString().split('T')[0];
        
        console.log('Loading events from', start, 'to', end); // Debug
        
        const response = await fetch(`${API_BASE}/api/events/calendar?start=${start}&end=${end}`);
        const data = await response.json();
        
        if (data.success) {
          console.log('Total events loaded:', data.events.length); // Debug
          
          const events = data.events.map(event => ({
            id: event.id,
            title: event.title,
            start: event.start || event.date_time,
            end: event.end || event.end_time,
            backgroundColor: event.color,
            borderColor: event.color,
            textColor: getTextColor(event.event_type),
            extendedProps: {
              event_type: event.event_type,
              game_title: event.game_title,
              description: event.description
            }
          }));
          
          successCallback(events);
        } else {
          failureCallback(data.error);
        }
      } catch (error) {
        console.error('Error loading calendar events:', error);
        failureCallback(error);
      }
    }

    // Get text color based on event type
    function getTextColor(eventType) {
      switch(eventType) {
        case 'tournament':
        case 'special':
        case 'birthday':
          return 'white';
        case 'game_night':
        default:
          return '#1a1a1a';
      }
    }

    // Event variables
    let currentEvents = [];
    let currentEditingEventId = null;

    // Initialize event management
    function initializeEventManagement() {
      // Setup event navigation
      document.querySelectorAll('.event-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const view = this.dataset.view;
          switchEventView(view);
        });
      });

      // Setup create event form
      const createEventForm = document.getElementById('createEventForm');
      if (createEventForm) {
        createEventForm.addEventListener('submit', handleCreateEvent);
      }

      // Set default datetime to tomorrow at 7pm
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(19, 0, 0, 0);
      const dateInput = document.getElementById('eventDateTime');
      if (dateInput) {
        dateInput.value = tomorrow.toISOString().slice(0, 16);
      }
    }

  function switchEventView(view) {
    // Update navigation buttons
    document.querySelectorAll('.event-nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`.event-nav-btn[data-view="${view}"]`).classList.add('active');

    // Update views
    document.querySelectorAll('.event-view').forEach(v => {
      v.classList.remove('active');
    });
    document.getElementById(`event-${view}-view`).classList.add('active');

    // If switching to create view and NOT in edit mode, reset everything
    if (view === 'create' && !currentEditingEventId) {
      resetCreateFormUI();
      resetEventForm();
    }

    // Load appropriate data
    switch(view) {
      case 'list':
        loadEvents();
        break;
      case 'calendar':
        loadCalendarView();
        break;
      case 'stats':
        loadEventStats();
        break;
    }
  }

    // Load events list
    async function loadEvents() {
      try {
        const typeFilter = document.getElementById('eventTypeFilter')?.value || 'all';
        
        // Show all events (both draft and published) in admin dashboard
        const response = await fetch(`${API_BASE}/api/events?type=${typeFilter}&upcoming=true`);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (data.success) {
          currentEvents = data.events;
          renderEventsList(data.events);
        } else {
          console.error('API returned error:', data.error);
          document.getElementById('eventsList').innerHTML = '<p class="text-danger">Failed to load events: ' + (data.error || 'Unknown error') + '</p>';
        }
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('eventsList').innerHTML = '<p class="text-danger">Failed to load events: ' + error.message + '</p>';
      }
    }

    // Render events list
    function renderEventsList(events) {
      const container = document.getElementById('eventsList');
      
      if (!events || events.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No upcoming events</p>';
        return;
      }

      container.innerHTML = events.map(event => {
        const eventDate = new Date(event.date_time);
        const capacityPercent = event.capacity > 0 ? (event.registration_count / event.capacity * 100) : 0;
        const spotsText = event.capacity > 0 ? `${event.spots_available} spots left` : 'Unlimited spots';
        
        return `
          <div class="event-card ${event.event_type}" onclick="showEventDetails(${event.id})">
            <div class="event-header">
              <div>
                <div class="event-title">${event.title}</div>
                ${event.game_title ? `<div style="color: #aaa; font-size: 0.9rem;">${event.game_title}</div>` : ''}
              </div>
              <span class="event-badge badge-${event.event_type}">${event.event_type.replace('_', ' ')}</span>
            </div>
            
            <div class="event-details">
              <div class="event-detail">
                <span class="event-detail-icon">📅</span>
                <span>${eventDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}</span>
              </div>
              <div class="event-detail">
                <span class="event-detail-icon">🕐</span>
                <span>${eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
              </div>
              <div class="event-detail">
                <span class="event-detail-icon">👥</span>
                <span>${event.registration_count} registered</span>
              </div>
              ${event.entry_fee > 0 ? `
                <div class="event-detail">
                  <span class="event-detail-icon">💰</span>
                  <span>£${event.entry_fee}</span>
                </div>
              ` : ''}
            </div>
            
            ${event.capacity > 0 ? `
              <div class="capacity-bar">
                <div class="capacity-fill" style="width: ${capacityPercent}%"></div>
                <span class="capacity-text">${spotsText}</span>
              </div>
            ` : ''}
            
            <div class="event-actions">
              <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); quickRegister(${event.id})">
                Quick Register Subscriber
              </button>
              <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editEvent(${event.id})">
                Edit
              </button>
              <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); viewAttendees(${event.id})">
                View Attendees
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Create new event
    async function handleCreateEvent(e) {
      e.preventDefault();
      
      // Prevent double submission
      if (e.target.dataset.submitting === 'true') return;
      e.target.dataset.submitting = 'true';
      
      try {
        const eventData = {
          title: document.getElementById('eventTitle').value,
          event_type: document.getElementById('eventType').value,
          game_title: document.getElementById('gameTitle').value,
          date_time: document.getElementById('eventDateTime').value,
          end_time: document.getElementById('eventEndTime').value,
          capacity: parseInt(document.getElementById('eventCapacity').value) || 0,
          entry_fee: parseFloat(document.getElementById('eventFee').value) || 0,
          status: document.getElementById('eventStatus').value,
          description: document.getElementById('eventDescription').value,
          prize_pool: document.getElementById('eventPrizes').value,
          requirements: document.getElementById('eventRequirements').value
        };

        let response;
        
        if (currentEditingEventId) {
          // Update existing event
          console.log('Updating event:', currentEditingEventId);
          response = await fetch(`${API_BASE}/api/events/${currentEditingEventId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
          });
        } else {
          // Create new event
          console.log('Creating new event');
          response = await fetch(`${API_BASE}/api/events`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
          });
        }

        const data = await response.json();
        
        if (data.success) {
          const action = currentEditingEventId ? 'updated' : 'created';
          showSuccess(`Event ${action} successfully!`);
          
          // Reset edit state and form
          currentEditingEventId = null;
          resetCreateFormUI();
          resetEventForm();
          switchEventView('list');
          
          // If published, offer to send announcement (only for new events)
          if (!currentEditingEventId && eventData.status === 'published') {
            if (confirm('Would you like to send an announcement email to all subscribers?')) {
              sendEventAnnouncement(data.event_id);
            }
          }
        } else {
          alert('Error: ' + (data.error || `Failed to ${currentEditingEventId ? 'update' : 'create'} event`));
        }
      } catch (error) {
        console.error(`Error ${currentEditingEventId ? 'updating' : 'creating'} event:`, error);
        alert(`Failed to ${currentEditingEventId ? 'update' : 'create'} event`);
      } finally {
        e.target.dataset.submitting = 'false';
      }
    }

    // Quick register subscriber to event
    // Also enhance the quickRegister function to refresh attendees after registration:
    async function quickRegister(eventId) {
      const email = prompt('Enter subscriber email to register:');
      if (!email) return;

      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email.trim().toLowerCase() })
        });

        const data = await response.json();
        
        if (data.success) {
          showSuccess(`✅ Registered ${email} - Confirmation: ${data.confirmation_code}`);
          loadEvents(); // Refresh the events list
          
          // Refresh attendees modal if it's open
          const modal = document.getElementById('eventModal');
          if (modal && modal.style.display === 'flex') {
            setTimeout(() => viewAttendees(eventId), 500);
          }
        } else {
          alert('❌ Error: ' + (data.error || 'Failed to register'));
        }
      } catch (error) {
        console.error('Error registering:', error);
        alert('❌ Failed to register: ' + error.message);
      }
    }

    // View event attendees
    async function viewAttendees(eventId) {
      console.log(`Attempting to view attendees for event ${eventId}`);
      
      try {
        // Show loading in modal immediately
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = 'Loading Attendees...';
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 50px;">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #aaa;">Loading attendee list...</p>
          </div>
        `;
        modal.style.display = 'flex';
        
        // First, let's debug what's happening
        console.log(`Making request to: ${API_BASE}/api/events/${eventId}/attendees`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/attendees`);
        
        console.log(`Response status: ${response.status}`);
        console.log(`Response ok: ${response.ok}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Attendees response data:', data);
        
        if (data.success) {
          const event = currentEvents.find(e => e.id === eventId);
          const eventTitle = event ? event.title : data.event_title || `Event ${eventId}`;
          
          showAttendeesModal({ 
            id: eventId, 
            title: eventTitle 
          }, data.attendees);
          
          console.log(`Successfully loaded ${data.attendees.length} attendees`);
        } else {
          throw new Error(data.error || 'Failed to load attendees');
        }
        
      } catch (error) {
        console.error('Error loading attendees:', error);
        
        // Show error in modal
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = 'Error Loading Attendees';
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ff6b35;">
            <p>❌ Failed to load attendees</p>
            <p style="font-size: 0.9rem; color: #aaa; margin-top: 10px;">
              Error: ${error.message}
            </p>
            <button class="btn btn-primary mt-20" onclick="debugEventRegistrations(${eventId})">
              🔍 Debug Event Data
            </button>
            <button class="btn btn-secondary mt-20" onclick="closeEventModal()">
              Close
            </button>
          </div>
        `;
        modal.style.display = 'flex';
      }
    }
    


    // Load event statistics
    async function loadEventStats() {
      try {
        const response = await fetch(`${API_BASE}/api/events/stats`);
        const data = await response.json();
        
        if (data.success) {
          // Update stat cards
          document.getElementById('totalEvents').textContent = data.stats.total_events;
          document.getElementById('upcomingEvents').textContent = data.stats.upcoming_events;
          document.getElementById('totalEventRegistrations').textContent = data.stats.total_registrations;
          document.getElementById('avgCapacityFilled').textContent = data.stats.avg_capacity_filled + '%';
          
          // Render popular events
          const popularList = document.getElementById('popularEventsList');
          if (data.popular_events && data.popular_events.length > 0) {
            popularList.innerHTML = data.popular_events.map((event, index) => `
              <div style="display: flex; justify-content: space-between; padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 10px;">
                <div>
                  <span style="color: #FFD700; font-weight: 700;">#${index + 1}</span>
                  <span style="margin-left: 10px; color: #fff;">${event.title}</span>
                </div>
                <div>
                  <span class="event-badge badge-${event.event_type}" style="margin-right: 10px;">${event.event_type.replace('_', ' ')}</span>
                  <span style="color: #FFD700; font-weight: 600;">${event.registration_count} registrations</span>
                </div>
              </div>
            `).join('');
          } else {
            popularList.innerHTML = '<p class="text-muted text-center">No events data yet</p>';
          }
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Add debug function to test what's in the database:
    async function debugEventRegistrations(eventId) {
      try {
        console.log(`Debugging event ${eventId}...`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/debug`);
        const data = await response.json();
        
        console.log('Debug data:', data);
        
        alert(`Debug Results for Event ${eventId}:
        
    Event Exists: ${data.event_exists}
    Registration Count: ${data.registration_count}
    All Event Registrations: ${JSON.stringify(data.all_event_registrations, null, 2)}

    Check console for full details.`);
        
      } catch (error) {
        console.error('Debug error:', error);
        alert('Debug failed: ' + error.message);
      }
    }

    // Add refresh function:
    async function refreshAttendees(eventId) {
      await viewAttendees(eventId);
    }

    // Add refresh function:
    async function refreshAttendees(eventId) {
      await viewAttendees(eventId);
    }

    // Search and filter functions for attendees
    function filterAttendees() {
      const searchTerm = document.getElementById('attendeeSearch').value.toLowerCase();
      const attendeeItems = document.querySelectorAll('.attendee-item');
      const noResults = document.getElementById('noResults');
      let visibleCount = 0;
      
      attendeeItems.forEach(item => {
        const email = item.dataset.email || '';
        const name = item.dataset.name || '';
        const code = item.dataset.code || '';
        
        const matches = email.includes(searchTerm) || 
                       name.includes(searchTerm) || 
                       code.includes(searchTerm);
        
        if (matches) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Show/hide "no results" message
      if (visibleCount === 0 && searchTerm.length > 0) {
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
      }
    }
    
    function filterByStatus(status) {
      const attendeeItems = document.querySelectorAll('.attendee-item');
      const searchInput = document.getElementById('attendeeSearch');
      const noResults = document.getElementById('noResults');
      let visibleCount = 0;
      
      // Clear search when using status filter
      searchInput.value = '';
      
      attendeeItems.forEach(item => {
        const itemStatus = item.dataset.status;
        
        if (status === 'all' || itemStatus === status) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Update filter button states
      setActiveFilter(status);
      
      // Show/hide "no results" message
      if (visibleCount === 0) {
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
      }
    }
    
    function setActiveFilter(activeStatus) {
      // Remove active class from all filter buttons
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      });
      
      // Add active class to selected filter
      const activeBtn = document.getElementById(`filter-${activeStatus}`);
      if (activeBtn) {
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
      }
    }
    
    function clearSearch() {
      document.getElementById('attendeeSearch').value = '';
      filterByStatus('all');
    }

    // Check in attendee function
    async function checkinAttendee(eventId, email) {
      try {
        console.log(`🔍 Attempting check-in for Event ${eventId}, Email: ${email}`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/checkin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        });

        console.log(`📡 Response status: ${response.status}`);
        
        const data = await response.json();
        console.log('📡 Response data:', data);
        
        if (data.success) {
          showSuccess(`✅ Checked in ${email} - Code: ${data.confirmation_code}`);
          // Refresh the attendees modal
          setTimeout(() => viewAttendees(eventId), 500);
        } else {
          console.error('❌ Check-in failed:', data.error);
          alert('❌ Check-in failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('❌ Network error during check-in:', error);
        alert('❌ Network error: ' + error.message);
      }
    }

    // Show attendees modal
    function showAttendeesModal(event, attendees) {
      console.log('Showing attendees modal for:', event.title, 'with', attendees.length, 'attendees');
      
      const modal = document.getElementById('eventModal');
      const modalTitle = document.getElementById('modalEventTitle');
      const modalContent = document.getElementById('modalEventContent');
      
      modalTitle.textContent = `👥 Attendees: ${event.title}`;
      
      let content = `
        <div style="margin-bottom: 20px;">
          <p><strong>Total Registered:</strong> ${attendees.length}</p>
          <p><strong>Attended:</strong> ${attendees.filter(a => a.attended).length}</p>
        </div>
      `;
      
      if (attendees.length === 0) {
        content += `
          <div style="text-align: center; padding: 40px; color: #aaa;">
            <p>📭 No registrations yet</p>
            <button class="btn btn-primary mt-20" onclick="quickRegister(${event.id})">
              Add First Registration
            </button>
          </div>
        `;
      } else {
        // Add search/filter box
        content += `
          <div style="margin-bottom: 20px;">
            <div style="position: relative;">
              <input type="text" id="attendeeSearch" class="form-input" 
                     placeholder="Search by email, name, or confirmation code..." 
                     style="padding-left: 50px; margin-bottom: 15px;"
                     oninput="filterAttendees()">
              <span style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #FFD700; font-size: 18px;">🔍</span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('all')" id="filter-all">All</button>
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('registered')" id="filter-registered">Not Checked In</button>
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('attended')" id="filter-attended">Checked In</button>
            </div>
          </div>
        `;
        
        content += '<div class="attendee-list" id="attendeeListContainer">';
        
        attendees.forEach((attendee, index) => {
          const statusClass = attendee.attended ? 'status-attended' : 'status-registered';
          const statusText = attendee.attended ? 'Attended' : 'Registered';
          const registeredDate = attendee.registered_at ? 
            new Date(attendee.registered_at).toLocaleDateString() : 'Unknown';
          
          content += `
            <div class="attendee-item" data-email="${attendee.subscriber_email.toLowerCase()}" 
                 data-name="${(attendee.player_name || '').toLowerCase()}" 
                 data-code="${attendee.confirmation_code.toLowerCase()}"
                 data-status="${attendee.attended ? 'attended' : 'registered'}"
                 data-index="${index}">
              <div>
                <div class="attendee-email">${attendee.subscriber_email}</div>
                <div style="color: #aaa; font-size: 0.8rem; margin-top: 5px;">
                  Player: ${attendee.player_name || 'Not specified'} | 
                  <strong style="color: #FFD700;">Code: ${attendee.confirmation_code}</strong> | 
                  Registered: ${registeredDate}
                </div>
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <span class="attendee-status ${statusClass}">${statusText}</span>
                ${!attendee.attended ? `
                  <button class="btn btn-success btn-sm" onclick="checkinAttendee(${event.id}, '${attendee.subscriber_email}')">
                    ✓ Check In
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        });
        
        content += '</div>';
        
        // Add "No results" message (hidden by default)
        content += `
          <div id="noResults" style="display: none; text-align: center; padding: 40px; color: #aaa;">
            <p>🔍 No attendees match your search</p>
            <button class="btn btn-secondary btn-sm" onclick="clearSearch()">Clear Search</button>
          </div>
        `;
      }
      
      // Add action buttons
      content += `
        <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #444;">
          <button class="btn btn-primary" onclick="quickRegister(${event.id})">
            ➕ Add Registration
          </button>
          <button class="btn btn-secondary" onclick="refreshAttendees(${event.id})">
            🔄 Refresh
          </button>
          <button class="btn btn-secondary" onclick="closeEventModal()">
            Close
          </button>
        </div>
      `;
      
      modalContent.innerHTML = content;
      modal.style.display = 'flex';
      
      // Set initial filter state
      setActiveFilter('all');
    }


    // Load calendar view
    function loadCalendarView() {
      setTimeout(() => {
        if (!calendar) {
          initFullCalendar();
        } else {
          calendar.refetchEvents();
        }
      }, 100);
    }

    // Form submission
    document.addEventListener('DOMContentLoaded', function() {
      const fcForm = document.getElementById('fcEventForm');
      if (fcForm) {
        fcForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const eventData = {
            title: document.getElementById('fcEventTitle').value,
            event_type: document.getElementById('fcEventType').value,
            game_title: document.getElementById('fcEventGame').value,
            date_time: document.getElementById('fcEventDate').value + 'T' + document.getElementById('fcEventTime').value,
            end_time: document.getElementById('fcEventDate').value + 'T' + document.getElementById('fcEventEndTime').value,
            description: document.getElementById('fcEventDescription').value,
            capacity: 0,
            entry_fee: 0,
            status: 'draft'
          };

          try {
            const response = await fetch(`${API_BASE}/api/events`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(eventData)
            });

            const data = await response.json();
            
            if (data.success) {
              closeFCModal();
              if (calendar) calendar.refetchEvents();
              showSuccess('Event created successfully!');
            } else {
              alert('Error: ' + (data.error || 'Failed to create event'));
            }
          } catch (error) {
            console.error('Error creating event:', error);
            alert('Failed to create event');
          }
        });
      }

      // Close modal when clicking outside
      const modal = document.getElementById('fcEventModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeFCModal();
          }
        });
      }
    });



    // Modal functions
    function closeFCModal() {
      document.getElementById('fcEventModal').style.display = 'none';
      document.getElementById('fcEventForm').reset();
    }

    function refreshCalendar() {
      if (calendar) {
        calendar.refetchEvents();
        showSuccess('Calendar refreshed!');
      }
    }

    // Simple calendar renderer
    function renderCalendar(events) {
      const calendarEl = document.getElementById('eventCalendar');
      
      // Group events by date
      const eventsByDate = {};
      events.forEach(event => {
        const date = new Date(event.start).toDateString();
        if (!eventsByDate[date]) {
          eventsByDate[date] = [];
        }
        eventsByDate[date].push(event);
      });
      
      // Render simple calendar view
      let html = '<div style="display: grid; gap: 20px;">';
      
      Object.keys(eventsByDate).sort().forEach(date => {
        const dateEvents = eventsByDate[date];
        const dateObj = new Date(date);
        
        html += `
          <div style="background: #2a2a2a; border-radius: 12px; padding: 20px; border-left: 4px solid #FFD700;">
            <h3 style="color: #FFD700; margin-bottom: 15px;">
              ${dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
            </h3>
            <div style="display: grid; gap: 10px;">
        `;
        
        dateEvents.forEach(event => {
          const startTime = new Date(event.start).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const endTime = event.end ? new Date(event.end).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
          
          html += `
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 3px solid ${event.color}; cursor: pointer;"
                onclick="showEventDetails(${event.id})">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <div style="color: #fff; font-weight: 600;">${event.title}</div>
                  <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                    🕐 ${startTime}${endTime ? ' - ' + endTime : ''}
                  </div>
                  ${event.description ? `<div style="color: #ccc; font-size: 0.85rem; margin-top: 5px;">👥 ${event.description}</div>` : ''}
                </div>
                <div style="width: 10px; height: 10px; background: ${event.color}; border-radius: 50%;"></div>
              </div>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      
      if (events.length === 0) {
        html = '<p class="text-muted text-center">No events scheduled</p>';
      }
      
      calendarEl.innerHTML = html;
    }

    // Show event details modal
    async function showEventDetails(eventId) {
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        const data = await response.json();
        
        if (data.success) {
          const event = data.event;
          const modal = document.getElementById('eventModal');
          
          document.getElementById('modalEventTitle').textContent = event.title;
          
          const eventDate = new Date(event.date_time);
          const endDate = event.end_time ? new Date(event.end_time) : null;
          
          let content = `
            <div style="display: grid; gap: 15px;">
              ${event.game_title ? `<p><strong>Game:</strong> ${event.game_title}</p>` : ''}
              <p><strong>Type:</strong> <span class="event-badge badge-${event.event_type}">${event.event_type.replace('_', ' ')}</span></p>
              <p><strong>Date:</strong> ${eventDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p><strong>Time:</strong> ${eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}${endDate ? ' - ' + endDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : ''}</p>
              ${event.entry_fee > 0 ? `<p><strong>Entry Fee:</strong> £${event.entry_fee}</p>` : ''}
              ${event.capacity > 0 ? `<p><strong>Capacity:</strong> ${event.registration_count}/${event.capacity} registered</p>` : `<p><strong>Registrations:</strong> ${event.registration_count}</p>`}
              ${event.description ? `<p><strong>Description:</strong><br>${event.description}</p>` : ''}
              ${event.prize_pool ? `<p><strong>Prizes:</strong><br>${event.prize_pool}</p>` : ''}
              ${event.requirements ? `<p><strong>Requirements:</strong><br>${event.requirements}</p>` : ''}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" onclick="viewAttendees(${event.id})">View Attendees</button>
              <button class="btn btn-secondary" onclick="editEvent(${event.id})">Edit Event</button>
              <button class="btn btn-danger" onclick="deleteEvent(${event.id})">Delete Event</button>
            </div>
          `;
          
          document.getElementById('modalEventContent').innerHTML = content;
          modal.style.display = 'flex';
        }
      } catch (error) {
        console.error('Error loading event details:', error);
        alert('Failed to load event details');
      }
    }

    // Modified editEvent function
    async function editEvent(eventId) {
      try {
        // Load event data
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        const data = await response.json();
        
        if (!data.success) {
          alert('Failed to load event data');
          return;
        }
        
        const event = data.event;
        currentEditingEventId = eventId; // Set global edit state

        switchEventView('create');

        // Fill form with event data
        fillFormWithEventData(event);
        
        // Update UI to show we're editing
        updateCreateFormForEdit(event.title);
        
        // Close the modal if it's open
        closeEventModal();
        
      } catch (error) {
        console.error('Error loading event for edit:', error);
        alert('Failed to load event data');
        currentEditingEventId = null; // Reset on error
      }
    }

    
    function updateCreateFormForEdit(eventTitle) {
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = `Edit Event: ${eventTitle}`;
        formTitle.style.color = '#FFD700';
      } else {
        console.warn('Form title element not found');
      }

        // Update submit button with error handling
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Update Event';
        submitButton.classList.add('btn-warning'); // Different style for update
        submitButton.classList.remove('btn-primary');
      } else {
        console.warn('Submit button not found');
      }
      
      // Add cancel button if it doesn't exist
      let cancelButton = document.getElementById('cancelEditButton');
      if (!cancelButton && submitButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'cancelEditButton';
        cancelButton.type = 'button';
        cancelButton.className = 'btn btn-secondary ms-2';
        cancelButton.innerHTML = '❌ Cancel Edit';
        cancelButton.onclick = cancelEdit;
        
        // Insert after submit button
        submitButton.parentNode.insertBefore(cancelButton, submitButton.nextSibling);
      }
    }

    // Delete event
    async function deleteEvent(eventId) {
      if (!confirm('Are you sure you want to delete this event?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showSuccess('Event deleted successfully');
          closeEventModal();
          loadEvents();
        } else {
          if (data.error.includes('registrations')) {
            if (confirm('This event has registrations. Delete anyway?')) {
              const forceResponse = await fetch(`${API_BASE}/api/events/${eventId}?force=true`, {
                method: 'DELETE'
              });
              const forceData = await forceResponse.json();
              if (forceData.success) {
                showSuccess('Event deleted successfully');
                closeEventModal();
                loadEvents();
              }
            }
          } else {
            alert('Error: ' + data.error);
          }
        }
      } catch (error) {
        console.error('Error deleting event:', error);
        alert('Failed to delete event');
      }
    }

    // Send event announcement email
    async function sendEventAnnouncement(eventId) {
      try {
        const eventResponse = await fetch(`${API_BASE}/api/events/${eventId}`);
        const eventData = await eventResponse.json();
        
        if (!eventData.success) return;
        
        const event = eventData.event;
        const eventDate = new Date(event.date_time);
        
        const subject = `New Event: ${event.title}`;
        const body = `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #FFD700;">🎮 New Event at SideQuest!</h1>
            <h2>${event.title}</h2>
            <p><strong>Date:</strong> ${eventDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
            <p><strong>Time:</strong> ${eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</p>
            ${event.game_title ? `<p><strong>Game:</strong> ${event.game_title}</p>` : ''}
            ${event.entry_fee > 0 ? `<p><strong>Entry Fee:</strong> £${event.entry_fee}</p>` : '<p><strong>Entry:</strong> FREE!</p>'}
            ${event.description ? `<p>${event.description}</p>` : ''}
            ${event.prize_pool ? `<p><strong>Prizes:</strong> ${event.prize_pool}</p>` : ''}
            <p style="margin-top: 30px;">
              <a href="${window.location.origin}/signup" style="background: #FFD700; color: #1a1a1a; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold;">
                Register Now
              </a>
            </p>
            <p style="color: #888; font-size: 12px; margin-top: 30px;">
              You're receiving this because you're subscribed to SideQuest Gaming Cafe updates.
            </p>
          </div>
        `;
        
        const response = await fetch(`${API_BASE}/send-campaign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            body,
            fromName: 'SideQuest Events',
            recipients: subscribers // Assuming subscribers array is available
          })
        });
        
        const data = await response.json();
        if (data.success) {
          showSuccess(`Event announcement sent to ${data.sent} subscribers!`);
        }
      } catch (error) {
        console.error('Error sending announcement:', error);
        alert('Failed to send announcement');
      }
    }

    // Close event modal
    function closeEventModal() {
      document.getElementById('eventModal').style.display = 'none';
    }

    // Reset event form
    function resetEventForm() {
      document.getElementById('createEventForm').reset();
      currentEditingEventId = null; // Reset edit state
      resetCreateFormUI(); // Reset UI
      
      // Set default datetime to tomorrow at 7pm
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(19, 0, 0, 0);
      const dateInput = document.getElementById('eventDateTime');
      if (dateInput) {
        dateInput.value = tomorrow.toISOString().slice(0, 16);
      }
    }

    // Call initialization when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Wait a bit to ensure main dashboard is initialized first
      setTimeout(() => {
        initializeEventManagement();
      }, 500);
    });

    function fillFormWithEventData(event) {
      const fields = {
        'eventTitle': event.title,
        'eventType': event.event_type,
        'gameTitle': event.game_title || '',
        'eventDateTime': event.date_time ? event.date_time.slice(0, 16) : '',
        'eventCapacity': event.capacity || 0,
        'eventFee': event.entry_fee || 0,
        'eventStatus': event.status,
        'eventDescription': event.description || '',
        'eventEndTime': event.end_time ? event.end_time.slice(0, 16) : '',
        'eventPrizes': event.prize_pool || '',
        'eventRequirements': event.requirements || ''
      };
      
      Object.entries(fields).forEach(([fieldId, value]) => {
        const element = document.getElementById(fieldId);
        if (element) {
          element.value = value;
        }
      });
    }

    function updateCreateFormForEdit(eventTitle) {
      // Update form title
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = `Edit Event: ${eventTitle}`;
        formTitle.style.color = '#ff6b35'; // Orange color to indicate edit mode
      }
      
      // Update submit button
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Update Event';
        submitButton.classList.add('btn-warning'); // Different style for update
        submitButton.classList.remove('btn-primary');
      }
      
      // Add cancel button if it doesn't exist
      addCancelButton(submitButton);
    }

    function addCancelButton(submitButton) {
      let cancelButton = document.getElementById('cancelEditButton');
      if (!cancelButton && submitButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'cancelEditButton';
        cancelButton.type = 'button';
        cancelButton.className = 'btn btn-secondary ms-2';
        cancelButton.innerHTML = '❌ Cancel Edit';
        cancelButton.onclick = cancelEdit;
        submitButton.parentNode.insertBefore(cancelButton, submitButton.nextSibling);
      }
    }

    function resetCreateFormUI() {
      // Reset form title
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = 'Create New Event';
        formTitle.style.color = '';
      }
      
      // Reset submit button
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Create Event';
        submitButton.classList.add('btn-primary');
        submitButton.classList.remove('btn-warning');
      }
      
      // Remove cancel button
      const cancelButton = document.getElementById('cancelEditButton');
      if (cancelButton) {
        cancelButton.remove();
      }
    }

    function cancelEdit() {
      currentEditingEventId = null;
      resetCreateFormUI();
      resetEventForm();
      switchEventView('list');
    }

    // Enhance existing tab functionality to load events
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          if (this.dataset.tab === 'events') {
            // Small delay to ensure tab is active
            setTimeout(() => {
              loadEvents();
            }, 100);
          }
        });
      });
    });

    
    // Global variables
    let subscribers = [];
    let subscriberDetails = [];
    let activityLog = [];
    let currentStats = {};
    let growthChart = null;
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initializing...');
      try {
        initializeTabs();
        loadInitialData();
        setupSearch();
        startAutoRefresh();
      } catch (error) {
        console.error('Dashboard initialization error:', error);
      }
    });

    // Tab functionality
    function initializeTabs() {
      try {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
              targetContent.classList.add('active');
            }
            
            // Update campaign recipient count when switching to campaigns tab
            if (targetTab === 'campaigns') {
              updateCampaignRecipientCount();
            }
            
            // Refresh chart when switching to analytics tab
            if (targetTab === 'analytics') {
              setTimeout(() => {
                if (document.getElementById('growthChart') && subscriberDetails.length > 0) {
                  initializeGrowthChart();
                }
              }, 100);
            }
          });
        });
      } catch (error) {
        console.error('Error initializing tabs:', error);
      }
    }

    // Load all initial data
    async function loadInitialData() {
      try {
        await Promise.all([
          loadSubscribers(),
          loadStats(),
          loadActivity(),
          checkHealth()
        ]);
      } catch (error) {
        console.error('Error loading initial data:', error);
      }
    }

    // Load subscribers from backend
    async function loadSubscribers() {
      try {
        showLoading('subscriberList');
        const response = await fetch(`${API_BASE}/subscribers`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          subscribers = data.subscribers || [];
          subscriberDetails = data.subscriber_details || [];
          currentStats = data.stats || {};
          
          renderSubscribers();
          updateStats();
          updateCampaignRecipientCount();
          
          // Initialize chart after data is loaded
          setTimeout(() => {
            if (document.getElementById('growthChart')) {
              initializeGrowthChart();
            }
          }, 100);
        } else {
          showError('subscriberList', 'Failed to load subscribers');
        }
      } catch (error) {
        console.error('Error loading subscribers:', error);
        showError('subscriberList', `Connection error: ${error.message}`);
        updateServerStatus(false);
      }
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/stats`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          currentStats = data.stats;
          updateStats();
          document.getElementById('brevoSyncStatus').textContent = data.brevo_sync_status || '❌';
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load activity log
    async function loadActivity() {
      try {
        const response = await fetch(`${API_BASE}/activity`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          activityLog = data.activity || [];
          renderActivityLog();
        }
      } catch (error) {
        console.error('Error loading activity:', error);
        showError('activityLog', 'Failed to load activity');
      }
    }

    // Check backend health
    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        updateServerStatus(true);
        const brevoStatusElement = document.getElementById('brevoStatus');
        if (brevoStatusElement) {
          brevoStatusElement.innerHTML = 
            data.brevo_status === 'connected' ? '🟢 Connected' : `🔴 ${data.brevo_status}`;
          
          // Show more detailed Brevo status if available
          if (data.brevo_email) {
            brevoStatusElement.title = `Connected as: ${data.brevo_email}`;
          }
        }
      } catch (error) {
        console.error('Health check failed:', error);
        updateServerStatus(false);
        const brevoStatusElement = document.getElementById('brevoStatus');
        if (brevoStatusElement) {
          brevoStatusElement.innerHTML = '🔴 Offline';
        }
      }
    }

    // Update server status display
    function updateServerStatus(isOnline) {
      const serverStatusElement = document.getElementById('serverStatus');
      if (serverStatusElement) {
        serverStatusElement.innerHTML = isOnline ? '🟢 Online' : '🔴 Offline';
      }
    }

    // Initialize growth chart
    function initializeGrowthChart() {
      try {
        // Destroy existing chart if it exists
        if (growthChart) {
          growthChart.destroy();
        }
        
        const ctx = document.getElementById('growthChart');
        if (!ctx) {
          console.error('Growth chart canvas not found');
          return;
        }
        
        const chartContext = ctx.getContext('2d');
        
        // Generate sample data for the last 30 days
        const last30Days = [];
        const subscriberCounts = [];
        const today = new Date();
        
        for (let i = 29; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          
          // Calculate cumulative subscriber count for this date
          const dateStr = date.toISOString().split('T')[0];
          const subscribersUpToDate = subscriberDetails.filter(sub => {
            const subDate = new Date(sub.date_added).toISOString().split('T')[0];
            return subDate <= dateStr;
          }).length;
          
          subscriberCounts.push(subscribersUpToDate);
        }
        
        // Create new chart and store reference
        growthChart = new Chart(chartContext, {
          type: 'line',
          data: {
            labels: last30Days,
            datasets: [{
              label: 'Total Subscribers',
              data: subscriberCounts,
              borderColor: '#FFD700',
              backgroundColor: 'rgba(255, 215, 0, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#FFD700',
              pointBorderColor: '#1a1a1a',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#FFD700',
                  font: {
                    weight: 'bold'
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: '#444'
                },
                ticks: {
                  color: '#cccccc'
                }
              },
              x: {
                grid: {
                  color: '#444'
                },
                ticks: {
                  color: '#cccccc',
                  maxRotation: 45
                }
              }
            },
            elements: {
              point: {
                hoverBackgroundColor: '#FFD700'
              }
            }
          }
        });
      } catch (error) {
        console.error('Error initializing growth chart:', error);
      }
    }

    // Render subscribers in the list
    function renderSubscribers(subscribersToRender = subscribers) {
      try {
        const subscriberList = document.getElementById('subscriberList');
        if (!subscriberList) {
          console.error('Subscriber list element not found');
          return;
        }
        
        if (subscribersToRender.length === 0) {
          subscriberList.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #aaaaaa;">
              📭 No subscribers found
            </div>
          `;
          return;
        }

        subscriberList.innerHTML = subscribersToRender.map(email => {
          const details = subscriberDetails.find(d => d.email === email);
          const dateAdded = details ? new Date(details.date_added).toLocaleDateString() : 'Unknown';
          const source = details ? details.source : 'unknown';
          
          return `
            <div class="subscriber-item">
              <div class="subscriber-info">
                <div class="subscriber-email">${email}</div>
                <div class="subscriber-meta">Added: ${dateAdded} • Source: ${source}</div>
              </div>
              <button class="btn btn-danger btn-sm" onclick="removeSubscriber('${email}')">
                🗑️ Remove
              </button>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error rendering subscribers:', error);
      }
    }

    // Add new subscriber
    async function addSubscriber() {
      try {
        const emailInput = document.getElementById('newSubscriberEmail');
        if (!emailInput) {
          console.error('Email input not found');
          return;
        }
        
        const email = emailInput.value.trim();

        if (!email) {
          alert('Please enter an email address');
          return;
        }

        if (!isValidEmail(email)) {
          alert('Please enter a valid email address');
          return;
        }

        const response = await fetch(`${API_BASE}/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, source: 'manual' })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          emailInput.value = '';
          await loadSubscribers();
          await loadActivity();
          showSuccess('Subscriber added successfully!');
        } else {
          alert(data.error || 'Failed to add subscriber');
        }
      } catch (error) {
        console.error('Error adding subscriber:', error);
        alert('Network error. Please try again.');
      }
    }

    // Remove subscriber
    async function removeSubscriber(email) {
      try {
        if (!confirm(`Remove ${email} from subscribers?`)) return;

        const response = await fetch(`${API_BASE}/unsubscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadSubscribers();
          await loadActivity();
          showSuccess('Subscriber removed successfully!');
        } else {
          alert(data.error || 'Failed to remove subscriber');
        }
      } catch (error) {
        console.error('Error removing subscriber:', error);
        alert('Network error. Please try again.');
      }
    }

    // Bulk import subscribers
    async function bulkImport() {
      try {
        const textarea = document.getElementById('bulkEmails');
        if (!textarea) {
          console.error('Bulk emails textarea not found');
          return;
        }
        
        const emailText = textarea.value.trim();
        
        if (!emailText) {
          alert('Please enter some email addresses');
          return;
        }
        
        const emails = emailText.split('\n')
          .map(email => email.trim())
          .filter(email => email && isValidEmail(email));
        
        if (emails.length === 0) {
          alert('No valid email addresses found');
          return;
        }
        
        if (!confirm(`Import ${emails.length} email addresses?`)) return;
        
        const response = await fetch(`${API_BASE}/bulk-import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ emails, source: 'import' })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          textarea.value = '';
          await loadSubscribers();
          await loadActivity();
          
          let message = `Successfully imported ${data.added} subscribers.`;
          if (data.errors && data.errors.length > 0) {
            message += `\n\n${data.errors.length} errors occurred:\n${data.errors.slice(0, 5).join('\n')}`;
            if (data.errors.length > 5) {
              message += `\n... and ${data.errors.length - 5} more errors.`;
            }
          }
          alert(message);
        } else {
          alert(data.error || 'Failed to import subscribers');
        }
      } catch (error) {
        console.error('Error importing subscribers:', error);
        alert('Network error. Please try again.');
      }
    }

    // Manual Brevo sync
    async function manualBrevoSync() {
      try {
        if (!confirm('Manually sync all subscribers to Brevo?')) return;
        
        const button = event.target;
        if (button) {
          button.disabled = true;
          button.innerHTML = '🔄 Syncing...';
        }
        
        const response = await fetch(`${API_BASE}/sync-brevo`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadActivity();
          let message = `Sync completed: ${data.synced} successful`;
          if (data.errors > 0) {
            message += `, ${data.errors} errors`;
          }
          alert(message);
        } else {
          alert(data.error || 'Sync failed');
        }
      } catch (error) {
        console.error('Error syncing with Brevo:', error);
        alert('Network error. Please try again.');
      } finally {
        const button = event.target;
        if (button) {
          button.disabled = false;
          button.innerHTML = '🔄 Manual Brevo Sync';
        }
      }
    }

    // Send campaign
    async function sendCampaign() {
      try {
        const subject = document.getElementById('campaignSubject')?.value?.trim() || '';
        const body = document.getElementById('campaignBody')?.value?.trim() || '';
        const fromName = document.getElementById('fromName')?.value?.trim() || '';
        
        if (!subject || !body) {
          alert('Please fill in both subject and email content');
          return;
        }
        
        if (subscribers.length === 0) {
          alert('No subscribers to send campaign to');
          return;
        }
        
        if (!confirm(`Send campaign to ${subscribers.length} subscribers?`)) return;
        
        const button = event.target;
        if (button) {
          button.disabled = true;
          button.innerHTML = '📧 Sending...';
        }
        
        const response = await fetch(`${API_BASE}/send-campaign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            body,
            fromName: fromName || 'SideQuest Mail',
            recipients: subscribers
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadActivity();
          alert(`Campaign sent successfully to ${data.sent} subscribers!`);
          // Clear form
          const subjectEl = document.getElementById('campaignSubject');
          const bodyEl = document.getElementById('campaignBody');
          if (subjectEl) subjectEl.value = '';
          if (bodyEl) bodyEl.value = '';
        } else {
          alert(data.error || 'Failed to send campaign');
        }
      } catch (error) {
        console.error('Error sending campaign:', error);
        alert('Network error. Please try again.');
      } finally {
        const button = event.target;
        if (button) {
          button.disabled = false;
          button.innerHTML = '📧 Send Campaign';
        }
      }
    }

    // Refresh subscribers
    async function refreshSubscribers() {
      try {
        await loadInitialData();
        
        // Refresh chart if on analytics tab
        const analyticsTab = document.querySelector('.tab[data-tab="analytics"]');
        if (analyticsTab && analyticsTab.classList.contains('active')) {
          setTimeout(() => {
            if (document.getElementById('growthChart') && subscriberDetails.length > 0) {
              initializeGrowthChart();
            }
          }, 200);
        }
        
        showSuccess('Data refreshed!');
      } catch (error) {
        console.error('Error refreshing data:', error);
      }
    }

    // Update dashboard stats
    function updateStats() {
      try {
        const elements = {
          totalSubscribers: document.getElementById('totalSubscribers'),
          todaySignups: document.getElementById('todaySignups'),
          thisWeekSignups: document.getElementById('thisWeekSignups'),
          webSignups: document.getElementById('webSignups'),
          manualSignups: document.getElementById('manualSignups'),
          importSignups: document.getElementById('importSignups')
        };

        if (elements.totalSubscribers) elements.totalSubscribers.textContent = currentStats.total || 0;
        if (elements.todaySignups) elements.todaySignups.textContent = currentStats.today || 0;
        if (elements.thisWeekSignups) elements.thisWeekSignups.textContent = currentStats.week || 0;
        
        // Update source breakdown
        const sources = currentStats.sources || {};
        if (elements.webSignups) elements.webSignups.textContent = sources.web || 0;
        if (elements.manualSignups) elements.manualSignups.textContent = sources.manual || 0;
        if (elements.importSignups) elements.importSignups.textContent = sources.import || 0;
      } catch (error) {
        console.error('Error updating stats:', error);
      }
    }

    // Update campaign recipient count
    function updateCampaignRecipientCount() {
      try {
        const element = document.getElementById('campaignRecipientCount');
        if (element) {
          element.textContent = subscribers.length;
        }
      } catch (error) {
        console.error('Error updating campaign recipient count:', error);
      }
    }

    // Search functionality
    function setupSearch() {
      try {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredSubscribers = subscribers.filter(email => 
              email.toLowerCase().includes(searchTerm)
            );
            renderSubscribers(filteredSubscribers);
          });
        }
      } catch (error) {
        console.error('Error setting up search:', error);
      }
    }

    // Export CSV
    function exportCSV() {
      try {
        if (subscribers.length === 0) {
          alert('No subscribers to export');
          return;
        }

        const csvContent = 'Email,Date Added,Source\n' + 
          subscriberDetails.map(details => 
            `${details.email},${details.date_added},${details.source}`
          ).join('\n');
          
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_subscribers_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess(`Exported ${subscribers.length} subscribers to CSV`);
      } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('Error exporting CSV. Please try again.');
      }
    }

    // Generate QR Code (placeholder - would need QR library)
    function generateQR() {
      try {
        const urlInput = document.getElementById('qrUrl');
        if (!urlInput) return;
        
        const url = urlInput.value;
        if (!url) {
          alert('Please enter a URL');
          return;
        }

        const qrDisplay = document.getElementById('qrDisplay');
        if (qrDisplay) {
          qrDisplay.style.display = 'block';
          qrDisplay.innerHTML = `
            <div style="width: 200px; height: 200px; background: #1a1a1a; border: 2px dashed #FFD700; display: flex; align-items: center; justify-content: center; margin: 0 auto; border-radius: 12px; color: #FFD700;">
              📱 QR Code<br>
              <small>Would generate for:<br>${url}</small>
            </div>
            <p style="margin-top: 15px; font-size: 12px; color: #aaaaaa;">
              QR code library integration needed
            </p>
          `;
        }
      } catch (error) {
        console.error('Error generating QR code:', error);
      }
    }

    // Data management
    function backupData() {
      try {
        const backup = {
          subscribers: subscriberDetails,
          timestamp: new Date().toISOString(),
          count: subscribers.length,
          stats: currentStats
        };
        
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('Data backup created');
      } catch (error) {
        console.error('Error backing up data:', error);
        alert('Error creating backup. Please try again.');
      }
    }

    async function clearAllData() {
      try {
        if (!confirm('⚠️ This will delete ALL subscribers permanently. Are you sure?')) return;
        
        const confirmation = prompt('Type "DELETE" to confirm this action:');
        if (confirmation !== 'DELETE') return;
        
        const response = await fetch(`${API_BASE}/clear-data`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ confirmation: 'DELETE' })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadInitialData();
          alert(data.message);
        } else {
          alert(data.error || 'Failed to clear data');
        }
      } catch (error) {
        console.error('Error clearing data:', error);
        alert('Network error. Please try again.');
      }
    }

    // Render activity log
    function renderActivityLog() {
      try {
        const activityLogElement = document.getElementById('activityLog');
        if (!activityLogElement) return;
        
        if (activityLog.length === 0) {
          activityLogElement.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
          return;
        }

        const recentActivities = activityLog.slice(0, 10);
        activityLogElement.innerHTML = recentActivities.map(activity => {
          const time = new Date(activity.timestamp).toLocaleTimeString();
          const iconClass = activity.type === 'success' ? 'success' : 
                           activity.type === 'danger' ? 'danger' : 'info';
          const icon = activity.type === 'success' ? '✅' : 
                      activity.type === 'danger' ? '❌' : 'ℹ️';
          
          return `
            <div class="activity-item">
              <div class="activity-icon ${iconClass}">${icon}</div>
              <div class="activity-content">
                <div class="activity-text">${activity.message}</div>
                <div class="activity-time">${time}</div>
              </div>
            </div>
          `;
        }).join('');

        // Update last activity in system status
        if (recentActivities.length > 0) {
          const lastTime = new Date(recentActivities[0].timestamp).toLocaleTimeString();
          const lastActivityElement = document.getElementById('lastActivity');
          if (lastActivityElement) {
            lastActivityElement.textContent = lastTime;
          }
        }
      } catch (error) {
        console.error('Error rendering activity log:', error);
      }
    }

    // Auto refresh functionality
    function startAutoRefresh() {
      try {
        // Refresh data every 30 seconds
        setInterval(async () => {
          try {
            await loadStats();
            await loadActivity();
          } catch (error) {
            console.error('Auto refresh error:', error);
          }
        }, 30000);
      } catch (error) {
        console.error('Error starting auto refresh:', error);
      }
    }

    // Utility functions
    function isValidEmail(email) {
      const pattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return pattern.test(email);
    }

    function showLoading(elementId) {
      try {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #aaaaaa;">
              <div class="spinner"></div>
              <p style="margin-top: 15px;">Loading...</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error showing loading:', error);
      }
    }

    function showError(elementId, message) {
      try {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #ff6b35;">
              ❌ ${message}
            </div>
          `;
        }
      } catch (error) {
        console.error('Error showing error:', error);
      }
    }

    function showSuccess(message) {
      try {
        // Success notification with SideQuest styling
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
          color: #1a1a1a;
          padding: 18px 25px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
          z-index: 1000;
          animation: slideIn 0.3s ease;
          font-weight: 600;
          border: 2px solid #FFD700;
        `;
        notification.textContent = `✅ ${message}`;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 3000);
      } catch (error) {
        console.error('Error showing success notification:', error);
      }
    }

    // Handle Enter key in email input
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const emailInput = document.getElementById('newSubscriberEmail');
        if (emailInput) {
          emailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              addSubscriber();
            }
          });
        }
      } catch (error) {
        console.error('Error setting up enter key handler:', error);
      }
    });
  </script>
</body>

</html>
