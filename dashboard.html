<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SideQuest Mail Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
      border: 2px solid #FFD700;
    }
    
    .header h1 { 
      font-size: 2.8rem; 
      margin-bottom: 8px; 
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header p { 
      font-size: 1.2rem; 
      font-weight: 500;
      opacity: 0.8;
    }
    
    /* Logo placeholder */
    .logo {
      display: inline-block;
      width: 45px;
      height: 45px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-right: 15px;
      vertical-align: middle;
      position: relative;
      border: 2px solid #1a1a1a;
    }
    
    .logo::before {
      content: "SQ";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #FFD700;
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -1px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border-left: 4px solid;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    
    .stat-card.primary { border-left-color: #FFD700; }
    .stat-card.success { border-left-color: #00ff88; }
    .stat-card.warning { border-left-color: #ff6b35; }
    .stat-card.info { border-left-color: #8b5cf6; }
    
    .stat-value {
      font-size: 2.8rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
    }
    
    .stat-label {
      color: #cccccc;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    /* Main Content */
    .main-content {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid #444;
    }
    
    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid #444;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #444;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #FFD700;
      text-shadow: 0 1px 2px rgba(255, 215, 0, 0.3);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 6px;
      margin-bottom: 25px;
      border: 2px solid #444;
    }
    
    .tab {
      flex: 1;
      padding: 12px 18px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
      transform: translateY(-1px);
    }
    
    .tab:not(.active) {
      color: #cccccc;
    }
    
    .tab:not(.active):hover {
      color: #FFD700;
      background: #333;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
      padding: 25px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #FFD700;
      font-size: 1rem;
    }
    
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #444;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #1a1a1a;
      color: #ffffff;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
      background: #2a2a2a;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 215, 0, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
      box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    }
    
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }
    
    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 107, 53, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    }
    
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(107, 114, 128, 0.4);
    }
    
    .btn-sm {
      padding: 10px 20px;
      font-size: 12px;
    }

    .event-actions .btn {
      padding: 12px 20px;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
      text-align: center;
      white-space: nowrap;
    }

    .event-actions .btn:hover {
      transform: translateY(-1px);
    }

    .event-actions .btn-primary {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }

    .event-actions .btn-success {
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
    }

    .event-actions .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    }

    .event-actions .btn-warning {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    /* Subscriber List */
    .subscriber-list {
      max-height: 450px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #FFD700 #2a2a2a;
    }
    
    .subscriber-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .subscriber-list::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 4px;
    }
    
    .subscriber-list::-webkit-scrollbar-thumb {
      background: #FFD700;
      border-radius: 4px;
    }
    
    .subscriber-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #444;
      transition: background 0.2s ease;
    }
    
    .subscriber-item:hover {
      background: rgba(255, 215, 0, 0.05);
      border-radius: 8px;
      padding-left: 10px;
      padding-right: 10px;
    }
    
    .subscriber-item:last-child {
      border-bottom: none;
    }
    
    .subscriber-info {
      flex: 1;
    }
    
    .subscriber-email {
      font-weight: 600;
      color: #ffffff;
      font-size: 1.05rem;
    }
    
    .subscriber-meta {
      font-size: 12px;
      color: #aaaaaa;
      margin-top: 5px;
    }
    
    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 25px;
    }
    
    .search-input {
      width: 100%;
      padding: 14px 18px 14px 50px;
      border: 2px solid #444;
      border-radius: 10px;
      font-size: 14px;
      background: #1a1a1a;
      color: #ffffff;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
    }
    
    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: #FFD700;
      font-size: 18px;
    }
    
    /* Activity Log */
    .activity-item {
      display: flex;
      align-items: flex-start;
      padding: 15px 0;
      border-bottom: 1px solid #444;
      transition: background 0.2s ease;
    }
    
    .activity-item:hover {
      background: rgba(255, 215, 0, 0.05);
      border-radius: 8px;
      padding-left: 10px;
      padding-right: 10px;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .activity-icon.success { 
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
    }
    .activity-icon.danger { 
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
    }
    .activity-icon.info { 
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-text {
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }
    
    .activity-time {
      color: #aaaaaa;
      font-size: 12px;
      margin-top: 3px;
    }
    
    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #444;
      border-top: 3px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Chart container */
    .chart-container {
      height: 280px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #444;
      margin-top: 15px;
    }
    
    /* Source stats */
    .source-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .source-stat {
      text-align: center;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 12px;
      border: 2px solid #444;
      transition: all 0.3s ease;
    }
    
    .source-stat:hover {
      border-color: #FFD700;
      transform: translateY(-2px);
    }
    
    .source-stat-value {
      font-size: 2rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 8px;
    }
    
    .source-stat-label {
      font-size: 0.8rem;
      color: #aaaaaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .event-card {
        padding: 20px;
      }
      
      .event-details {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .event-actions {
        grid-template-columns: 1fr;
      }
      
      .event-actions.four-buttons {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, 1fr);
      }
    }

    .events-container .empty-state h3 {
      color: #FFD700;
      margin-bottom: 15px;
    }

    /* Event filter dropdown improvements */
    #eventTypeFilter {
      min-width: 160px;
      padding: 10px 15px;
      border-radius: 10px;
      background: #2a2a2a;
      border: 2px solid #444;
      color: #ffffff;
      font-weight: 600;
    }

    #eventTypeFilter:focus {
      border-color: #FFD700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
    }
    

    /* Empty state styling */
    .events-container .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #aaaaaa;
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      border: 2px dashed #444;
    }


    /* Loading state improvements */
    .events-container .loading-placeholder {
      text-align: center;
      padding: 60px 20px;
      color: #aaaaaa;
    }

    .events-container .spinner {
      margin: 0 auto 20px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .container {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 2.2rem;
      }
      
      .source-stats {
        grid-template-columns: 1fr;
      }
    }
    
    /* Success notification styles */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Utilities */
    .text-center { text-align: center; }
    .mb-0 { margin-bottom: 0; }
    .mt-20 { margin-top: 20px; }
    .text-success { color: #00ff88; }
    .text-danger { color: #ff6b35; }
    .text-muted { color: #aaaaaa; }

    /* Event Management Styles */
    .event-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 10px;
    }

    .event-nav-btn {
      padding: 10px 20px;
      background: #2a2a2a;
      color: #cccccc;
      border: 2px solid #444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .event-nav-btn.active {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1a1a1a;
      border-color: #FFD700;
    }

    .event-nav-btn:hover:not(.active) {
      background: #3a3a3a;
      color: #FFD700;
    }

    .event-view {
      display: none;
    }

    .event-view.active {
      display: block;
    }
    
    .events-container {
      display: block;
      margin-top: 20px;
      width: 100%;
    }

  
   .event-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 25px;
      border: 2px solid #FFD700;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      display: block;
      width: 100%;
      transition: all 0.3s ease;
      position: static;
      clear: both;
      overflow: visible;
      z-index: 1;
    }

   
    .event-card * {
      position: static !important;
      z-index: auto !important;
    }
   
   .event-card:last-child {
      margin-bottom: 0;
    }
    
    .event-card:hover {
      transform: translateY(-3px); /* Only apply transform on hover */
      box-shadow: 0 12px 30px rgba(255, 215, 0, 0.15);
    }

    /* Event type specific colors */
    .event-card.tournament {
      border-left-color: #FF6B35;
    }

    .event-card.tournament::before {
      background: radial-gradient(circle, rgba(255, 107, 53, 0.05) 0%, transparent 70%);
    }

    .event-card.game_night {
      border-left-color: #4ECDC4;
    }

    .event-card.game_night::before {
      background: radial-gradient(circle, rgba(78, 205, 196, 0.05) 0%, transparent 70%);
    }

    .event-card.special {
      border-left-color: #8B5CF6;
    }

    .event-card.special::before {
      background: radial-gradient(circle, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
    }

    .event-card.birthday {
      border-left-color: #FF69B4;
    }

    .event-card.birthday::before {
      background: radial-gradient(circle, rgba(255, 105, 180, 0.05) 0%, transparent 70%);
    }

   .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    }

    .event-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #FFD700;
      margin: 0;
      line-height: 1.3;
    }

    .event-game-subtitle {
      font-size: 1rem;
      color: #aaaaaa;
      margin-top: 5px;
      font-weight: 500;
    }

    .event-badge {
      padding: 8px 16px; /* More generous padding */
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .badge-tournament { background: #FF6B35; color: white; }
    .badge-game_night { background: #4ECDC4; color: #1a1a1a; }
    .badge-special { background: #FFD700; color: #1a1a1a; }
    .badge-birthday { background: #FF69B4; color: white; }

    .event-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 20px; /* Increased gap */
      margin-bottom: 20px;
      padding: 15px 0;
    }

    .event-detail {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #cccccc;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .event-detail-icon {
      color: #FFD700;
      font-size: 1.2rem;
      width: 20px; /* Fixed width for alignment */
      text-align: center;
    }

    .event-actions {
      display: grid;
      grid-template-columns: 1fr 1fr; /* Two columns */
      gap: 12px;
      margin-top: 20px;
    }

    .event-actions.four-buttons {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    /* Capacity bar improvements */
    .capacity-bar {
      width: 100%;
      height: 28px; /* Slightly taller */
      background: #1a1a1a;
      border-radius: 15px;
      overflow: hidden;
      margin: 15px 0 20px 0;
      position: relative;
      border: 2px solid #333;
    }

   .capacity-fill {
      height: 100%;
      background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
      transition: width 0.3s ease;
      border-radius: 12px;
    }

    .capacity-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
      text-shadow: 0 1px 3px rgba(0,0,0,0.7);
      z-index: 2;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      border: 2px solid #FFD700;
    }

    .modal-close {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #FFD700;
      cursor: pointer;
    }

    .modal-close:hover {
      color: #FFA500;
    }

    .attendee-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .attendee-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .attendee-email {
      color: #ffffff;
      font-weight: 500;
    }

    .attendee-status {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-attended { background: #00ff88; color: #1a1a1a; }
    .status-registered { background: #FFD700; color: #1a1a1a; }


    .fc {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      border: 1px solid #444;
      overflow: hidden;
    }

    .fc-header-toolbar {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      padding: 20px 25px !important;
      border-bottom: 3px solid #FFD700;
      margin-bottom: 0 !important;
    }

    .fc-toolbar-title {
      color: #1a1a1a !important;
      font-weight: 800 !important;
      font-size: 1.8rem !important;
    }

    .fc-button {
      background: #1a1a1a !important;
      border: 2px solid #FFD700 !important;
      color: #FFD700 !important;
      font-weight: 600 !important;
      border-radius: 8px !important;
      padding: 8px 16px !important;
      transition: all 0.3s ease !important;
    }

    .fc-button:hover {
      background: #FFD700 !important;
      color: #1a1a1a !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3) !important;
    }

    .fc-button-active {
      background: #FFD700 !important;
      color: #1a1a1a !important;
    }

    .fc-view-harness {
      background: #1a1a1a;
    }

    .fc-day {
      background: #2a2a2a !important;
      border-color: #444 !important;
      transition: all 0.3s ease;
    }

    .fc-day:hover {
      background: #3a3a3a !important;
    }

    .fc-day-today {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
      color: #1a1a1a !important;
      font-weight: 800 !important;
    }

    .fc-col-header {
      background: #2a2a2a !important;
      border-bottom: 2px solid #FFD700 !important;
    }

    .fc-col-header-cell-cushion {
      color: #FFD700 !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      letter-spacing: 1px !important;
      padding: 15px 0 !important;
    }

    .fc-daygrid-day-number {
      color: #ffffff !important;
      font-weight: 700 !important;
      padding: 8px !important;
    }

    .fc-event {
      border: none !important;
      border-radius: 6px !important;
      padding: 3px 6px !important;
      margin: 2px !important;
      font-weight: 600 !important;
      font-size: 0.75rem !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      border-left: 3px solid transparent !important;
    }

    .fc-event:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }

    .fc-event.tournament {
      background: linear-gradient(135deg, #FF6B35 0%, #FF4757 100%) !important;
      color: white !important;
      border-left-color: #FF6B35 !important;
    }

    .fc-event.game_night {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%) !important;
      color: #1a1a1a !important;
      border-left-color: #4ECDC4 !important;
    }

    .fc-event.special {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%) !important;
      color: white !important;
      border-left-color: #8B5CF6 !important;
    }

    .fc-event.birthday {
      background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%) !important;
      color: white !important;
      border-left-color: #FF69B4 !important;
    }

    .fc-more-link {
      color: #FFD700 !important;
      font-weight: 600 !important;
      background: #666 !important;
      border-radius: 4px !important;
      padding: 2px 6px !important;
      margin: 1px !important;
    }

    .fc-more-link:hover {
      background: #FFD700 !important;
      color: #1a1a1a !important;
    }

    /* Hide time display in calendar events */
    .fc-event-time {
      display: none !important;
    }

    /* Make sure only title shows */
    .fc-event-title {
      display: block !important;
      font-weight: 600 !important;
    }


    /* Make events expand on hover to show full content */
    .fc-event:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
      z-index: 999 !important;
      overflow: visible !important;
      white-space: normal !important;
    }

        fc-list-view {
      background: #1a1a1a !important;
    }

    .fc-list-day-cushion {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%) !important;
      color: #FFD700 !important;
      font-weight: 700 !important;
      border-bottom: 2px solid #FFD700 !important;
    }

    .fc-list-event {
      background: #2a2a2a !important;
      border-left: 4px solid #FFD700 !important;
    }

    .fc-list-event:hover {
      background: #3a3a3a !important;
    }

    .fc-list-event-time {
      color: #FFD700 !important;
      font-weight: 600 !important;
    }

    .fc-list-event-title {
      color: #ffffff !important;
      font-weight: 600 !important;
    }

    /* List view event type colors */
    .fc-list-event.tournament {
      border-left-color: #FF6B35 !important;
    }

    .fc-list-event.game_night {
      border-left-color: #4ECDC4 !important;
    }

    .fc-list-event.special {
      border-left-color: #8B5CF6 !important;
    }

    .fc-list-event.birthday {
      border-left-color: #FF69B4 !important;
    }

    /* Analytics Dashboard Styles - ADD TO YOUR EXISTING CSS */

    .analytics-kpi-grid {
      margin-bottom: 30px;
    }

    .kpi-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 20px;
      border-left: 4px solid #FFD700;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .kpi-card.subscriber-kpis { border-left-color: #FFD700; }
    .kpi-card.event-kpis { border-left-color: #4ECDC4; }
    .kpi-card.revenue-kpis { border-left-color: #00ff88; }
    .kpi-card.engagement-kpis { border-left-color: #8B5CF6; }

    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .kpi-header h4 {
      color: #FFD700;
      font-size: 1rem;
      font-weight: 700;
      margin: 0;
    }

    .kpi-trend {
      background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
      color: #1a1a1a;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .kpi-trend.negative {
      background: linear-gradient(135deg, #ff6b35 0%, #ff4757 100%);
      color: #ffffff;
    }

    .kpi-badge {
      background: #444;
      color: #FFD700;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .kpi-main {
      text-align: center;
      margin-bottom: 15px;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 900;
      color: #FFD700;
      margin-bottom: 5px;
      text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
    }

    .kpi-label {
      color: #cccccc;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kpi-details {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }

    .kpi-detail {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 8px;
    }

    .kpi-detail-value {
      display: block;
      font-size: 1.3rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 3px;
    }

    .kpi-detail-label {
      font-size: 0.75rem;
      color: #aaaaaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .analytics-chart-container {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid #444;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .chart-header {
      margin-bottom: 15px;
    }

    .chart-header h4 {
      color: #FFD700;
      font-size: 1.1rem;
      font-weight: 700;
      margin: 0 0 5px 0;
    }

    .chart-subtitle {
      color: #aaaaaa;
      font-size: 0.85rem;
    }

    .analytics-section {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid #444;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .section-header {
      margin-bottom: 20px;
    }

    .section-header h4 {
      color: #FFD700;
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0 0 5px 0;
    }

    .section-subtitle {
      color: #aaaaaa;
      font-size: 0.9rem;
    }

    .event-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .event-type-card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 18px;
      border-left: 4px solid;
      transition: all 0.3s ease;
    }

    .event-type-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .event-type-card.tournament { border-left-color: #FF6B35; }
    .event-type-card.game_night { border-left-color: #4ECDC4; }
    .event-type-card.special { border-left-color: #8B5CF6; }
    .event-type-card.birthday { border-left-color: #FF69B4; }

    .event-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .event-type-title {
      color: #ffffff;
      font-weight: 700;
      text-transform: capitalize;
    }

    .event-type-count {
      background: #FFD700;
      color: #1a1a1a;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .event-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .event-type-stat {
      text-align: center;
    }

    .event-type-stat-value {
      display: block;
      font-size: 1.4rem;
      font-weight: 700;
      color: #FFD700;
    }

    .event-type-stat-label {
      font-size: 0.75rem;
      color: #aaaaaa;
      text-transform: uppercase;
    }

    .loading-placeholder {
      text-align: center;
      padding: 40px;
      color: #aaaaaa;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .analytics-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .kpi-details {
        flex-direction: column;
        gap: 10px;
      }
      
      .event-types-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Enhanced Analytics Styles - ADD TO YOUR EXISTING CSS */

    .analytics-status-banner {
      animation: slideIn 0.5s ease;
    }

    .chart-toggle-btn {
      padding: 6px 12px;
      background: #444;
      color: #ccc;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chart-toggle-btn.active {
      background: #FFD700;
      color: #1a1a1a;
      font-weight: 700;
    }

    .chart-toggle-btn:hover:not(.active) {
      background: #555;
      color: #FFD700;
    }

    .kpi-insight {
      padding: 8px 12px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 8px;
      border-left: 3px solid #FFD700;
      margin-top: 12px !important;
      font-size: 0.8rem !important;
      color: #FFD700 !important;
    }

    .insights-grid {
      margin-top: 20px;
    }

    .insight-card {
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .insight-card.growth { border-left-color: #00ff88; }
    .insight-card.warning { border-left-color: #ff6b35; }
    .insight-card.opportunity { border-left-color: #8B5CF6; }
    .insight-card.success { border-left-color: #FFD700; }

    .insight-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .insight-icon {
      font-size: 1.5rem;
    }

    .insight-title {
      color: #FFD700;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .insight-description {
      color: #cccccc;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .insight-action {
      color: #FFD700;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: underline;
      cursor: pointer;
    }

    .insight-action:hover {
      color: #FFA500;
    }

    .performance-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 3px solid #FFD700;
      transition: all 0.3s ease;
    }

    .performance-metric:hover {
      background: #2a2a2a;
      transform: translateX(5px);
    }

    .metric-label {
      color: #cccccc;
      font-weight: 600;
    }

    .metric-value {
      color: #FFD700;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .metric-trend {
      font-size: 0.8rem;
      margin-left: 8px;
    }

    .trend-up { color: #00ff88; }
    .trend-down { color: #ff6b35; }
    .trend-neutral { color: #aaaaaa; }

    /* Improved event type cards */
    .event-type-card {
      position: relative;
      overflow: hidden;
    }

    .event-type-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent 0%, var(--accent-color, #FFD700) 50%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .event-type-card:hover::before {
      opacity: 1;
    }

    .event-type-card.tournament { --accent-color: #FF6B35; }
    .event-type-card.game_night { --accent-color: #4ECDC4; }
    .event-type-card.special { --accent-color: #8B5CF6; }
    .event-type-card.birthday { --accent-color: #FF69B4; }

    /* Responsive improvements */
    @media (max-width: 1024px) {
      .analytics-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .chart-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .analytics-status-banner {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }

    @media (max-width: 768px) {
      .analytics-kpi-grid {
        grid-template-columns: 1fr;
      }
      
      .kpi-details {
        flex-direction: column;
        gap: 8px;
      }
      
      .insights-grid {
        grid-template-columns: 1fr;
      }
    }
 </style>
</head>
<body>
    <!-- Header -->
    <div class="header" style="position: relative;">
      <h1><span class="logo"></span>SideQuest Canterbury Hub</h1>
      <p>Subscriber Management & Gaming Venue Management Platform</p>
      
      <!-- Logout Button -->
      <div style="position: absolute; top: 20px; right: 20px;">
        <a href="/admin/logout" class="btn btn-secondary btn-sm">🔓 Logout</a>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-grid">
      <!-- Main Content -->
      <div class="main-content">
        <div class="card">
          <!-- Tabs -->
          <div class="tabs">
            <div class="tab active" data-tab="subscribers">👥 Subscribers</div>
            <div class="tab" data-tab="analytics">📊 Analytics</div>
            <div class="tab" data-tab="tools">🛠️ Tools</div>
            <div class="tab" data-tab="campaigns">📧 Campaigns</div>
            <div class="tab" data-tab="events">🎮 Events</div>
          </div>

          <!-- Subscribers Tab -->
          <div class="tab-content active" id="subscribers">
            <div class="card-header">
              <h3 class="card-title">Subscriber Management</h3>
              <div>
                <button class="btn btn-primary btn-sm" onclick="refreshSubscribers()">🔄 Refresh</button>
                <button class="btn btn-success btn-sm" onclick="exportCSV()">📤 Export</button>
              </div>
            </div>

            <!-- Search -->
            <div class="search-box">
              <input type="text" class="search-input" id="searchInput" placeholder="Search subscribers...">
              <span class="search-icon">🔍</span>
            </div>

            <!-- Add Subscriber -->
            <div class="form-group">
              <label class="form-label">Add New Subscriber</label>
              <div style="display: flex; gap: 12px;">
                <input type="email" class="form-input" id="newSubscriberEmail" placeholder="Enter email address">
                <button class="btn btn-primary" onclick="addSubscriber()">Add</button>
              </div>
            </div>

            <!-- Subscriber List -->
            <div class="subscriber-list" id="subscriberList">
              <div style="text-align: center; padding: 50px; color: #aaaaaa;">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Loading subscribers...</p>
              </div>
            </div>
          </div>
         
          <!-- Analytics Tab -->
     <!-- Enhanced Analytics Tab - REPLACE YOUR EXISTING ANALYTICS TAB CONTENT -->
          <div class="tab-content" id="analytics">
            <div class="card-header">
              <h3 class="card-title">📊 Analytics Dashboard</h3>
              <div style="display: flex; gap: 10px; align-items: center;">
                <select id="analyticsTimeRange" class="form-select" style="width: 150px;">
                  <option value="7">Last 7 days</option>
                  <option value="30" selected>Last 30 days</option>
                  <option value="90">Last 90 days</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="refreshAnalytics()">
                  🔄 Refresh
                </button>
                <button class="btn btn-secondary btn-sm" onclick="exportAnalyticsReport()">
                  📊 Export Report
                </button>
              </div>
            </div>

            <!-- Quick Status Banner -->
            <div class="analytics-status-banner" style="background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%); border-radius: 12px; padding: 15px; margin-bottom: 25px; border-left: 4px solid #FFD700; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="color: #FFD700; font-weight: 700;">🚀 Business Health: </span>
                <span id="businessHealthScore" style="color: #00ff88; font-weight: 700;">Excellent</span>
              </div>
              <div style="display: flex; gap: 20px; font-size: 0.9rem;">
                <span style="color: #cccccc;">📧 <strong id="quickSubscriberCount">-</strong> subscribers</span>
                <span style="color: #cccccc;">🎮 <strong id="quickEventCount">-</strong> events</span>
                <span style="color: #cccccc;">💰 <strong id="quickRevenue">£-</strong> revenue</span>
                <span style="color: #cccccc;" id="brevoSyncQuickStatus">🔄 Brevo: <strong>Synced</strong></span>
              </div>
            </div>

            <!-- KPI Cards Grid with Tooltips -->
            <div class="analytics-kpi-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
              
              <!-- Subscriber KPIs -->
              <div class="kpi-card subscriber-kpis" title="Track subscriber growth and acquisition trends">
                <div class="kpi-header">
                  <h4>👥 Subscribers</h4>
                  <span class="kpi-trend" id="subscriberTrend">+0%</span>
                </div>
                <div class="kpi-main">
                  <div class="kpi-value" id="analyticsSubscribers">-</div>
                  <div class="kpi-label">Total Subscribers</div>
                </div>
                <div class="kpi-details">
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="newSubscribers">-</span>
                    <span class="kpi-detail-label">New this period</span>
                  </div>
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="weeklyGrowth">-</span>
                    <span class="kpi-detail-label">This week</span>
                  </div>
                </div>
                <div class="kpi-insight" id="subscriberInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                  📈 Growing steadily
                </div>
              </div>

              <!-- Event Performance KPIs -->
              <div class="kpi-card event-kpis" title="Monitor event creation and registration performance">
                <div class="kpi-header">
                  <h4>🎮 Events</h4>
                  <span class="kpi-badge" id="upcomingEventsBadge">- upcoming</span>
                </div>
                <div class="kpi-main">
                  <div class="kpi-value" id="totalEvents">-</div>
                  <div class="kpi-label">Total Events</div>
                </div>
                <div class="kpi-details">
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="totalRegistrations">-</span>
                    <span class="kpi-detail-label">Total Registrations</span>
                  </div>
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="capacityUtil">-%</span>
                    <span class="kpi-detail-label">Avg Capacity</span>
                  </div>
                </div>
                <div class="kpi-insight" id="eventInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                  🎯 Strong demand
                </div>
              </div>

              <!-- Revenue KPIs -->
              <div class="kpi-card revenue-kpis" title="Track revenue from paid events and pricing performance">
                <div class="kpi-header">
                  <h4>💰 Revenue</h4>
                  <span class="kpi-badge" id="paidEventsBadge">- paid events</span>
                </div>
                <div class="kpi-main">
                  <div class="kpi-value" id="totalRevenue">£-</div>
                  <div class="kpi-label">Total Revenue</div>
                </div>
                <div class="kpi-details">
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="avgRevenuePerEvent">£-</span>
                    <span class="kpi-detail-label">Avg per event</span>
                  </div>
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="revenueGrowth">+-%</span>
                    <span class="kpi-detail-label">Growth rate</span>
                  </div>
                </div>
                <div class="kpi-insight" id="revenueInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                  💡 Consider premium events
                </div>
              </div>

              <!-- Engagement KPIs -->
              <div class="kpi-card engagement-kpis" title="Monitor how actively subscribers engage with your events">
                <div class="kpi-header">
                  <h4>📊 Engagement</h4>
                  <span class="kpi-trend" id="attendanceTrend">-%</span>
                </div>
                <div class="kpi-main">
                  <div class="kpi-value" id="engagementRate">-%</div>
                  <div class="kpi-label">Event Participation</div>
                </div>
                <div class="kpi-details">
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="engagedSubscribers">-</span>
                    <span class="kpi-detail-label">Active subscribers</span>
                  </div>
                  <div class="kpi-detail">
                    <span class="kpi-detail-value" id="avgRegistrationsPerEvent">-</span>
                    <span class="kpi-detail-label">Avg regs/event</span>
                  </div>
                </div>
                <div class="kpi-insight" id="engagementInsight" style="margin-top: 10px; font-size: 0.8rem; color: #aaa; font-style: italic;">
                  🎯 High engagement
                </div>
              </div>
            </div>

            <!-- Charts Section with Improved Layout -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px;">
              
              <!-- Main Growth Chart -->
              <div class="analytics-chart-container">
                <div class="chart-header">
                  <h4>📈 Growth Trends</h4>
                  <div style="display: flex; gap: 10px;">
                    <button class="chart-toggle-btn active" data-chart="subscribers" onclick="toggleChartView('subscribers')">Subscribers</button>
                    <button class="chart-toggle-btn" data-chart="registrations" onclick="toggleChartView('registrations')">Registrations</button>
                  </div>
                </div>
                <div class="chart-container" style="height: 320px;">
                  <canvas id="mainGrowthChart"></canvas>
                </div>
              </div>

              <!-- Performance Summary -->
              <div class="analytics-chart-container">
                <div class="chart-header">
                  <h4>⚡ Quick Stats</h4>
                  <span class="chart-subtitle">This period overview</span>
                </div>
                <div id="performanceSummary" style="padding: 20px 0;">
                  <!-- Performance metrics will be populated here -->
                </div>
              </div>
            </div>

            <!-- Event Types Performance with Detailed Insights -->
            <div class="analytics-section">
              <div class="section-header">
                <h4>🎮 Event Type Performance</h4>
                <div style="display: flex; gap: 10px;">
                  <span class="section-subtitle">Analyze which event types drive the most engagement</span>
                  <button class="btn btn-secondary btn-sm" onclick="optimizeEventMix()">💡 Get Recommendations</button>
                </div>
              </div>
              <div id="eventTypesPerformance" class="event-types-grid">
                <div class="loading-placeholder">
                  <div class="spinner"></div>
                  <p>Loading performance data...</p>
                </div>
              </div>
            </div>

            <!-- Key Insights Section -->
            <div class="analytics-section" style="margin-top: 25px;">
              <div class="section-header">
                <h4>🧠 AI Insights & Recommendations</h4>
                <span class="section-subtitle">Data-driven suggestions to improve your business</span>
              </div>
              <div id="aiInsights" class="insights-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <!-- AI insights will be populated here -->
              </div>
            </div>
          </div>

          <!-- Tools Tab -->
          <div class="tab-content" id="tools">
            <div class="card-header">
              <h3 class="card-title">Admin Tools</h3>
            </div>

            <div class="form-group">
              <label class="form-label">Bulk Import Subscribers</label>
              <textarea class="form-textarea" id="bulkEmails" placeholder="Enter emails, one per line:&#10;user1@example.com&#10;user2@example.com&#10;user3@example.com" rows="5"></textarea>
              <button class="btn btn-primary mt-20" onclick="bulkImport()">📥 Import Subscribers</button>
            </div>

            <div class="form-group">
              <label class="form-label">Generate QR Code</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input" id="qrUrl" placeholder="Enter signup URL" value="http://localhost:4000/signup">
                <button class="btn btn-primary" onclick="generateQR()">Generate QR</button>
              </div>
              <div class="qr-display" id="qrDisplay" style="display: none;">
                <canvas id="qrCanvas"></canvas>
                <p style="margin-top: 15px; color: #aaaaaa;">Right-click to save QR code</p>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Data Management</label>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="backupData()">💾 Backup Data</button>
                <button class="btn btn-primary" onclick="manualBrevoSync()">🔄 Sync Brevo</button>
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
              </div>
            </div>
          </div>

          <!-- Campaigns Tab -->
          <div class="tab-content" id="campaigns">
            <div class="card-header">
              <h3 class="card-title">Send Campaign</h3>
            </div>

            <div class="form-group">
              <label class="form-label">Campaign Subject</label>
              <input type="text" class="form-input" id="campaignSubject" placeholder="Enter email subject">
            </div>

            <div class="form-group">
              <label class="form-label">From Name</label>
              <input type="text" class="form-input" id="fromName" value="SideQuest Mail" placeholder="Sender name">
            </div>

            <div class="form-group">
              <label class="form-label">Email Content (HTML)</label>
              <textarea class="form-textarea" id="campaignBody" placeholder="Enter your email content in HTML format..." rows="8"></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Recipients</label>
              <p style="color: #aaaaaa; font-size: 14px; margin-bottom: 15px;">
                Campaign will be sent to all <span id="campaignRecipientCount">0</span> active subscribers
              </p>
              <button class="btn btn-primary" onclick="sendCampaign()">📧 Send Campaign</button>
            </div>
          </div>

          <!-- Events Tab -->
          <div class="tab-content" id="events"> 
            <div class="event-nav">
              <button class="event-nav-btn active" data-view="list">📋 Event List</button>
              <button class="event-nav-btn" data-view="calendar">📅 Calendar View</button>
              <button class="event-nav-btn" data-view="create">➕ Create Event</button>
              <button class="event-nav-btn" data-view="stats">📊 Statistics</button>
            </div>

            <!--Events List View-->
            <div class="event-view active" id="event-list-view">
              <div class="card-header">
                <h3 class="card-title">Upcoming Events</h3>
                <div>
                  <select id="eventTypeFilter" 
                          class="form-select" 
                          style="width: 150px; display: inline-block;" 
                          onchange="loadEvents()">
                    <option value="all">All Types</option>
                    <option value="tournament">Tournaments</option>
                    <option value="game_night">Game Nights</option>
                    <option value="special">Special Events</option>
                    <option value="birthday">Birthdays</option>
                  </select>
                </div>
              </div>

              <div id="eventsList" class="events-container">
                <div style="text-align: center; padding: 50px; color: #aaaaaa;">
                  <div class="spinner"></div>
                  <p style="margin-top: 15px;">Loading events...</p>
                </div>
              </div>
            </div> 

            <!-- Replace the calendar view section -->
            <div class="event-view" id="event-calendar-view">
              <div class="card-header">
                <h3 class="card-title">Event Calendar</h3>
                <button class="btn btn-primary btn-sm" onclick="refreshCalendar()">🔄 Refresh</button>
              </div>
              
              <!-- FullCalendar Container -->
              <div id="fullCalendar" style="padding: 20px;"></div>
            </div>
            
            <!-- Create Event View -->
            <div class="event-view" id="event-create-view">
              <div class="card-header">
                <h3 class="card-title">Create New Event</h3>
              </div> 

              <form id="createEventForm">
                <div class="form-group">
                  <label class="form-label">Event Title*</label>
                  <input type="text" class="form-input" id="eventTitle" placeholder="e.g Valorant Friday Night Tournament">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div class="form-group">
                    <label class="form-label">Event Type*</label>
                    <select class=""form-select" id="eventType" required>
                      <option value="">Select Type*</option>
                      <option value="tournament">Tournament</option>
                      <option value="game_night">Game Night</option>
                      <option value="special">Special Event</option>
                      <option value="birthday">Birthday</option>
                    </select>
                  </div> 
                  
                  <div class="form-group">
                    <label class="form-label">Game Title</label>
                    <input type="text" class="form-input" id="gameTitle" placeholder="e.g Valorant, Fortnite">
                  </div>  
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div class="form-group">
                    <label class="form-label">Start Date & Time*</label>
                    <input type="datetime-local" class="form-input" id="eventDateTime" required>
                  </div>
                  
                  <div class="form-group>
                    <label class="form-label">End Date & Time*</label>
                    <input type="datetime-local" class="form-input" id="eventEndTime">
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div class="form-group">
                    <label class="form-label">Capacity</label>
                    <input type="number" class="form-input" id="eventCapacity" min="0" placeholder="0 (Unlimited)">
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Entry Fee (£)</label>
                    <input type="text" class="form-input" id="eventFee" min="0" step="0.01" placeholder="0.00 (Free)">
                  </div>  

                  <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="eventStatus">
                      <option value="draft">Upcoming</option>
                      <option value="published">Completed</option>
                    </select>
                  </div>    
                </div>

                <div class="form-group">
                  <label class="form-label">Description</label>
                  <textarea class="form-textarea" id="eventDescription" rows="4" placeholder="Event details, rules, what to bring..."></textarea>
                </div>

                <div class="form-group">
                  <label class="form-label">Prize Pool (JSON format)</label>
                  <input type="text" class="form-input" id="eventPrizes" placeholder='{"1st": "£100", "2nd": "£50", "3rd": "£25"}'>
                </div>

                <div class="form-group">
                  <label class="form-label">Requirements</label>
                  <input type="text" class="form-input" id="eventRequirements" placeholder="e.g., Bring your own controller">
                </div>

                <div style="display: flex; gap: 12px;">
                  <button type="submit" class="btn btn-primary">🎮 Create Event</button>
                  <button type="button" class="btn btn-secondary" onclick="resetEventForm()">Clear Form</button>
                </div>
              </form>
            </div>
            
            <!-- Event Statistics View -->
            <div class="event-view" id="event-stats-view">
              <div class="card-header">
                <h3 class="card-title">Event Statistics</h3>
              </div>
              
              <div class="stats-grid" style ="margin-top: 30px;">
                <div class="stat-card primary">
                  <div class="stat-value" id="totalEvents">-</div>
                  <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card success">
                  <div class="stat-value" id="upcomingEvents">-</div>
                  <div class="stat-label">Upcoming Events</div>
                </div>
                <div class="stat-card warning">
                  <div class="stat-value" id="totalEventRegistrations">-</div>
                  <div class="stat-label>Total Registrations</div>
                </div>
                <div class="stat-card info">
                  <div class="stat-value" id="avgCapacityFilled">-%</div>
                  <div class="stat-label">Avg Capacity Fillled</div> 
                </div>
              </div>
              
              <div class="chart-header">
                <h3 class="card-title">Popular Events</h3>
              </div>
              <div id="popularEventsList">
                <p class="text-muted text-center">Loading Statistics...</p>
              </div>
            </div>
          </div> 
          <div id="eventModal" class="modal" style="display: none;">
             <div class="modal-content">
                <span class="modal-close" onclick="closeEventModal()">&times;</span>
                <h2 id="modalEventTitle"></h2>
                <div id="modalEventContent"></div>
              </div>
            </div>
          </div>    
        </div>
      </div>  

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <a href="https://app.brevo.com" target="_blank" class="btn btn-primary">
              🚀 Open Brevo Dashboard
            </a>
            <button class="btn btn-success" onclick="window.open('/signup', '_blank')">
              👁️ Preview Signup Page
            </button>
            <button class="btn btn-secondary" onclick="manualBrevoSync()">
              🔄 Manual Brevo Sync
            </button>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Activity</h3>
          </div>
          <div id="activityLog">
            <div style="text-align: center; padding: 30px; color: #aaaaaa;">
              <div class="spinner"></div>
              <p style="margin-top: 15px;">Loading activity...</p>
            </div>
          </div>
        </div>

        <!-- System Status -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">System Status</h3>
          </div>
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #ffffff;">Backend Server</span>
              <span class="text-success" id="serverStatus">⏳ Checking...</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #ffffff;">Brevo API</span>
              <span class="text-success" id="brevoStatus">⏳ Checking...</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #ffffff;">Last Activity</span>
              <span class="text-muted" id="lastActivity">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <script>
    // Configuration
    const API_BASE = 'https://sidequest-newsletter-production.up.railway.app';
    

    let calendar;

    // Initialize FullCalendar
    function initFullCalendar() {
      const calendarEl = document.getElementById('fullCalendar');
      
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listWeek'
        },
        height: 'auto',
        events: loadCalendarEvents,
        
        // Event styling based on type
        eventDidMount: function(info) {
          const eventType = info.event.extendedProps.event_type || 'default';
          info.el.classList.add(eventType);
        },
        
        dateClick: function(info) {
        // Pre-fill the date in create form
        const selectedDate = info.dateStr + 'T18:00'; // Format: 2025-08-22T18:00
        
        // Switch to events tab first
        document.querySelector('.tab[data-tab="events"]').click();
        
        // Small delay to ensure tab loads, then switch to create view and set date
        setTimeout(() => {
          switchEventView('create');

              // Set the date after view loads
              setTimeout(() => {
                const dateInput = document.getElementById('eventDateTime');
                if (dateInput) {
                  dateInput.value = selectedDate;
                  console.log('Date set to:', selectedDate); // For debugging
                } else {
                  console.error('eventDateTime input not found');
                }
              }, 100);
            }, 100);
        },

        // Add hover tooltips to your FullCalendar config
        eventDidMount: function(info) {
          const eventType = info.event.extendedProps.event_type || 'default';
          info.el.classList.add(eventType);
          
          // Add tooltip on hover
          info.el.setAttribute('title', `${info.event.title}\n${info.event.start.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`);
          
          // Better hover popup
          info.el.addEventListener('mouseenter', function() {
            // Create custom tooltip
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
              position: absolute;
              background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
              color: white;
              padding: 10px 15px;
              border-radius: 8px;
              border: 2px solid #FFD700;
              font-size: 12px;
              font-weight: 600;
              z-index: 9999;
              box-shadow: 0 8px 25px rgba(0,0,0,0.3);
              pointer-events: none;
              max-width: 200px;
            `;
            tooltip.textContent = info.event.title;
            tooltip.id = 'event-tooltip';
            document.body.appendChild(tooltip);
            
            // Position tooltip
            const rect = info.el.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
          });
          
          info.el.addEventListener('mouseleave', function() {
            const tooltip = document.getElementById('event-tooltip');
            if (tooltip) tooltip.remove();
          });
        },
        
        // Click event to view details
        eventClick: function(info) {
          showEventDetails(info.event.id);
        },
        
        dayMaxEvents: 3,
        moreLinkClick: 'popover'
      });
      
      calendar.render();
    }

    // Load events from your backend
    async function loadCalendarEvents(fetchInfo, successCallback, failureCallback) {
      try {
        // Add date range to ensure we get all events in the visible timeframe
        const start = fetchInfo.start.toISOString().split('T')[0];
        const end = fetchInfo.end.toISOString().split('T')[0];
        
        console.log('Loading events from', start, 'to', end); // Debug
        
        const response = await fetch(`${API_BASE}/api/events/calendar?start=${start}&end=${end}`);
        const data = await response.json();
        
        if (data.success) {
          console.log('Total events loaded:', data.events.length); // Debug
          
          const events = data.events.map(event => ({
            id: event.id,
            title: event.title,
            start: event.start || event.date_time,
            end: event.end || event.end_time,
            backgroundColor: event.color,
            borderColor: event.color,
            textColor: getTextColor(event.event_type),
            extendedProps: {
              event_type: event.event_type,
              game_title: event.game_title,
              description: event.description
            }
          }));
          
          successCallback(events);
        } else {
          failureCallback(data.error);
        }
      } catch (error) {
        console.error('Error loading calendar events:', error);
        failureCallback(error);
      }
    }

    // Get text color based on event type
    function getTextColor(eventType) {
      switch(eventType) {
        case 'tournament':
        case 'special':
        case 'birthday':
          return 'white';
        case 'game_night':
        default:
          return '#1a1a1a';
      }
    }

    // Event variables
    let currentEvents = [];
    let currentEditingEventId = null;

    // Initialize event management
    function initializeEventManagement() {
      // Setup event navigation
      document.querySelectorAll('.event-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const view = this.dataset.view;
          switchEventView(view);
        });
      });

      // Setup create event form
      const createEventForm = document.getElementById('createEventForm');
      if (createEventForm) {
        createEventForm.addEventListener('submit', handleCreateEvent);
      }

      // Set default datetime to tomorrow at 7pm
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(19, 0, 0, 0);
      const dateInput = document.getElementById('eventDateTime');
      if (dateInput) {
        dateInput.value = tomorrow.toISOString().slice(0, 16);
      }
    }

    function switchEventView(view) {
      // Update navigation buttons
      document.querySelectorAll('.event-nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.event-nav-btn[data-view="${view}"]`).classList.add('active');

      // Update views
      document.querySelectorAll('.event-view').forEach(v => {
        v.classList.remove('active');
      });
      document.getElementById(`event-${view}-view`).classList.add('active');

      // DON'T reset edit state automatically - only reset when explicitly needed
      // REMOVE ALL THE currentEditingEventId = null; lines from here!

      // Load appropriate data
      switch(view) {
        case 'list':
          loadEvents();
          break;
        case 'calendar':
          loadCalendarView();
          break;
        case 'stats':
          loadEventStats();
          break;
      }
    }

    // Load events list
    async function loadEvents() {
      const listContainer = document.getElementById('eventsList');
      
      try {
        const typeFilter = document.getElementById('eventTypeFilter')?.value || 'all';

        // Show spinner while loading
        listContainer.innerHTML = `
          <div style="text-align: center; padding: 50px; color: #aaaaaa;">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Loading events...</p>
          </div>
        `;

        // Fetch events
        const response = await fetch(`${API_BASE}/api/events?type=${typeFilter}&upcoming=true`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (data.success) {
          currentEvents = data.events;
          renderEventsList(data.events);  // your existing render function
        } else {
          console.error('API returned error:', data.error);
          listContainer.innerHTML = `<p class="text-danger">Failed to load events: ${data.error || 'Unknown error'}</p>`;
        }

      } catch (error) {
        console.error('Error loading events:', error);
        listContainer.innerHTML = `<p class="text-danger">Failed to load events: ${error.message}</p>`;
      }
    }

    // Create event card as DOM element (not HTML string)
    function createEventCardElement(event) {
      const card = document.createElement('div');
      card.className = `event-card ${event.event_type || event.type || ''}`;
      card.onclick = () => showEventDetails(event.id);
      
      // Handle multiple possible date field names and formats
      let eventDate;
      const possibleDateFields = [
        event.date_time, 
        event.start_time, 
        event.startDate, 
        event.start
      ];
      
      for (const dateField of possibleDateFields) {
        if (dateField) {
          eventDate = new Date(dateField);
          if (!isNaN(eventDate.getTime())) {
            break; // Valid date found
          }
        }
      }
      
      // Fallback if no valid date found
      if (!eventDate || isNaN(eventDate.getTime())) {
        eventDate = new Date();
        console.warn('Invalid or missing date for event:', event);
      }
      
      const dateStr = eventDate.toLocaleDateString('en-GB', { 
        weekday: 'short', 
        day: 'numeric', 
        month: 'short' 
      });
      const timeStr = eventDate.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      // Handle different capacity field names
      const registrations = event.attendeeCount || event.registrations || event.current_attendees || 0;
      const capacity = event.maxAttendees || event.capacity || event.max_capacity || 0;
      const capacityText = capacity > 0 ? `${registrations}/${capacity}` : `${registrations} registered`;
      const capacityPercent = capacity > 0 ? (registrations / capacity) * 100 : 0;
      
      // Handle different event type field names
      const eventType = event.event_type || event.type || 'special';
      const eventTitle = event.title || event.name || 'Untitled Event';
      const gameTitle = event.game_title || event.game || event.gameTitle;
      const entryFee = parseFloat(event.entry_fee || event.fee || event.price || 0);
      
      // Build the card content
      card.innerHTML = `
        <div class="event-header">
          <div>
            <h3 class="event-title">${escapeHtml(eventTitle)}</h3>
            ${gameTitle ? `<div class="event-game-subtitle">${escapeHtml(gameTitle)}</div>` : ''}
          </div>
          <span class="event-badge badge-${eventType}">${eventType.replace('_', ' ').toUpperCase()}</span>
        </div>
        
        <div class="event-details">
          <div class="event-detail">
            <span class="event-detail-icon">📅</span>
            ${dateStr}
          </div>
          <div class="event-detail">
            <span class="event-detail-icon">🕒</span>
            ${timeStr}
          </div>
          <div class="event-detail">
            <span class="event-detail-icon">👥</span>
            ${capacityText}
          </div>
          ${entryFee > 0 ? `
            <div class="event-detail">
              <span class="event-detail-icon">💰</span>
              £${entryFee.toFixed(2)}
            </div>
          ` : ''}
        </div>
        
        ${capacity > 0 ? `
          <div class="capacity-bar">
            <div class="capacity-fill" style="width: ${Math.min(capacityPercent, 100)}%"></div>
            <div class="capacity-text">${Math.round(capacityPercent)}% Full</div>
          </div>
        ` : ''}
        
        <div class="event-actions">
          <button class="btn btn-primary" onclick="quickRegister(${event.id}); event.stopPropagation();">
            QUICK REGISTER
          </button>
          <button class="btn btn-secondary" onclick="editEvent(${event.id}); event.stopPropagation();">
            EDIT EVENT
          </button>
          <button class="btn btn-success" onclick="viewAttendees(${event.id}); event.stopPropagation();">
            VIEW ATTENDEES
          </button>
          <button class="btn btn-warning" onclick="sendEventMarketing(${event.id}); event.stopPropagation();">
            📊 MARKETING
          </button>
        </div>
      `;
      
      return card;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Marketing function wrapper (called by event card buttons)
    async function sendEventMarketing(eventId) {
      return showMarketing(eventId);
    }

    async function showMarketing(eventId) {
      try {
        // Get event details first
        const event = currentEvents.find(e => e.id === eventId);
        if (!event) {
          alert('Event data not found');
          return;
        }
        
        const signupUrl = `${window.location.origin}/event/${eventId}/signup`;
        
        // Generate QR code using QR Server API
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(signupUrl)}`;
        
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = '📊 Marketing Assets - ' + event.title;
        
        modalContent.innerHTML = `
          <div style="display: grid; gap: 25px;">
            
            <!-- Event Summary -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 20px; border-left: 4px solid #FFD700;">
              <h4 style="color: #FFD700; margin-bottom: 15px;">📋 Event Summary</h4>
              <div style="display: grid; gap: 10px; color: #ccc; font-size: 0.9rem;">
                <div><strong>Game:</strong> ${event.game_title || 'Not specified'}</div>
                <div><strong>Date:</strong> ${new Date(event.date_time).toLocaleDateString('en-GB', { 
                  weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
                })}</div>
                <div><strong>Time:</strong> ${new Date(event.date_time).toLocaleTimeString('en-GB', { 
                  hour: '2-digit', minute: '2-digit' 
                })}</div>
                <div><strong>Capacity:</strong> ${event.capacity > 0 ? event.capacity + ' players' : 'Unlimited'}</div>
                <div><strong>Fee:</strong> ${event.entry_fee > 0 ? '£' + event.entry_fee : 'FREE'}</div>
              </div>
            </div>
            
            <!-- Signup URL -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
              <h4 style="color: #FFD700; margin-bottom: 15px;">🌐 Public Signup URL</h4>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" value="${signupUrl}" readonly 
                      style="flex: 1; padding: 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 0.85rem;">
                <button class="btn btn-primary btn-sm" onclick="copyToClipboard('${signupUrl}')">📋 Copy</button>
                <button class="btn btn-success btn-sm" onclick="window.open('${signupUrl}', '_blank')">👁️ Preview</button>
              </div>
            </div>
            
            <!-- QR Code -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 20px; text-align: center;">
              <h4 style="color: #FFD700; margin-bottom: 15px;">📱 QR Code</h4>
              <img src="${qrCodeUrl}" style="max-width: 200px; border-radius: 8px; background: white; padding: 10px;" 
                  alt="QR Code for ${event.title}">
              <div style="margin-top: 15px;">
                <button class="btn btn-primary btn-sm" onclick="downloadQR('${qrCodeUrl}', '${event.title}')">💾 Download</button>
              </div>
              <p style="font-size: 0.8rem; color: #aaa; margin-top: 10px;">Scan to register for this event</p>
            </div>
            
            <!-- Social Media Text -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
              <h4 style="color: #FFD700; margin-bottom: 15px;">📱 Social Media Copy</h4>
              <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <pre style="color: #ccc; font-family: inherit; margin: 0; white-space: pre-wrap;">🎮 ${event.title} at SideQuest Canterbury!

    📅 ${new Date(event.date_time).toLocaleDateString('en-GB', { 
      weekday: 'long', day: 'numeric', month: 'long' 
    })}
    ⏰ ${new Date(event.date_time).toLocaleTimeString('en-GB', { 
      hour: '2-digit', minute: '2-digit' 
    })}
    ${event.game_title ? '🎯 Game: ' + event.game_title + '\n' : ''}${event.entry_fee > 0 ? '💰 Entry: £' + event.entry_fee + '\n' : '🆓 FREE Entry!\n'}
    Register: ${signupUrl}

    #Gaming #${event.game_title ? event.game_title.replace(/\s+/g, '') : 'Gaming'} #Canterbury #SideQuest</pre>
              </div>
              <button class="btn btn-primary btn-sm" onclick="copySocialText('${event.title}', '${event.date_time}', '${event.game_title || ''}', ${event.entry_fee || 0}, '${signupUrl}')">
                📋 Copy Social Text
              </button>
            </div>
            
            <!-- Email Template -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 20px;">
              <h4 style="color: #FFD700; margin-bottom: 15px;">📧 Email Announcement</h4>
              <button class="btn btn-success" onclick="createEventAnnouncement(${eventId})">
                📧 Create Email Campaign
              </button>
              <p style="font-size: 0.85rem; color: #aaa; margin-top: 10px;">
                This will take you to the campaigns tab with pre-filled content
              </p>
            </div>
            
          </div>
          
          <div style="margin-top: 25px; text-align: center;">
            <button class="btn btn-secondary" onclick="closeEventModal()">Close</button>
          </div>
        `;
        
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error('Error showing marketing assets:', error);
        alert('Failed to load marketing assets: ' + error.message);
      }
    }
    


    

    // Render events list
    function renderEventsList(events) {
      const listContainer = document.getElementById('eventsList');
      
      if (!events || events.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <h3>No events found</h3>
            <p>No upcoming events match your current filter criteria.</p>
          </div>
        `;
        return;
      }

      // Clear container completely first
      listContainer.innerHTML = '';
      
      // Create each event as a separate DOM element (not HTML string)
      events.forEach(event => {
        const eventCard = createEventCardElement(event);
        listContainer.appendChild(eventCard);
      });
    }
    function copySocialText(title, dateTime, gameTitle, entryFee, signupUrl) {
      const eventDate = new Date(dateTime);
      const socialText = `🎮 ${title} at SideQuest Canterbury!

    📅 ${eventDate.toLocaleDateString('en-GB', { 
      weekday: 'long', day: 'numeric', month: 'long' 
    })}
    ⏰ ${eventDate.toLocaleTimeString('en-GB', { 
      hour: '2-digit', minute: '2-digit' 
    })}
    ${gameTitle ? '🎯 Game: ' + gameTitle + '\n' : ''}${entryFee > 0 ? '💰 Entry: £' + entryFee + '\n' : '🆓 FREE Entry!\n'}
    Register: ${signupUrl}

    #Gaming #${gameTitle ? gameTitle.replace(/\s+/g, '') : 'Gaming'} #Canterbury #SideQuest`;
      
      copyToClipboard(socialText);
    }

    function createEventAnnouncement(eventId) {
      const event = currentEvents.find(e => e.id === eventId);
      if (!event) {
        alert('Event data not found');
        return;
      }
      
      closeEventModal();
      document.querySelector('.tab[data-tab="campaigns"]').click();
      
      setTimeout(() => {
        const subjectField = document.getElementById('campaignSubject');
        if (subjectField) {
          subjectField.value = `🎮 New Event: ${event.title}`;
        }
        
        const bodyField = document.getElementById('campaignBody');
        if (bodyField) {
          bodyField.value = `Professional HTML email template here...`;
        }
        
        showSuccess('📧 Email template created!');
      }, 500);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccess('📋 Copied to clipboard!');
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('📋 Copied to clipboard!');
      });
    }

    function downloadQR(dataUrl, eventTitle) {
      try {
        const link = document.createElement('a');
        link.download = `${eventTitle ? eventTitle.replace(/[^a-zA-Z0-9]/g, '_') : 'event'}_qr_code.png`;
        link.href = dataUrl;
        link.click();
        showSuccess('💾 QR code downloaded!');
      } catch (error) {
        window.open(dataUrl, '_blank');
        showSuccess('💾 QR code opened in new window!');
      }
    }




    // Add these helper functions too
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccess('📋 Copied to clipboard!');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('📋 Copied to clipboard!');
      });
    }

    function downloadQR(dataUrl, eventTitle) {
      try {
        const link = document.createElement('a');
        link.download = `${eventTitle ? eventTitle.replace(/[^a-zA-Z0-9]/g, '_') : 'event'}_qr_code.png`;
        link.href = dataUrl;
        link.click();
        showSuccess('💾 QR code downloaded!');
      } catch (error) {
        console.error('Error downloading QR code:', error);
        // Fallback - open in new window
        window.open(dataUrl, '_blank');
        showSuccess('💾 QR code opened in new window!');
      }
    }
   

    // Fixed handleCreateEvent function
    async function handleCreateEvent(e) {
    e.preventDefault();
    
    if (e.target.dataset.submitting === 'true') return;
    e.target.dataset.submitting = 'true';

    // ADD THESE DEBUG LINES:
    console.log('DEBUG: currentEditingEventId =', currentEditingEventId);
    const isEditing = currentEditingEventId !== null;
    console.log('DEBUG: isEditing =', isEditing);
      
      try {
        const eventData = {
          title: document.getElementById('eventTitle').value,
          event_type: document.getElementById('eventType').value,
          game_title: document.getElementById('gameTitle').value,
          date_time: document.getElementById('eventDateTime').value,
          end_time: document.getElementById('eventEndTime').value,
          capacity: parseInt(document.getElementById('eventCapacity').value) || 0,
          entry_fee: parseFloat(document.getElementById('eventFee').value) || 0,
          status: document.getElementById('eventStatus').value,
          description: document.getElementById('eventDescription').value,
          prize_pool: document.getElementById('eventPrizes').value,
          requirements: document.getElementById('eventRequirements').value
        };

        let response;


        if (isEditing) {
              console.log('DEBUG: Making PUT request to update event:', currentEditingEventId);
              response = await fetch(`${API_BASE}/api/events/${currentEditingEventId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventData)
              });
            } else {
              console.log('DEBUG: Making POST request to create new event');
              response = await fetch(`${API_BASE}/api/events`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventData)
              });
            }

      const data = await response.json();

      if (data.success) {
        const action = isEditing ? 'updated' : 'created'; // Fix: Use isEditing variable consistently
        showSuccess(`Event ${action} successfully!`);
        
        // Reset edit state and form
        currentEditingEventId = null;
        resetCreateFormUI();
        resetEventForm();
        switchEventView('list');
        
        // If published, offer to send announcement (only for new events)
        if (!isEditing && eventData.status === 'published') { // Fix: Use isEditing here too
          if (confirm('Would you like to send an announcement email to all subscribers?')) {
            sendEventAnnouncement(data.event_id);
          }
        }
      } else {
        alert('Error: ' + (data.error || `Failed to ${isEditing ? 'update' : 'create'} event`)); // Fix: Use isEditing
      }
      } catch (error) {
        const isEditing = currentEditingEventId !== null;
        console.error(`Error ${isEditing ? 'updating' : 'creating'} event:`, error);
        alert(`Failed to ${isEditing ? 'update' : 'create'} event`);
      } finally {
        e.target.dataset.submitting = 'false';
      }
    }

    // Quick register subscriber to event
    // Also enhance the quickRegister function to refresh attendees after registration:
    async function quickRegister(eventId) {
      const email = prompt('Enter subscriber email to register:');
      if (!email) return;

      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email.trim().toLowerCase() })
        });

        const data = await response.json();
        
        if (data.success) {
          showSuccess(`✅ Registered ${email} - Confirmation: ${data.confirmation_code}`);
          loadEvents(); // Refresh the events list
          
          // Refresh attendees modal if it's open
          const modal = document.getElementById('eventModal');
          if (modal && modal.style.display === 'flex') {
            setTimeout(() => viewAttendees(eventId), 500);
          }
        } else {
          alert('❌ Error: ' + (data.error || 'Failed to register'));
        }
    } catch (error) {
      console.error(`Error ${isEditing ? 'updating' : 'creating'} event:`, error);
      alert(`Failed to ${isEditing ? 'update' : 'create'} event`);
    }
    }

    // View event attendees
    async function viewAttendees(eventId) {
      console.log(`Attempting to view attendees for event ${eventId}`);
      
      try {
        // Show loading in modal immediately
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = 'Loading Attendees...';
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 50px;">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #aaa;">Loading attendee list...</p>
          </div>
        `;
        modal.style.display = 'flex';
        
        // First, let's debug what's happening
        console.log(`Making request to: ${API_BASE}/api/events/${eventId}/attendees`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/attendees`);
        
        console.log(`Response status: ${response.status}`);
        console.log(`Response ok: ${response.ok}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Attendees response data:', data);
        
        if (data.success) {
          const event = currentEvents.find(e => e.id === eventId);
          const eventTitle = event ? event.title : data.event_title || `Event ${eventId}`;
          
          showAttendeesModal({ 
            id: eventId, 
            title: eventTitle 
          }, data.attendees);
          
          console.log(`Successfully loaded ${data.attendees.length} attendees`);
        } else {
          throw new Error(data.error || 'Failed to load attendees');
        }
        
      } catch (error) {
        console.error('Error loading attendees:', error);
        
        // Show error in modal
        const modal = document.getElementById('eventModal');
        const modalTitle = document.getElementById('modalEventTitle');
        const modalContent = document.getElementById('modalEventContent');
        
        modalTitle.textContent = 'Error Loading Attendees';
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ff6b35;">
            <p>❌ Failed to load attendees</p>
            <p style="font-size: 0.9rem; color: #aaa; margin-top: 10px;">
              Error: ${error.message}
            </p>
            <button class="btn btn-primary mt-20" onclick="debugEventRegistrations(${eventId})">
              🔍 Debug Event Data
            </button>
            <button class="btn btn-secondary mt-20" onclick="closeEventModal()">
              Close
            </button>
          </div>
        `;
        modal.style.display = 'flex';
      }
    }
    


    // Load event statistics
    async function loadEventStats() {
      try {
        const response = await fetch(`${API_BASE}/api/events/stats`);
        const data = await response.json();
        
        if (data.success) {
          // Update stat cards
          document.getElementById('totalEvents').textContent = data.stats.total_events;
          document.getElementById('upcomingEvents').textContent = data.stats.upcoming_events;
          document.getElementById('totalEventRegistrations').textContent = data.stats.total_registrations;
          document.getElementById('avgCapacityFilled').textContent = data.stats.avg_capacity_filled + '%';
          
          // Render popular events
          const popularList = document.getElementById('popularEventsList');
          if (data.popular_events && data.popular_events.length > 0) {
            popularList.innerHTML = data.popular_events.map((event, index) => `
              <div style="display: flex; justify-content: space-between; padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 10px;">
                <div>
                  <span style="color: #FFD700; font-weight: 700;">#${index + 1}</span>
                  <span style="margin-left: 10px; color: #fff;">${event.title}</span>
                </div>
                <div>
                  <span class="event-badge badge-${event.event_type}" style="margin-right: 10px;">${event.event_type.replace('_', ' ')}</span>
                  <span style="color: #FFD700; font-weight: 600;">${event.registration_count} registrations</span>
                </div>
              </div>
            `).join('');
          } else {
            popularList.innerHTML = '<p class="text-muted text-center">No events data yet</p>';
          }
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Add debug function to test what's in the database:
    async function debugEventRegistrations(eventId) {
      try {
        console.log(`Debugging event ${eventId}...`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/debug`);
        const data = await response.json();
        
        console.log('Debug data:', data);
        
        alert(`Debug Results for Event ${eventId}:
        
    Event Exists: ${data.event_exists}
    Registration Count: ${data.registration_count}
    All Event Registrations: ${JSON.stringify(data.all_event_registrations, null, 2)}

    Check console for full details.`);
        
      } catch (error) {
        console.error('Debug error:', error);
        alert('Debug failed: ' + error.message);
      }
    }

    // Add refresh function:
    async function refreshAttendees(eventId) {
      await viewAttendees(eventId);
    }

    // Add refresh function:
    async function refreshAttendees(eventId) {
      await viewAttendees(eventId);
    }

    // Search and filter functions for attendees
    function filterAttendees() {
      const searchTerm = document.getElementById('attendeeSearch').value.toLowerCase();
      const attendeeItems = document.querySelectorAll('.attendee-item');
      const noResults = document.getElementById('noResults');
      let visibleCount = 0;
      
      attendeeItems.forEach(item => {
        const email = item.dataset.email || '';
        const name = item.dataset.name || '';
        const code = item.dataset.code || '';
        
        const matches = email.includes(searchTerm) || 
                       name.includes(searchTerm) || 
                       code.includes(searchTerm);
        
        if (matches) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Show/hide "no results" message
      if (visibleCount === 0 && searchTerm.length > 0) {
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
      }
    }
    
    function filterByStatus(status) {
      const attendeeItems = document.querySelectorAll('.attendee-item');
      const searchInput = document.getElementById('attendeeSearch');
      const noResults = document.getElementById('noResults');
      let visibleCount = 0;
      
      // Clear search when using status filter
      searchInput.value = '';
      
      attendeeItems.forEach(item => {
        const itemStatus = item.dataset.status;
        
        if (status === 'all' || itemStatus === status) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Update filter button states
      setActiveFilter(status);
      
      // Show/hide "no results" message
      if (visibleCount === 0) {
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
      }
    }
    
    function setActiveFilter(activeStatus) {
      // Remove active class from all filter buttons
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      });
      
      // Add active class to selected filter
      const activeBtn = document.getElementById(`filter-${activeStatus}`);
      if (activeBtn) {
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
      }
    }
    
    function clearSearch() {
      document.getElementById('attendeeSearch').value = '';
      filterByStatus('all');
    }

    // Check in attendee function
    async function checkinAttendee(eventId, email) {
      try {
        console.log(`🔍 Attempting check-in for Event ${eventId}, Email: ${email}`);
        
        const response = await fetch(`${API_BASE}/api/events/${eventId}/checkin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        });

        console.log(`📡 Response status: ${response.status}`);
        
        const data = await response.json();
        console.log('📡 Response data:', data);
        
        if (data.success) {
          showSuccess(`✅ Checked in ${email} - Code: ${data.confirmation_code}`);
          // Refresh the attendees modal
          setTimeout(() => viewAttendees(eventId), 500);
        } else {
          console.error('❌ Check-in failed:', data.error);
          alert('❌ Check-in failed: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('❌ Network error during check-in:', error);
        alert('❌ Network error: ' + error.message);
      }
    }

    // Show attendees modal
    function showAttendeesModal(event, attendees) {
      console.log('Showing attendees modal for:', event.title, 'with', attendees.length, 'attendees');
      
      const modal = document.getElementById('eventModal');
      const modalTitle = document.getElementById('modalEventTitle');
      const modalContent = document.getElementById('modalEventContent');
      
      modalTitle.textContent = `👥 Attendees: ${event.title}`;
      
      let content = `
        <div style="margin-bottom: 20px;">
          <p><strong>Total Registered:</strong> ${attendees.length}</p>
          <p><strong>Attended:</strong> ${attendees.filter(a => a.attended).length}</p>
        </div>
      `;
      
      if (attendees.length === 0) {
        content += `
          <div style="text-align: center; padding: 40px; color: #aaa;">
            <p>📭 No registrations yet</p>
            <button class="btn btn-primary mt-20" onclick="quickRegister(${event.id})">
              Add First Registration
            </button>
          </div>
        `;
      } else {
        // Add search/filter box
        content += `
          <div style="margin-bottom: 20px;">
            <div style="position: relative;">
              <input type="text" id="attendeeSearch" class="form-input" 
                     placeholder="Search by email, name, or confirmation code..." 
                     style="padding-left: 50px; margin-bottom: 15px;"
                     oninput="filterAttendees()">
              <span style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #FFD700; font-size: 18px;">🔍</span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('all')" id="filter-all">All</button>
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('registered')" id="filter-registered">Not Checked In</button>
              <button class="btn btn-secondary btn-sm" onclick="filterByStatus('attended')" id="filter-attended">Checked In</button>
            </div>
          </div>
        `;
        
        content += '<div class="attendee-list" id="attendeeListContainer">';
        
        attendees.forEach((attendee, index) => {
          const statusClass = attendee.attended ? 'status-attended' : 'status-registered';
          const statusText = attendee.attended ? 'Attended' : 'Registered';
          const registeredDate = attendee.registered_at ? 
            new Date(attendee.registered_at).toLocaleDateString() : 'Unknown';
          
          content += `
            <div class="attendee-item" data-email="${attendee.subscriber_email.toLowerCase()}" 
                 data-name="${(attendee.player_name || '').toLowerCase()}" 
                 data-code="${attendee.confirmation_code.toLowerCase()}"
                 data-status="${attendee.attended ? 'attended' : 'registered'}"
                 data-index="${index}">
              <div>
                <div class="attendee-email">${attendee.subscriber_email}</div>
                <div style="color: #aaa; font-size: 0.8rem; margin-top: 5px;">
                  Player: ${attendee.player_name || 'Not specified'} | 
                  <strong style="color: #FFD700;">Code: ${attendee.confirmation_code}</strong> | 
                  Registered: ${registeredDate}
                </div>
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <span class="attendee-status ${statusClass}">${statusText}</span>
                ${!attendee.attended ? `
                  <button class="btn btn-success btn-sm" onclick="checkinAttendee(${event.id}, '${attendee.subscriber_email}')">
                    ✓ Check In
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        });
        
        content += '</div>';
        
        // Add "No results" message (hidden by default)
        content += `
          <div id="noResults" style="display: none; text-align: center; padding: 40px; color: #aaa;">
            <p>🔍 No attendees match your search</p>
            <button class="btn btn-secondary btn-sm" onclick="clearSearch()">Clear Search</button>
          </div>
        `;
      }
      
      // Add action buttons
      content += `
        <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #444;">
          <button class="btn btn-primary" onclick="quickRegister(${event.id})">
            ➕ Add Registration
          </button>
          <button class="btn btn-secondary" onclick="refreshAttendees(${event.id})">
            🔄 Refresh
          </button>
          <button class="btn btn-secondary" onclick="closeEventModal()">
            Close
          </button>
        </div>
      `;
      
      modalContent.innerHTML = content;
      modal.style.display = 'flex';
      
      // Set initial filter state
      setActiveFilter('all');
    }


    // Load calendar view
    function loadCalendarView() {
      setTimeout(() => {
        if (!calendar) {
          initFullCalendar();
        } else {
          calendar.refetchEvents();
        }
      }, 100);
    }

    // Form submission
    document.addEventListener('DOMContentLoaded', function() {
      const fcForm = document.getElementById('fcEventForm');
      if (fcForm) {
        fcForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const eventData = {
            title: document.getElementById('fcEventTitle').value,
            event_type: document.getElementById('fcEventType').value,
            game_title: document.getElementById('fcEventGame').value,
            date_time: document.getElementById('fcEventDate').value + 'T' + document.getElementById('fcEventTime').value,
            end_time: document.getElementById('fcEventDate').value + 'T' + document.getElementById('fcEventEndTime').value,
            description: document.getElementById('fcEventDescription').value,
            capacity: 0,
            entry_fee: 0,
            status: 'draft'
          };

          try {
            const response = await fetch(`${API_BASE}/api/events`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(eventData)
            });

            const data = await response.json();
            
            if (data.success) {
              closeFCModal();
              if (calendar) calendar.refetchEvents();
              showSuccess('Event created successfully!');
            } else {
              alert('Error: ' + (data.error || 'Failed to create event'));
            }
          } catch (error) {
            console.error('Error creating event:', error);
            alert('Failed to create event');
          }
        });
      }

      // Close modal when clicking outside
      const modal = document.getElementById('fcEventModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            closeFCModal();
          }
        });
      }
    });



    // Modal functions
    function closeFCModal() {
      document.getElementById('fcEventModal').style.display = 'none';
      document.getElementById('fcEventForm').reset();
    }

    function refreshCalendar() {
      if (calendar) {
        calendar.refetchEvents();
        showSuccess('Calendar refreshed!');
      }
    }

    // Simple calendar renderer
    function renderCalendar(events) {
      const calendarEl = document.getElementById('eventCalendar');
      
      // Group events by date
      const eventsByDate = {};
      events.forEach(event => {
        const date = new Date(event.start).toDateString();
        if (!eventsByDate[date]) {
          eventsByDate[date] = [];
        }
        eventsByDate[date].push(event);
      });
      
      // Render simple calendar view
      let html = '<div style="display: grid; gap: 20px;">';
      
      Object.keys(eventsByDate).sort().forEach(date => {
        const dateEvents = eventsByDate[date];
        const dateObj = new Date(date);
        
        html += `
          <div style="background: #2a2a2a; border-radius: 12px; padding: 20px; border-left: 4px solid #FFD700;">
            <h3 style="color: #FFD700; margin-bottom: 15px;">
              ${dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
            </h3>
            <div style="display: grid; gap: 10px;">
        `;
        
        dateEvents.forEach(event => {
          const startTime = new Date(event.start).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const endTime = event.end ? new Date(event.end).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
          
          html += `
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 3px solid ${event.color}; cursor: pointer;"
                onclick="showEventDetails(${event.id})">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <div style="color: #fff; font-weight: 600;">${event.title}</div>
                  <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                    🕐 ${startTime}${endTime ? ' - ' + endTime : ''}
                  </div>
                  ${event.description ? `<div style="color: #ccc; font-size: 0.85rem; margin-top: 5px;">👥 ${event.description}</div>` : ''}
                </div>
                <div style="width: 10px; height: 10px; background: ${event.color}; border-radius: 50%;"></div>
              </div>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      
      if (events.length === 0) {
        html = '<p class="text-muted text-center">No events scheduled</p>';
      }
      
      calendarEl.innerHTML = html;
    }

    // Show event details modal
    async function showEventDetails(eventId) {
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        const data = await response.json();
        
        if (data.success) {
          const event = data.event;
          const modal = document.getElementById('eventModal');
          
          document.getElementById('modalEventTitle').textContent = event.title;
          
          const eventDate = new Date(event.date_time);
          const endDate = event.end_time ? new Date(event.end_time) : null;
          
          let content = `
            <div style="display: grid; gap: 15px;">
              ${event.game_title ? `<p><strong>Game:</strong> ${event.game_title}</p>` : ''}
              <p><strong>Type:</strong> <span class="event-badge badge-${event.event_type}">${event.event_type.replace('_', ' ')}</span></p>
              <p><strong>Date:</strong> ${eventDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p><strong>Time:</strong> ${eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}${endDate ? ' - ' + endDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : ''}</p>
              ${event.entry_fee > 0 ? `<p><strong>Entry Fee:</strong> £${event.entry_fee}</p>` : ''}
              ${event.capacity > 0 ? `<p><strong>Capacity:</strong> ${event.registration_count}/${event.capacity} registered</p>` : `<p><strong>Registrations:</strong> ${event.registration_count}</p>`}
              ${event.description ? `<p><strong>Description:</strong><br>${event.description}</p>` : ''}
              ${event.prize_pool ? `<p><strong>Prizes:</strong><br>${event.prize_pool}</p>` : ''}
              ${event.requirements ? `<p><strong>Requirements:</strong><br>${event.requirements}</p>` : ''}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" onclick="viewAttendees(${event.id})">View Attendees</button>
              <button class="btn btn-secondary" onclick="editEvent(${event.id})">Edit Event</button>
              <button class="btn btn-danger" onclick="deleteEvent(${event.id})">Delete Event</button>
            </div>
          `;
          
          document.getElementById('modalEventContent').innerHTML = content;
          modal.style.display = 'flex';
        }
      } catch (error) {
        console.error('Error loading event details:', error);
        alert('Failed to load event details');
      }
    }

    // Modified editEvent function
    async function editEvent(eventId) {
      console.log('EDIT DEBUG: Setting currentEditingEventId to:', eventId); // ADD THIS
      
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`);
        const data = await response.json();
        
        if (!data.success) {
          alert('Failed to load event data');
          return;
        }
        
        const event = data.event;
        currentEditingEventId = eventId; // Make sure this line exists
        console.log('EDIT DEBUG: currentEditingEventId is now:', currentEditingEventId); // ADD THIS

        switchEventView('create');
        fillFormWithEventData(event);
        updateCreateFormForEdit(event.title);
        closeEventModal();
        
      } catch (error) {
        console.error('Error loading event for edit:', error);
        alert('Failed to load event data');
        currentEditingEventId = null;
      }
    }

    
    function updateCreateFormForEdit(eventTitle) {
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = `Edit Event: ${eventTitle}`;
        formTitle.style.color = '#FFD700';
      } else {
        console.warn('Form title element not found');
      }

        // Update submit button with error handling
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Update Event';
        submitButton.classList.add('btn-warning'); // Different style for update
        submitButton.classList.remove('btn-primary');
      } else {
        console.warn('Submit button not found');
      }
      
      // Add cancel button if it doesn't exist
      let cancelButton = document.getElementById('cancelEditButton');
      if (!cancelButton && submitButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'cancelEditButton';
        cancelButton.type = 'button';
        cancelButton.className = 'btn btn-secondary ms-2';
        cancelButton.innerHTML = '❌ Cancel Edit';
        cancelButton.onclick = cancelEdit;
        
        // Insert after submit button
        submitButton.parentNode.insertBefore(cancelButton, submitButton.nextSibling);
      }
    }

    // Delete event
    async function deleteEvent(eventId) {
      if (!confirm('Are you sure you want to delete this event?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/events/${eventId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showSuccess('Event deleted successfully');
          closeEventModal();
          loadEvents();
        } else {
          if (data.error.includes('registrations')) {
            if (confirm('This event has registrations. Delete anyway?')) {
              const forceResponse = await fetch(`${API_BASE}/api/events/${eventId}?force=true`, {
                method: 'DELETE'
              });
              const forceData = await forceResponse.json();
              if (forceData.success) {
                showSuccess('Event deleted successfully');
                closeEventModal();
                loadEvents();
              }
            }
          } else {
            alert('Error: ' + data.error);
          }
        }
      } catch (error) {
        console.error('Error deleting event:', error);
        alert('Failed to delete event');
      }
    }

    // Send event announcement email
    async function sendEventAnnouncement(eventId) {
      try {
        const eventResponse = await fetch(`${API_BASE}/api/events/${eventId}`);
        const eventData = await eventResponse.json();
        
        if (!eventData.success) return;
        
        const event = eventData.event;
        const eventDate = new Date(event.date_time);
        
        const subject = `New Event: ${event.title}`;
        const body = `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #FFD700;">🎮 New Event at SideQuest!</h1>
            <h2>${event.title}</h2>
            <p><strong>Date:</strong> ${eventDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
            <p><strong>Time:</strong> ${eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</p>
            ${event.game_title ? `<p><strong>Game:</strong> ${event.game_title}</p>` : ''}
            ${event.entry_fee > 0 ? `<p><strong>Entry Fee:</strong> £${event.entry_fee}</p>` : '<p><strong>Entry:</strong> FREE!</p>'}
            ${event.description ? `<p>${event.description}</p>` : ''}
            ${event.prize_pool ? `<p><strong>Prizes:</strong> ${event.prize_pool}</p>` : ''}
            <p style="margin-top: 30px;">
              <a href="${window.location.origin}/signup" style="background: #FFD700; color: #1a1a1a; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold;">
                Register Now
              </a>
            </p>
            <p style="color: #888; font-size: 12px; margin-top: 30px;">
              You're receiving this because you're subscribed to SideQuest Gaming Cafe updates.
            </p>
          </div>
        `;
        
        const response = await fetch(`${API_BASE}/send-campaign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            body,
            fromName: 'SideQuest Events',
            recipients: subscribers // Assuming subscribers array is available
          })
        });
        
        const data = await response.json();
        if (data.success) {
          showSuccess(`Event announcement sent to ${data.sent} subscribers!`);
        }
      } catch (error) {
        console.error('Error sending announcement:', error);
        alert('Failed to send announcement');
      }
    }

    // Close event modal
    function closeEventModal() {
      document.getElementById('eventModal').style.display = 'none';
    }

    // Reset event form
    function resetEventForm() {
      document.getElementById('createEventForm').reset();
      currentEditingEventId = null; // Reset edit state
      resetCreateFormUI(); // Reset UI
      
      // Set default datetime to tomorrow at 7pm
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(19, 0, 0, 0);
      const dateInput = document.getElementById('eventDateTime');
      if (dateInput) {
        dateInput.value = tomorrow.toISOString().slice(0, 16);
      }
    }

    // Call initialization when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Wait a bit to ensure main dashboard is initialized first
      setTimeout(() => {
        initializeEventManagement();
      }, 500);
    });

    function fillFormWithEventData(event) {
      const fields = {
        'eventTitle': event.title,
        'eventType': event.event_type,
        'gameTitle': event.game_title || '',
        'eventDateTime': event.date_time ? event.date_time.slice(0, 16) : '',
        'eventCapacity': event.capacity || 0,
        'eventFee': event.entry_fee || 0,
        'eventStatus': event.status,
        'eventDescription': event.description || '',
        'eventEndTime': event.end_time ? event.end_time.slice(0, 16) : '',
        'eventPrizes': event.prize_pool || '',
        'eventRequirements': event.requirements || ''
      };
      
      Object.entries(fields).forEach(([fieldId, value]) => {
        const element = document.getElementById(fieldId);
        if (element) {
          element.value = value;
        }
      });
    }

    function updateCreateFormForEdit(eventTitle) {
      // Update form title
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = `Edit Event: ${eventTitle}`;
        formTitle.style.color = '#ff6b35'; // Orange color to indicate edit mode
      }
      
      // Update submit button
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Update Event';
        submitButton.classList.add('btn-warning'); // Different style for update
        submitButton.classList.remove('btn-primary');
      }
      
      // Add cancel button if it doesn't exist
      addCancelButton(submitButton);
    }

    function addCancelButton(submitButton) {
      let cancelButton = document.getElementById('cancelEditButton');
      if (!cancelButton && submitButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'cancelEditButton';
        cancelButton.type = 'button';
        cancelButton.className = 'btn btn-secondary ms-2';
        cancelButton.innerHTML = '❌ Cancel Edit';
        cancelButton.onclick = cancelEdit;
        submitButton.parentNode.insertBefore(cancelButton, submitButton.nextSibling);
      }
    }

    function resetCreateFormUI() {
      // Reset form title
      const formTitle = document.querySelector('#event-create-view .card-title');
      if (formTitle) {
        formTitle.textContent = 'Create New Event';
        formTitle.style.color = '#FFD700'; // Reset to default gold color
      }
      
      // Reset submit button
      const submitButton = document.querySelector('#createEventForm button[type="submit"]');
      if (submitButton) {
        submitButton.textContent = '🎮 Create Event';
        submitButton.classList.remove('btn-warning');
        submitButton.classList.add('btn-primary');
      }
      
      // Remove cancel button
      const cancelButton = document.getElementById('cancelEditButton');
      if (cancelButton) {
        cancelButton.remove();
      }
      
      // Reset global edit state
      currentEditingEventId = null;
    }

    function cancelEdit() {
      currentEditingEventId = null;
      resetCreateFormUI();
      resetEventForm();
      switchEventView('list');
    }

    // Enhance existing tab functionality to load events
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          if (this.dataset.tab === 'events') {
            // Small delay to ensure tab is active
            setTimeout(() => {
              loadEvents();
            }, 100);
          }
        });
      });
    });

    
    // Global variables
    let subscribers = [];
    let subscriberDetails = [];
    let activityLog = [];
    let currentStats = {};
    let growthChart = null;
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initializing...');
      try {
        initializeTabs();
        loadInitialData();
        setupSearch();
        startAutoRefresh();
      } catch (error) {
        console.error('Dashboard initialization error:', error);
      }
    });

    // Load all initial data
    async function loadInitialData() {
      try {
        await Promise.all([
          loadSubscribers(),
          loadStats(),
          loadActivity(),
          checkHealth()
        ]);
      } catch (error) {
        console.error('Error loading initial data:', error);
      }
    }

    // Load subscribers from backend
    async function loadSubscribers() {
      try {
        showLoading('subscriberList');
        const response = await fetch(`${API_BASE}/subscribers`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          subscribers = data.subscribers || [];
          subscriberDetails = data.subscriber_details || [];
          currentStats = data.stats || {};
          
          renderSubscribers();
          updateStats();
          updateCampaignRecipientCount();
          
          // Initialize chart after data is loaded
          setTimeout(() => {
            if (document.getElementById('growthChart')) {
              initializeGrowthChart();
            }
          }, 100);
        } else {
          showError('subscriberList', 'Failed to load subscribers');
        }
      } catch (error) {
        console.error('Error loading subscribers:', error);
        showError('subscriberList', `Connection error: ${error.message}`);
        updateServerStatus(false);
      }
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/stats`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          currentStats = data.stats;
          updateStats();
          document.getElementById('brevoSyncStatus').textContent = data.brevo_sync_status || '❌';
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load activity log
    async function loadActivity() {
      try {
        const response = await fetch(`${API_BASE}/activity`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          activityLog = data.activity || [];
          renderActivityLog();
        }
      } catch (error) {
        console.error('Error loading activity:', error);
        showError('activityLog', 'Failed to load activity');
      }
    }

    // Check backend health
    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        updateServerStatus(true);
        const brevoStatusElement = document.getElementById('brevoStatus');
        if (brevoStatusElement) {
          brevoStatusElement.innerHTML = 
            data.brevo_status === 'connected' ? '🟢 Connected' : `🔴 ${data.brevo_status}`;
          
          // Show more detailed Brevo status if available
          if (data.brevo_email) {
            brevoStatusElement.title = `Connected as: ${data.brevo_email}`;
          }
        }
      } catch (error) {
        console.error('Health check failed:', error);
        updateServerStatus(false);
        const brevoStatusElement = document.getElementById('brevoStatus');
        if (brevoStatusElement) {
          brevoStatusElement.innerHTML = '🔴 Offline';
        }
      }
    }

    // Update server status display
    function updateServerStatus(isOnline) {
      const serverStatusElement = document.getElementById('serverStatus');
      if (serverStatusElement) {
        serverStatusElement.innerHTML = isOnline ? '🟢 Online' : '🔴 Offline';
      }
    }

    // Initialize growth chart
    function initializeGrowthChart() {
      try {
        // Destroy existing chart if it exists
        if (growthChart) {
          growthChart.destroy();
        }
        
        const ctx = document.getElementById('growthChart');
        if (!ctx) {
          console.error('Growth chart canvas not found');
          return;
        }
        
        const chartContext = ctx.getContext('2d');
        
        // Generate sample data for the last 30 days
        const last30Days = [];
        const subscriberCounts = [];
        const today = new Date();
        
        for (let i = 29; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          
          // Calculate cumulative subscriber count for this date
          const dateStr = date.toISOString().split('T')[0];
          const subscribersUpToDate = subscriberDetails.filter(sub => {
            const subDate = new Date(sub.date_added).toISOString().split('T')[0];
            return subDate <= dateStr;
          }).length;
          
          subscriberCounts.push(subscribersUpToDate);
        }
        
        // Create new chart and store reference
        growthChart = new Chart(chartContext, {
          type: 'line',
          data: {
            labels: last30Days,
            datasets: [{
              label: 'Total Subscribers',
              data: subscriberCounts,
              borderColor: '#FFD700',
              backgroundColor: 'rgba(255, 215, 0, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#FFD700',
              pointBorderColor: '#1a1a1a',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#FFD700',
                  font: {
                    weight: 'bold'
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: '#444'
                },
                ticks: {
                  color: '#cccccc'
                }
              },
              x: {
                grid: {
                  color: '#444'
                },
                ticks: {
                  color: '#cccccc',
                  maxRotation: 45
                }
              }
            },
            elements: {
              point: {
                hoverBackgroundColor: '#FFD700'
              }
            }
          }
        });
      } catch (error) {
        console.error('Error initializing growth chart:', error);
      }
    }

    // Render subscribers in the list
    function renderSubscribers(subscribersToRender = subscribers) {
      try {
        const subscriberList = document.getElementById('subscriberList');
        if (!subscriberList) {
          console.error('Subscriber list element not found');
          return;
        }
        
        if (subscribersToRender.length === 0) {
          subscriberList.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #aaaaaa;">
              📭 No subscribers found
            </div>
          `;
          return;
        }

        subscriberList.innerHTML = subscribersToRender.map(email => {
          const details = subscriberDetails.find(d => d.email === email);
          const dateAdded = details ? new Date(details.date_added).toLocaleDateString() : 'Unknown';
          const source = details ? details.source : 'unknown';
          
          return `
            <div class="subscriber-item">
              <div class="subscriber-info">
                <div class="subscriber-email">${email}</div>
                <div class="subscriber-meta">Added: ${dateAdded} • Source: ${source}</div>
              </div>
              <button class="btn btn-danger btn-sm" onclick="removeSubscriber('${email}')">
                🗑️ Remove
              </button>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error rendering subscribers:', error);
      }
    }

    // Add new subscriber
    async function addSubscriber() {
      try {
        const emailInput = document.getElementById('newSubscriberEmail');
        if (!emailInput) {
          console.error('Email input not found');
          return;
        }
        
        const email = emailInput.value.trim();

        if (!email) {
          alert('Please enter an email address');
          return;
        }

        if (!isValidEmail(email)) {
          alert('Please enter a valid email address');
          return;
        }

        const response = await fetch(`${API_BASE}/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, source: 'manual' })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          emailInput.value = '';
          await loadSubscribers();
          await loadActivity();
          showSuccess('Subscriber added successfully!');
        } else {
          alert(data.error || 'Failed to add subscriber');
        }
      } catch (error) {
        console.error('Error adding subscriber:', error);
        alert('Network error. Please try again.');
      }
    }

    // Remove subscriber
    async function removeSubscriber(email) {
      try {
        if (!confirm(`Remove ${email} from subscribers?`)) return;

        const response = await fetch(`${API_BASE}/unsubscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadSubscribers();
          await loadActivity();
          showSuccess('Subscriber removed successfully!');
        } else {
          alert(data.error || 'Failed to remove subscriber');
        }
      } catch (error) {
        console.error('Error removing subscriber:', error);
        alert('Network error. Please try again.');
      }
    }

    // Bulk import subscribers
    async function bulkImport() {
      try {
        const textarea = document.getElementById('bulkEmails');
        if (!textarea) {
          console.error('Bulk emails textarea not found');
          return;
        }
        
        const emailText = textarea.value.trim();
        
        if (!emailText) {
          alert('Please enter some email addresses');
          return;
        }
        
        const emails = emailText.split('\n')
          .map(email => email.trim())
          .filter(email => email && isValidEmail(email));
        
        if (emails.length === 0) {
          alert('No valid email addresses found');
          return;
        }
        
        if (!confirm(`Import ${emails.length} email addresses?`)) return;
        
        const response = await fetch(`${API_BASE}/bulk-import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ emails, source: 'import' })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          textarea.value = '';
          await loadSubscribers();
          await loadActivity();
          
          let message = `Successfully imported ${data.added} subscribers.`;
          if (data.errors && data.errors.length > 0) {
            message += `\n\n${data.errors.length} errors occurred:\n${data.errors.slice(0, 5).join('\n')}`;
            if (data.errors.length > 5) {
              message += `\n... and ${data.errors.length - 5} more errors.`;
            }
          }
          alert(message);
        } else {
          alert(data.error || 'Failed to import subscribers');
        }
      } catch (error) {
        console.error('Error importing subscribers:', error);
        alert('Network error. Please try again.');
      }
    }

    // Manual Brevo sync
    async function manualBrevoSync() {
      try {
        if (!confirm('Manually sync all subscribers to Brevo?')) return;
        
        const button = event.target;
        if (button) {
          button.disabled = true;
          button.innerHTML = '🔄 Syncing...';
        }
        
        const response = await fetch(`${API_BASE}/sync-brevo`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadActivity();
          let message = `Sync completed: ${data.synced} successful`;
          if (data.errors > 0) {
            message += `, ${data.errors} errors`;
          }
          alert(message);
        } else {
          alert(data.error || 'Sync failed');
        }
      } catch (error) {
        console.error('Error syncing with Brevo:', error);
        alert('Network error. Please try again.');
      } finally {
        const button = event.target;
        if (button) {
          button.disabled = false;
          button.innerHTML = '🔄 Manual Brevo Sync';
        }
      }
    }

    // Send campaign
    async function sendCampaign() {
      try {
        const subject = document.getElementById('campaignSubject')?.value?.trim() || '';
        const body = document.getElementById('campaignBody')?.value?.trim() || '';
        const fromName = document.getElementById('fromName')?.value?.trim() || '';
        
        if (!subject || !body) {
          alert('Please fill in both subject and email content');
          return;
        }
        
        if (subscribers.length === 0) {
          alert('No subscribers to send campaign to');
          return;
        }
        
        if (!confirm(`Send campaign to ${subscribers.length} subscribers?`)) return;
        
        const button = event.target;
        if (button) {
          button.disabled = true;
          button.innerHTML = '📧 Sending...';
        }
        
        const response = await fetch(`${API_BASE}/send-campaign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject,
            body,
            fromName: fromName || 'SideQuest Mail',
            recipients: subscribers
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadActivity();
          alert(`Campaign sent successfully to ${data.sent} subscribers!`);
          // Clear form
          const subjectEl = document.getElementById('campaignSubject');
          const bodyEl = document.getElementById('campaignBody');
          if (subjectEl) subjectEl.value = '';
          if (bodyEl) bodyEl.value = '';
        } else {
          alert(data.error || 'Failed to send campaign');
        }
      } catch (error) {
        console.error('Error sending campaign:', error);
        alert('Network error. Please try again.');
      } finally {
        const button = event.target;
        if (button) {
          button.disabled = false;
          button.innerHTML = '📧 Send Campaign';
        }
      }
    }

    // Refresh subscribers
    async function refreshSubscribers() {
      try {
        await loadInitialData();
        
        // Refresh chart if on analytics tab
        const analyticsTab = document.querySelector('.tab[data-tab="analytics"]');
        if (analyticsTab && analyticsTab.classList.contains('active')) {
          setTimeout(() => {
            if (document.getElementById('growthChart') && subscriberDetails.length > 0) {
              initializeGrowthChart();
            }
          }, 200);
        }
        
        showSuccess('Data refreshed!');
      } catch (error) {
        console.error('Error refreshing data:', error);
      }
    }

    // Update dashboard stats
    function updateStats() {
      try {
        const elements = {
          totalSubscribers: document.getElementById('totalSubscribers'),
          todaySignups: document.getElementById('todaySignups'),
          thisWeekSignups: document.getElementById('thisWeekSignups'),
          webSignups: document.getElementById('webSignups'),
          manualSignups: document.getElementById('manualSignups'),
          importSignups: document.getElementById('importSignups')
        };

        if (elements.totalSubscribers) elements.totalSubscribers.textContent = currentStats.total || 0;
        if (elements.todaySignups) elements.todaySignups.textContent = currentStats.today || 0;
        if (elements.thisWeekSignups) elements.thisWeekSignups.textContent = currentStats.week || 0;
        
        // Update source breakdown
        const sources = currentStats.sources || {};
        if (elements.webSignups) elements.webSignups.textContent = sources.web || 0;
        if (elements.manualSignups) elements.manualSignups.textContent = sources.manual || 0;
        if (elements.importSignups) elements.importSignups.textContent = sources.import || 0;
      } catch (error) {
        console.error('Error updating stats:', error);
      }
    }

    // Update campaign recipient count
    function updateCampaignRecipientCount() {
      try {
        const element = document.getElementById('campaignRecipientCount');
        if (element) {
          element.textContent = subscribers.length;
        }
      } catch (error) {
        console.error('Error updating campaign recipient count:', error);
      }
    }

    // Search functionality
    function setupSearch() {
      try {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredSubscribers = subscribers.filter(email => 
              email.toLowerCase().includes(searchTerm)
            );
            renderSubscribers(filteredSubscribers);
          });
        }
      } catch (error) {
        console.error('Error setting up search:', error);
      }
    }

    // Export CSV
    function exportCSV() {
      try {
        if (subscribers.length === 0) {
          alert('No subscribers to export');
          return;
        }

        const csvContent = 'Email,Date Added,Source\n' + 
          subscriberDetails.map(details => 
            `${details.email},${details.date_added},${details.source}`
          ).join('\n');
          
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_subscribers_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess(`Exported ${subscribers.length} subscribers to CSV`);
      } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('Error exporting CSV. Please try again.');
      }
    }

    // Generate QR Code (placeholder - would need QR library)
    function generateQR() {
      try {
        const urlInput = document.getElementById('qrUrl');
        if (!urlInput) return;
        
        const url = urlInput.value;
        if (!url) {
          alert('Please enter a URL');
          return;
        }

        const qrDisplay = document.getElementById('qrDisplay');
        if (qrDisplay) {
          qrDisplay.style.display = 'block';
          qrDisplay.innerHTML = `
            <div style="width: 200px; height: 200px; background: #1a1a1a; border: 2px dashed #FFD700; display: flex; align-items: center; justify-content: center; margin: 0 auto; border-radius: 12px; color: #FFD700;">
              📱 QR Code<br>
              <small>Would generate for:<br>${url}</small>
            </div>
            <p style="margin-top: 15px; font-size: 12px; color: #aaaaaa;">
              QR code library integration needed
            </p>
          `;
        }
      } catch (error) {
        console.error('Error generating QR code:', error);
      }
    }

    // Data management
    function backupData() {
      try {
        const backup = {
          subscribers: subscriberDetails,
          timestamp: new Date().toISOString(),
          count: subscribers.length,
          stats: currentStats
        };
        
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('Data backup created');
      } catch (error) {
        console.error('Error backing up data:', error);
        alert('Error creating backup. Please try again.');
      }
    }

    async function clearAllData() {
      try {
        if (!confirm('⚠️ This will delete ALL subscribers permanently. Are you sure?')) return;
        
        const confirmation = prompt('Type "DELETE" to confirm this action:');
        if (confirmation !== 'DELETE') return;
        
        const response = await fetch(`${API_BASE}/clear-data`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ confirmation: 'DELETE' })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          await loadInitialData();
          alert(data.message);
        } else {
          alert(data.error || 'Failed to clear data');
        }
      } catch (error) {
        console.error('Error clearing data:', error);
        alert('Network error. Please try again.');
      }
    }

    // Render activity log
    function renderActivityLog() {
      try {
        const activityLogElement = document.getElementById('activityLog');
        if (!activityLogElement) return;
        
        if (activityLog.length === 0) {
          activityLogElement.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
          return;
        }

        const recentActivities = activityLog.slice(0, 10);
        activityLogElement.innerHTML = recentActivities.map(activity => {
          const time = new Date(activity.timestamp).toLocaleTimeString();
          const iconClass = activity.type === 'success' ? 'success' : 
                           activity.type === 'danger' ? 'danger' : 'info';
          const icon = activity.type === 'success' ? '✅' : 
                      activity.type === 'danger' ? '❌' : 'ℹ️';
          
          return `
            <div class="activity-item">
              <div class="activity-icon ${iconClass}">${icon}</div>
              <div class="activity-content">
                <div class="activity-text">${activity.message}</div>
                <div class="activity-time">${time}</div>
              </div>
            </div>
          `;
        }).join('');

        // Update last activity in system status
        if (recentActivities.length > 0) {
          const lastTime = new Date(recentActivities[0].timestamp).toLocaleTimeString();
          const lastActivityElement = document.getElementById('lastActivity');
          if (lastActivityElement) {
            lastActivityElement.textContent = lastTime;
          }
        }
      } catch (error) {
        console.error('Error rendering activity log:', error);
      }
    }

    // Auto refresh functionality
    function startAutoRefresh() {
      try {
        // Refresh data every 30 seconds
        setInterval(async () => {
          try {
            // Remove the old loadStats() call and replace with:
            await loadActivity();
            
            // Only refresh analytics if we're currently on the analytics tab
            const analyticsTab = document.querySelector('.tab[data-tab="analytics"]');
            if (analyticsTab && analyticsTab.classList.contains('active')) {
              await loadAnalyticsData();
            }
          } catch (error) {
            console.error('Auto refresh error:', error);
          }
        }, 30000);
      } catch (error) {
        console.error('Error starting auto refresh:', error);
      }
    }

    

    // Utility functions
    function isValidEmail(email) {
      const pattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return pattern.test(email);
    }

    function showLoading(elementId) {
      try {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #aaaaaa;">
              <div class="spinner"></div>
              <p style="margin-top: 15px;">Loading...</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error showing loading:', error);
      }
    }

    // Add this function to your JavaScript (around line 2500)
    function toggleChartView(viewType) {
      if (currentChartView === viewType) return;
      
      currentChartView = viewType;
      
      // Update button states
      document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const targetButton = document.querySelector(`[data-chart="${viewType}"]`);
      if (targetButton) {
        targetButton.classList.add('active');
      }
      
      // Reload the chart with new data
      loadAnalyticsData();
    }

    let subscriberGrowthChart = null;
    let registrationTrendChart = null;

    let currentChartView = 'subscribers';
    // Analytics Functions - ADD TO YOUR EXISTING JAVASCRIPT

    // Load analytics data
    async function loadAnalyticsData() {
      try {
        const timeRange = document.getElementById('analyticsTimeRange')?.value || 30;
        
        showAnalyticsLoading();
        
        const response = await fetch(`${API_BASE}/api/analytics/kpis?days=${timeRange}`);
        const data = await response.json();
        
        if (data.success) {
          updateAnalyticsKPIs(data.kpis);
          updateAnalyticsCharts(data.trends);
          updateEventTypesPerformance(data.trends.event_types);
          
         console.log('Analytics data loaded successfully');
        } else {
          showAnalyticsError('Failed to load analytics data: ' + (data.error || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Error loading analytics:', error);
        showAnalyticsError('Network error loading analytics data');
      }
    }

    // Update KPI cards
    function updateAnalyticsKPIs(kpis) {
      try {
        // Subscriber KPIs
        const subscriberKPIs = kpis.subscribers || {};
        document.getElementById('analyticsSubscribers').textContent = subscriberKPIs.total || 0;
        document.getElementById('newSubscribers').textContent = subscriberKPIs.new_this_period || 0;
        document.getElementById('weeklyGrowth').textContent = subscriberKPIs.weekly_growth || 0;
        
        // Update status banner
        document.getElementById('quickSubscriberCount').textContent = subscriberKPIs.total || 0;
        
        // Update growth trend
        const growthRate = subscriberKPIs.growth_rate || 0;
        const trendElement = document.getElementById('subscriberTrend');
        if (trendElement) {
          trendElement.textContent = (growthRate >= 0 ? '+' : '') + growthRate + '%';
          trendElement.className = growthRate >= 0 ? 'kpi-trend' : 'kpi-trend negative';
        }
        
        // Event KPIs
        const eventKPIs = kpis.events || {};
        document.getElementById('totalEvents').textContent = eventKPIs.total || 0;
        document.getElementById('totalRegistrations').textContent = eventKPIs.total_registrations || 0;
        document.getElementById('capacityUtil').textContent = (eventKPIs.avg_capacity_utilization || 0) + '%';
        
        // Update status banner
        document.getElementById('quickEventCount').textContent = eventKPIs.total || 0;
        
        const upcomingBadge = document.getElementById('upcomingEventsBadge');
        if (upcomingBadge) {
          upcomingBadge.textContent = (eventKPIs.upcoming || 0) + ' upcoming';
        }
        
        // Revenue KPIs
        const revenueKPIs = kpis.revenue || {};
        document.getElementById('totalRevenue').textContent = '£' + (revenueKPIs.total || 0).toFixed(2);
        document.getElementById('avgRevenuePerEvent').textContent = '£' + (revenueKPIs.avg_per_event || 0).toFixed(2);
        
        // Update status banner
        document.getElementById('quickRevenue').textContent = '£' + (revenueKPIs.total || 0).toFixed(0);
        
        const paidEventsBadge = document.getElementById('paidEventsBadge');
        if (paidEventsBadge) {
          paidEventsBadge.textContent = (revenueKPIs.paid_events || 0) + ' paid events';
        }
        
        // Engagement KPIs
        const engagementKPIs = kpis.engagement || {};
        document.getElementById('engagementRate').textContent = (engagementKPIs.engagement_rate || 0) + '%';
        document.getElementById('engagedSubscribers').textContent = engagementKPIs.engaged_subscribers || 0;
        
        // Calculate average registrations per event
        const avgRegsPerEvent = eventKPIs.total > 0 ? Math.round((eventKPIs.total_registrations || 0) / eventKPIs.total) : 0;
        document.getElementById('avgRegistrationsPerEvent').textContent = avgRegsPerEvent;
        
        const attendanceTrend = document.getElementById('attendanceTrend');
        if (attendanceTrend) {
          attendanceTrend.textContent = (engagementKPIs.attendance_rate || 0) + '%';
        }
        
        // Update business health score
        updateBusinessHealthScore(kpis);
        
        // Update insights
        updateInsights(kpis);
        
        // Update performance summary
        updatePerformanceSummary(kpis);
        
      } catch (error) {
        console.error('Error updating KPIs:', error);
      }
    }

    // Business health score calculation
    function updateBusinessHealthScore(kpis) {
      try {
        const subscriber = kpis.subscribers || {};
        const events = kpis.events || {};
        const engagement = kpis.engagement || {};
        
        let score = 0;
        let status = 'Good';
        let color = '#FFD700';
        
        // Score factors
        if (subscriber.growth_rate > 20) score += 25;
        else if (subscriber.growth_rate > 0) score += 15;
        else score += 5;
        
        if (engagement.engagement_rate > 50) score += 25;      // Excellent
        else if (engagement.engagement_rate > 30) score += 20; // Good  
        else if (engagement.engagement_rate > 15) score += 10; // Fair
        else score += 5; 
        
        if (events.avg_capacity_utilization > 70) score += 25;
        else if (events.avg_capacity_utilization > 40) score += 15;
        else score += 5;
        
        if (events.upcoming > 0) score += 25;
        else score += 10;
        
        // Determine status
        if (score >= 80) {
          status = 'Excellent';
          color = '#00ff88';
        } else if (score >= 60) {
          status = 'Good';
          color = '#FFD700';
        } else if (score >= 40) {
          status = 'Fair';
          color = '#FFA500';
        } else {
          status = 'Needs Attention';
          color = '#ff6b35';
        }
        
        const healthElement = document.getElementById('businessHealthScore');
        if (healthElement) {
          healthElement.textContent = status;
          healthElement.style.color = color;
        }
        
      } catch (error) {
        console.error('Error updating business health score:', error);
      }
    }

    

    function updateAnalyticsCharts(trends) {
      try {
        updateMainGrowthChart(trends); // ← New function name
        // Remove the old function calls:
        // updateSubscriberGrowthChart(trends.subscriber_growth || []);
        // updateRegistrationTrendChart(trends.registration_trend || []);
      } catch (error) {
        console.error('Error updating charts:', error);
      }
    }

    // Export analytics report
    async function exportAnalyticsReport() {
      try {
        const timeRange = document.getElementById('analyticsTimeRange')?.value || 30;
        showSuccess('📊 Generating analytics report...');
        
        // Get current analytics data
        const response = await fetch(`${API_BASE}/api/analytics/kpis?days=${timeRange}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to fetch analytics data');
        }
        
        // Create CSV content
        const timestamp = new Date().toISOString().split('T')[0];
        let csvContent = `SideQuest Analytics Report - ${timestamp}\n\n`;
        
        csvContent += `SUBSCRIBER METRICS (Last ${timeRange} days)\n`;
        csvContent += `Total Subscribers,${data.kpis.subscribers.total}\n`;
        csvContent += `New Subscribers,${data.kpis.subscribers.new_this_period}\n`;
        csvContent += `Weekly Growth,${data.kpis.subscribers.weekly_growth}\n`;
        csvContent += `Growth Rate,${data.kpis.subscribers.growth_rate}%\n\n`;
        
        csvContent += `EVENT METRICS\n`;
        csvContent += `Total Events,${data.kpis.events.total}\n`;
        csvContent += `Upcoming Events,${data.kpis.events.upcoming}\n`;
        csvContent += `Total Registrations,${data.kpis.events.total_registrations}\n`;
        csvContent += `Avg Capacity Utilization,${data.kpis.events.avg_capacity_utilization}%\n\n`;
        
        csvContent += `REVENUE METRICS\n`;
        csvContent += `Total Revenue,£${data.kpis.revenue.total}\n`;
        csvContent += `Paid Events,${data.kpis.revenue.paid_events}\n`;
        csvContent += `Avg Revenue per Event,£${data.kpis.revenue.avg_per_event}\n\n`;
        
        csvContent += `ENGAGEMENT METRICS\n`;
        csvContent += `Engagement Rate,${data.kpis.engagement.engagement_rate}%\n`;
        csvContent += `Active Subscribers,${data.kpis.engagement.engaged_subscribers}\n`;
        csvContent += `Attendance Rate,${data.kpis.engagement.attendance_rate}%\n`;
        
        // Download the report
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sidequest_analytics_${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('📊 Analytics report downloaded!');
        
      } catch (error) {
        console.error('Error exporting analytics report:', error);
        alert('Failed to export analytics report: ' + error.message);
      }
    }

    // Event mix optimization suggestions
    function optimizeEventMix() {
      const suggestions = [
        "🎯 Your tournaments have high engagement - consider adding more competitive events",
        "🎮 Game nights are popular - try themed nights (retro, indie, etc.)",
        "💡 Consider adding beginner-friendly events to attract new participants", 
        "🏆 Premium tournaments could increase revenue while maintaining engagement",
        "📅 Weekly recurring events could boost regular attendance"
      ];
      
      const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
      alert("💡 Recommendation:\n\n" + randomSuggestion);
    }

    // Insight action execution
    function executeInsightAction(action) {
      const actions = {
        'Plan more events': () => {
          document.querySelector('.tab[data-tab="events"]').click();
          setTimeout(() => switchEventView('create'), 500);
        },
        'Launch growth campaign': () => {
          document.querySelector('.tab[data-tab="campaigns"]').click();
        },
        'Boost engagement': () => {
          alert('💡 Try these engagement boosters:\n\n• Send personalized event invitations\n• Create member-exclusive events\n• Add loyalty rewards\n• Host community challenges');
        },
        'Create paid events': () => {
          document.querySelector('.tab[data-tab="events"]').click();
          setTimeout(() => {
            switchEventView('create');
            setTimeout(() => {
              const feeInput = document.getElementById('eventFee');
              if (feeInput) {
                feeInput.focus();
                feeInput.value = '10.00';
              }
            }, 1000);
          }, 500);
        },
        'Scale successful events': () => {
          alert('💰 Revenue optimization ideas:\n\n• Increase capacity for popular events\n• Create tiered pricing (VIP, Standard)\n• Add merchandise sales\n• Offer event packages');
        },
        'Expand capacity': () => {
          alert('📈 Capacity expansion options:\n\n• Book larger venues\n• Add multiple sessions\n• Create waiting lists\n• Live stream popular events');
        },
        'Maintain momentum': () => {
          alert('🚀 Keep the momentum:\n\n• Regular communication with community\n• Consistent event schedule\n• Member feedback surveys\n• Referral incentives');
        }
      };
      
      if (actions[action]) {
        actions[action]();
      } else {
        alert('💡 Action: ' + action);
      }
    }


    // Generate AI insights
    function updateInsights(kpis) {
      try {
        const insights = [];
        const subscriber = kpis.subscribers || {};
        const events = kpis.events || {};
        const engagement = kpis.engagement || {};
        const revenue = kpis.revenue || {};
        
        // Growth insights
        if (subscriber.growth_rate > 50) {
          insights.push({
            type: 'success',
            icon: '🚀',
            title: 'Explosive Growth!',
            description: `Your subscriber base is growing ${subscriber.growth_rate}% faster than the previous period. Consider scaling your event capacity.`,
            action: 'Plan more events'
          });
        } else if (subscriber.growth_rate < 0) {
          insights.push({
            type: 'warning',
            icon: '⚠️',
            title: 'Growth Slowdown',
            description: 'Subscriber growth has declined. Consider running a promotional campaign or special event.',
            action: 'Launch growth campaign'
          });
        }
        
        // Engagement insights
        if (engagement.engagement_rate > 60) {  // 60%+ is truly high
          insights.push({
            type: 'success',
            icon: '🎯',
            title: 'Excellent Engagement',
            description: `${engagement.engagement_rate}% of subscribers actively participate in events. Outstanding community engagement!`,
            action: 'Maintain momentum'
          });
        } else if (engagement.engagement_rate > 35) {  // 35-60% is good
          insights.push({
            type: 'success',
            icon: '👍',
            title: 'Good Engagement',
            description: `${engagement.engagement_rate}% participation rate shows solid community engagement.`,
            action: 'Scale successful events'
          });
        } else if (engagement.engagement_rate > 20) {  // 20-35% is average
          insights.push({
            type: 'opportunity',
            icon: '📈',
            title: 'Room for Growth',
            description: `${engagement.engagement_rate}% participation rate has potential for improvement. Consider more diverse events.`,
            action: 'Boost engagement'
          });
        } else {  // Under 20% needs attention
          insights.push({
            type: 'warning',
            icon: '⚠️',
            title: 'Low Engagement',
            description: `Only ${engagement.engagement_rate}% of subscribers are participating in events. Consider survey feedback or promotional campaigns.`,
            action: 'Launch engagement campaign'
          });
        }
        
        // Revenue insights
        if (revenue.paid_events === 0) {
          insights.push({
            type: 'opportunity',
            icon: '💰',
            title: 'Revenue Opportunity',
            description: 'All events are currently free. Consider introducing premium events or workshops to generate revenue.',
            action: 'Create paid events'
          });
        } else if (revenue.avg_per_event > 15) {
          insights.push({
            type: 'success',
            icon: '💎',
            title: 'Strong Revenue per Event',
            description: `Averaging £${revenue.avg_per_event.toFixed(2)} per event shows healthy monetization.`,
            action: 'Scale successful events'
          });
        }
        
        // Capacity insights
        if (events.avg_capacity_utilization > 90) {
          insights.push({
            type: 'warning',
            icon: '📈',
            title: 'High Demand',
            description: 'Events are consistently at capacity. Consider increasing venue size or adding more sessions.',
            action: 'Expand capacity'
          });
        }
        
        renderInsights(insights);
        
      } catch (error) {
        console.error('Error updating insights:', error);
      }
    }

    // Render insights
    function renderInsights(insights) {
      const container = document.getElementById('aiInsights');
      if (!container) return;
      
      if (insights.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No insights available yet. Check back as your data grows!</p>';
        return;
      }
      
      container.innerHTML = insights.map(insight => `
        <div class="insight-card ${insight.type}" onclick="executeInsightAction('${insight.action}')">
          <div class="insight-header">
            <span class="insight-icon">${insight.icon}</span>
            <span class="insight-title">${insight.title}</span>
          </div>
          <div class="insight-description">${insight.description}</div>
          <div class="insight-action">${insight.action} →</div>
        </div>
      `).join('');
    }

    // Performance summary
    function updatePerformanceSummary(kpis) {
      try {
        const container = document.getElementById('performanceSummary');
        if (!container) return;
        
        const subscriber = kpis.subscribers || {};
        const events = kpis.events || {};
        const engagement = kpis.engagement || {};
        const revenue = kpis.revenue || {};
        
        const metrics = [
          {
            label: 'Growth Rate',
            value: `${subscriber.growth_rate || 0}%`,
            trend: subscriber.growth_rate > 0 ? 'up' : subscriber.growth_rate < 0 ? 'down' : 'neutral',
            icon: subscriber.growth_rate > 0 ? '↗️' : subscriber.growth_rate < 0 ? '↘️' : '➡️'
          },
          {
            label: 'Event Participation',
            value: `${engagement.engagement_rate || 0}%`,
            trend: engagement.engagement_rate > 25 ? 'up' : engagement.engagement_rate < 15 ? 'down' : 'neutral',
            icon: engagement.engagement_rate > 25 ? '🎯' : '👥'
          },
          {
            label: 'Avg Capacity',
            value: `${events.avg_capacity_utilization || 0}%`,
            trend: events.avg_capacity_utilization > 70 ? 'up' : events.avg_capacity_utilization < 40 ? 'down' : 'neutral',
            icon: events.avg_capacity_utilization > 70 ? '🔥' : '📊'
          },
          {
            label: 'Revenue/Event',
            value: `£${(revenue.avg_per_event || 0).toFixed(2)}`,
            trend: revenue.avg_per_event > 10 ? 'up' : revenue.avg_per_event < 5 ? 'down' : 'neutral',
            icon: '💰'
          }
        ];
        
        container.innerHTML = metrics.map(metric => `
          <div class="performance-metric">
            <span class="metric-label">${metric.icon} ${metric.label}</span>
            <div>
              <span class="metric-value">${metric.value}</span>
              <span class="metric-trend trend-${metric.trend}"></span>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error updating performance summary:', error);
      }
    }

    // Enhanced main chart (replaces both subscriber growth and registration trend)
    function updateMainGrowthChart(trends) {
      try {
        const ctx = document.getElementById('mainGrowthChart');
        if (!ctx) return;
        
        if (subscriberGrowthChart) {
          subscriberGrowthChart.destroy();
        }
        
        let data, chartConfig;
        
        if (currentChartView === 'subscribers') {
          const subscriberData = trends.subscriber_growth || [];
          
          const labels = subscriberData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
          });
          
          const newSubscribers = subscriberData.map(item => item.new_subscribers || 0);
          const cumulativeSubscribers = subscriberData.map(item => item.cumulative_subscribers || 0);
          
          chartConfig = {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'New Subscribers',
                  data: newSubscribers,
                  borderColor: '#FFD700',
                  backgroundColor: 'rgba(255, 215, 0, 0.1)',
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: '#FFD700',
                  pointBorderColor: '#1a1a1a',
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  yAxisID: 'y'
                },
                {
                  label: 'Total Subscribers',
                  data: cumulativeSubscribers,
                  borderColor: '#4ECDC4',
                  backgroundColor: 'rgba(78, 205, 196, 0.1)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4,
                  pointBackgroundColor: '#4ECDC4',
                  pointBorderColor: '#1a1a1a',
                  pointBorderWidth: 2,
                  pointRadius: 5,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    color: '#FFD700',
                    font: { weight: 'bold' },
                    usePointStyle: true
                  }
                },
                tooltip: {
                  backgroundColor: '#2a2a2a',
                  titleColor: '#FFD700',
                  bodyColor: '#ffffff',
                  borderColor: '#FFD700',
                  borderWidth: 1
                }
              },
              scales: {
                x: {
                  grid: { color: '#444' },
                  ticks: { color: '#cccccc', maxRotation: 45 }
                },
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  beginAtZero: true,
                  grid: { color: '#444' },
                  ticks: { color: '#cccccc' },
                  title: {
                    display: true,
                    text: 'New Subscribers',
                    color: '#FFD700'
                  }
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  beginAtZero: true,
                  grid: { drawOnChartArea: false },
                  ticks: { color: '#4ECDC4' },
                  title: {
                    display: true,
                    text: 'Total Subscribers',
                    color: '#4ECDC4'
                  }
                }
              }
            }
          };
        } else {
          // Registrations view
          const registrationData = trends.registration_trend || [];
          
          const labels = registrationData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
          });
          
          const registrations = registrationData.map(item => item.registrations || 0);
          
          chartConfig = {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Event Registrations',
                data: registrations,
                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                borderColor: '#8B5CF6',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    color: '#8B5CF6',
                    font: { weight: 'bold' },
                    usePointStyle: true
                  }
                },
                tooltip: {
                  backgroundColor: '#2a2a2a',
                  titleColor: '#8B5CF6',
                  bodyColor: '#ffffff',
                  borderColor: '#8B5CF6',
                  borderWidth: 1
                }
              },
              scales: {
                x: {
                  grid: { color: '#444' },
                  ticks: { color: '#cccccc', maxRotation: 45 }
                },
                y: {
                  beginAtZero: true,
                  grid: { color: '#444' },
                  ticks: { color: '#cccccc' },
                  title: {
                    display: true,
                    text: 'Registrations',
                    color: '#8B5CF6'
                  }
                }
              }
            }
          };
        }
        
        subscriberGrowthChart = new Chart(ctx, chartConfig);
        
      } catch (error) {
        console.error('Error updating main growth chart:', error);
      }
    }

    // Update event types performance
    function updateEventTypesPerformance(eventTypes) {
      try {
        const container = document.getElementById('eventTypesPerformance');
        if (!container) return;
        
        if (!eventTypes || eventTypes.length === 0) {
          container.innerHTML = '<p class="text-muted text-center">No event data available</p>';
          return;
        }
        
        container.innerHTML = eventTypes.map(eventType => {
          const typeClass = eventType.event_type.toLowerCase().replace(/\s+/g, '_');
          const capacityUtil = Math.round(eventType.avg_capacity_util || 0);
          
          return `
            <div class="event-type-card ${typeClass}">
              <div class="event-type-header">
                <span class="event-type-title">${eventType.event_type.replace('_', ' ')}</span>
                <span class="event-type-count">${eventType.event_count}</span>
              </div>
              <div class="event-type-stats">
                <div class="event-type-stat">
                  <span class="event-type-stat-value">${eventType.total_registrations || 0}</span>
                  <span class="event-type-stat-label">Registrations</span>
                </div>
                <div class="event-type-stat">
                  <span class="event-type-stat-value">${capacityUtil}%</span>
                  <span class="event-type-stat-label">Avg Capacity</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error updating event types performance:', error);
      }
    }

    // Show loading state
    function showAnalyticsLoading() {
      // Update KPI cards to show loading
      const kpiValues = document.querySelectorAll('.kpi-value, .kpi-detail-value');
      kpiValues.forEach(element => {
        element.textContent = '-';
      });
      
      // Show loading for charts
      const chartContainers = document.querySelectorAll('.chart-container canvas');
      chartContainers.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
      
      // Show loading for event types
      const eventTypesContainer = document.getElementById('eventTypesPerformance');
      if (eventTypesContainer) {
        eventTypesContainer.innerHTML = `
          <div class="loading-placeholder">
            <div class="spinner"></div>
            <p>Loading performance data...</p>
          </div>
        `;
      }
    }

    // Show error state
    function showAnalyticsError(message) {
      console.error('Analytics error:', message);
      
      const eventTypesContainer = document.getElementById('eventTypesPerformance');
      if (eventTypesContainer) {
        eventTypesContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ff6b35;">
            <p>❌ ${message}</p>
            <button class="btn btn-primary btn-sm" onclick="loadAnalyticsData()">
              🔄 Retry
            </button>
          </div>
        `;
      }
    }

    // Refresh analytics
    async function refreshAnalytics() {
      await loadAnalyticsData();
      showSuccess('Analytics data refreshed!');
    }

    // Initialize analytics when tab is clicked
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener for analytics time range change
      const timeRangeSelect = document.getElementById('analyticsTimeRange');
      if (timeRangeSelect) {
        timeRangeSelect.addEventListener('change', loadAnalyticsData);
      }
      
      // Load analytics when analytics tab is clicked
      const analyticsTab = document.querySelector('.tab[data-tab="analytics"]');
      if (analyticsTab) {
        analyticsTab.addEventListener('click', function() {
          // Small delay to ensure tab content is visible
          setTimeout(loadAnalyticsData, 200);
        });
      }
    });

    // Also update the existing tab switching to load analytics
    function initializeTabs() {
      try {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
              targetContent.classList.add('active');
            }
            
            // Load appropriate data based on tab
            if (targetTab === 'campaigns') {
              updateCampaignRecipientCount();
            } else if (targetTab === 'analytics') {
              // 🆕 NEW: Load analytics data when switching to analytics tab
              setTimeout(loadAnalyticsData, 200);
            } else if (targetTab === 'events') {
              // Load events when switching to events tab
              setTimeout(loadEvents, 100);
            }
            
            // 🆕 NEW: Also refresh the old growth chart if it exists (backward compatibility)
            if (targetTab === 'analytics' && document.getElementById('growthChart')) {
              setTimeout(() => {
                if (subscriberDetails.length > 0) {
                  initializeGrowthChart();
                }
              }, 100);
            }
          });
        });
      } catch (error) {
        console.error('Error initializing tabs:', error);
      }
    }

    function showError(elementId, message) {
      try {
        const element = document.getElementById(elementId);
        if (element) {
          element.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #ff6b35;">
              ❌ ${message}
            </div>
          `;
        }
      } catch (error) {
        console.error('Error showing error:', error);
      }
    }  

    function showSuccess(message) {
      try {
        // Success notification with SideQuest styling
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
          color: #1a1a1a;
          padding: 18px 25px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
          z-index: 1000;
          animation: slideIn 0.3s ease;
          font-weight: 600;
          border: 2px solid #FFD700;
        `;
        notification.textContent = `✅ ${message}`;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 3000);
      } catch (error) {
        console.error('Error showing success notification:', error);
      }
    }

    // Handle Enter key in email input
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const emailInput = document.getElementById('newSubscriberEmail');
        if (emailInput) {
          emailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              addSubscriber();
            }
          });
        }
      } catch (error) {
        console.error('Error setting up enter key handler:', error);
      }
    });


    
  </script>
</body>

</html>
